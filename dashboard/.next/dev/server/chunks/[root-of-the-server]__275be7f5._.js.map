{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/app/api/history/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\n\nconst KAMINO_API_BASE = 'https://api.kamino.finance';\nconst KAMINO_MARKET_ID = '7u3HeHxYDLhnCoErrtycNokbQYbWGzLs6JSDqGAv5PfF';\nconst KAMINO_RESERVE_ID = 'd4A2prbA2whesmvHaL88BH6Ewn5N4bTSU2Ze8P6Bc4Q';\n\nlet cachedHistory: any[] = [];\nlet cachedHistoryFetchedAt = 0;\n\nasync function fetchKaminoHistory() {\n  const now = Date.now();\n\n  // Return cache if less than 1 minute old\n  if (cachedHistory.length && now - cachedHistoryFetchedAt < 60_000) {\n    return cachedHistory;\n  }\n\n  try {\n    const endDate = new Date();\n    const startDate = new Date(endDate.getTime() - 21 * 24 * 60 * 60 * 1000); // 21 days ago\n\n    const params = new URLSearchParams({\n      env: 'mainnet-beta',\n      start: startDate.toISOString().split('.')[0] + 'Z',\n      end: endDate.toISOString().split('.')[0] + 'Z',\n      frequency: 'hour',\n    });\n\n    const url = `${KAMINO_API_BASE}/kamino-market/${KAMINO_MARKET_ID}/reserves/${KAMINO_RESERVE_ID}/metrics/history?${params}`;\n    const response = await fetch(url, { headers: { accept: 'application/json' } });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}`);\n    }\n\n    const payload = await response.json();\n    const rows = Array.isArray(payload?.history) ? payload.history : [];\n\n    const points = rows\n      .map((entry: any) => {\n        const timestampMs = Date.parse(entry.timestamp);\n        if (!Number.isFinite(timestampMs)) return null;\n\n        const metrics = entry.metrics || {};\n        const supplyApr = (metrics.supplyInterestAPY || 0) * 100;\n        const borrowApr = (metrics.borrowInterestAPY || 0) * 100;\n\n        let utilizationPct = 0;\n        if (metrics.totalBorrows && metrics.totalSupply) {\n          const borrows = Number(metrics.totalBorrows);\n          const supply = Number(metrics.totalSupply);\n          if (supply > 0) {\n            utilizationPct = (borrows / supply) * 100;\n          }\n        }\n\n        return {\n          timestampMs,\n          supplyApr,\n          borrowApr,\n          utilizationPct,\n        };\n      })\n      .filter((point: any) => point !== null);\n\n    if (points.length) {\n      cachedHistory = points.sort((a: any, b: any) => a.timestampMs - b.timestampMs);\n      cachedHistoryFetchedAt = now;\n    }\n\n    return cachedHistory;\n  } catch (error) {\n    console.error('Failed to fetch Kamino history:', error);\n    return [];\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const field = searchParams.get('field') || 'supplyApr';\n    const limit = searchParams.get('limit') ? Number(searchParams.get('limit')) : undefined;\n\n    const history = await fetchKaminoHistory();\n    let filtered = history;\n\n    if (limit && filtered.length > limit) {\n      filtered = filtered.slice(-limit);\n    }\n\n    // Convert to chart bars\n    const bars = filtered.map((point: any) => {\n      const value = (point as any)[field] || 0;\n      const time = point.timestampMs;\n\n      return {\n        time,\n        open: value,\n        high: value,\n        low: value,\n        close: value,\n        volume: point.borrowApr || 0,\n      };\n    });\n\n    return NextResponse.json({\n      field,\n      bars,\n      points: filtered,\n    });\n  } catch (error) {\n    console.error('API error:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch history' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}