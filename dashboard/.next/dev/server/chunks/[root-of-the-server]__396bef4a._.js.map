{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/app/api/merged/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport {\n  DriftClient,\n  PerpMarkets,\n  PRICE_PRECISION,\n  FUNDING_RATE_PRECISION,\n  BASE_PRECISION,\n  Wallet,\n} from '@drift-labs/sdk';\nimport { Connection, Keypair } from '@solana/web3.js';\n\nconst DRIFT_ENV = 'mainnet-beta';\nconst DRIFT_MARKET = 'SOL-PERP';\nconst RPC_URL = process.env.RPC_URL || 'https://api.mainnet-beta.solana.com';\nconst KAMINO_API_BASE = 'https://api.kamino.finance';\nconst KAMINO_MARKET_ID = '7u3HeHxYDLhnCoErrtycNokbQYbWGzLs6JSDqGAv5PfF';\nconst KAMINO_RESERVE_ID = 'd4A2prbA2whesmvHaL88BH6Ewn5N4bTSU2Ze8P6Bc4Q';\n\nconst PRICE_PRECISION_NUM = PRICE_PRECISION.toNumber();\nconst FUNDING_RATE_PRECISION_NUM = FUNDING_RATE_PRECISION.toNumber();\nconst BASE_PRECISION_NUM = BASE_PRECISION.toNumber();\n\nlet driftClient: DriftClient | null = null;\nlet driftMarketIndex: number;\n\nasync function getDriftClient() {\n  if (driftClient) return driftClient;\n\n  const marketConfig = PerpMarkets[DRIFT_ENV].find(\n    (market) => market.symbol === DRIFT_MARKET\n  );\n  if (!marketConfig) {\n    throw new Error(`Market ${DRIFT_MARKET} not found`);\n  }\n  driftMarketIndex = marketConfig.marketIndex;\n\n  const connection = new Connection(RPC_URL, 'confirmed');\n  const keypair = Keypair.generate();\n  const wallet = new Wallet(keypair);\n\n  driftClient = new DriftClient({\n    connection,\n    wallet,\n    authority: wallet.publicKey,\n    env: DRIFT_ENV as any,\n    perpMarketIndexes: [driftMarketIndex],\n    spotMarketIndexes: [0],\n    accountSubscription: {\n      type: 'websocket',\n    },\n  });\n\n  await driftClient.subscribe();\n  return driftClient;\n}\n\nasync function fetchDriftData() {\n  try {\n    const client = await getDriftClient();\n    await client.fetchAccounts();\n    const marketAccount = client.getPerpMarketAccount(driftMarketIndex);\n    if (!marketAccount) {\n      return { symbol: DRIFT_MARKET, markPrice: 0, fundingRatePct: 0, openInterest: 0 };\n    }\n\n    const oracleData = client.getOracleDataForPerpMarket(driftMarketIndex);\n    const markPrice = oracleData\n      ? oracleData.price.toNumber() / PRICE_PRECISION_NUM\n      : 0;\n\n    const fundingRateRaw = marketAccount.amm.lastFundingRate;\n    const fundingRatePct = fundingRateRaw\n      ? (fundingRateRaw.toNumber() / FUNDING_RATE_PRECISION_NUM) * 100\n      : 0;\n\n    const baseAssetWithAmm = marketAccount.amm.baseAssetAmountWithAmm;\n    const openInterest = baseAssetWithAmm\n      ? Math.abs(baseAssetWithAmm.toNumber()) / BASE_PRECISION_NUM\n      : 0;\n\n    return {\n      symbol: DRIFT_MARKET,\n      markPrice,\n      fundingRatePct,\n      openInterest,\n    };\n  } catch (error) {\n    console.error('Failed to fetch Drift data:', error);\n    return { symbol: DRIFT_MARKET, markPrice: 0, fundingRatePct: 0, openInterest: 0 };\n  }\n}\n\nasync function fetchKaminoData() {\n  try {\n    const now = new Date();\n    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n    const start = oneDayAgo.toISOString().split('.')[0] + 'Z';\n    const end = now.toISOString().split('.')[0] + 'Z';\n\n    const params = new URLSearchParams({\n      env: 'mainnet-beta',\n      start,\n      end,\n      frequency: 'hour',\n    });\n\n    const url = `${KAMINO_API_BASE}/kamino-market/${KAMINO_MARKET_ID}/reserves/${KAMINO_RESERVE_ID}/metrics/history?${params}`;\n    const response = await fetch(url, { headers: { accept: 'application/json' } });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}`);\n    }\n\n    const payload = await response.json();\n    const history = Array.isArray(payload?.history) ? payload.history : [];\n\n    if (history.length === 0) {\n      return { symbol: KAMINO_RESERVE_ID, supplyApr: 0, borrowApr: 0, utilizationPct: 0 };\n    }\n\n    const latest = history[history.length - 1];\n    const metrics = latest.metrics || {};\n\n    const supplyApr = (metrics.supplyInterestAPY || 0) * 100;\n    const borrowApr = (metrics.borrowInterestAPY || 0) * 100;\n\n    let utilizationPct = 0;\n    if (metrics.totalBorrows && metrics.totalSupply) {\n      const borrows = Number(metrics.totalBorrows);\n      const supply = Number(metrics.totalSupply);\n      if (supply > 0) {\n        utilizationPct = (borrows / supply) * 100;\n      }\n    }\n\n    return {\n      symbol: KAMINO_RESERVE_ID,\n      supplyApr,\n      borrowApr,\n      utilizationPct,\n    };\n  } catch (error) {\n    console.error('Failed to fetch Kamino data:', error);\n    return { symbol: KAMINO_RESERVE_ID, supplyApr: 0, borrowApr: 0, utilizationPct: 0 };\n  }\n}\n\nexport async function GET() {\n  try {\n    const [driftData, kaminoData] = await Promise.all([\n      fetchDriftData(),\n      fetchKaminoData(),\n    ]);\n\n    const mergedData = {\n      marketSymbol: driftData.symbol,\n      tradingViewSymbol: 'BINANCE:SOLUSDT',\n      markPrice: driftData.markPrice,\n      fundingRatePct: driftData.fundingRatePct,\n      openInterest: driftData.openInterest,\n      kaminoSupplyApr: kaminoData.supplyApr,\n      kaminoBorrowApr: kaminoData.borrowApr,\n      kaminoUtilization: kaminoData.utilizationPct,\n      combinedCarryApr: kaminoData.borrowApr - driftData.fundingRatePct,\n      fetchedAt: new Date().toISOString(),\n    };\n\n    return NextResponse.json(mergedData);\n  } catch (error) {\n    console.error('API error:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch data' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}