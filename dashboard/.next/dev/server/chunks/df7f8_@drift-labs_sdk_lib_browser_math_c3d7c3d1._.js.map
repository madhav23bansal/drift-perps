{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/utils.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.numberToSafeBN = exports.isBNSafe = exports.checkSameDate = exports.timeRemainingUntilUpdate = exports.sigNum = exports.divCeil = exports.squareRootBN = exports.clampBN = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nfunction clampBN(x, min, max) {\n    return anchor_1.BN.max(min, anchor_1.BN.min(x, max));\n}\nexports.clampBN = clampBN;\nconst squareRootBN = (n) => {\n    if (n.lt(new anchor_1.BN(0))) {\n        throw new Error('Sqrt only works on non-negtiave inputs');\n    }\n    if (n.lt(new anchor_1.BN(2))) {\n        return n;\n    }\n    const smallCand = (0, exports.squareRootBN)(n.shrn(2)).shln(1);\n    const largeCand = smallCand.add(new anchor_1.BN(1));\n    if (largeCand.mul(largeCand).gt(n)) {\n        return smallCand;\n    }\n    else {\n        return largeCand;\n    }\n};\nexports.squareRootBN = squareRootBN;\nconst divCeil = (a, b) => {\n    const quotient = a.div(b);\n    const remainder = a.mod(b);\n    if (remainder.gt(numericConstants_1.ZERO)) {\n        return quotient.add(numericConstants_1.ONE);\n    }\n    else {\n        return quotient;\n    }\n};\nexports.divCeil = divCeil;\nconst sigNum = (x) => {\n    return x.isNeg() ? new anchor_1.BN(-1) : new anchor_1.BN(1);\n};\nexports.sigNum = sigNum;\n/**\n * calculates the time remaining until the next update based on a rounded, \"on-the-hour\" update schedule\n * this schedule is used for Perpetual Funding Rate and Revenue -> Insurance Updates\n * @param now: current blockchain unix timestamp\n * @param lastUpdateTs: the unix timestamp of the last update\n * @param updatePeriod: desired interval between updates (in seconds)\n * @returns: timeRemainingUntilUpdate (in seconds)\n */\nfunction timeRemainingUntilUpdate(now, lastUpdateTs, updatePeriod) {\n    const timeSinceLastUpdate = now.sub(lastUpdateTs);\n    // round next update time to be available on the hour\n    let nextUpdateWait = updatePeriod;\n    if (updatePeriod.gt(new anchor_1.BN(1))) {\n        const lastUpdateDelay = lastUpdateTs.umod(updatePeriod);\n        if (!lastUpdateDelay.isZero()) {\n            const maxDelayForNextPeriod = updatePeriod.div(new anchor_1.BN(3));\n            const twoFundingPeriods = updatePeriod.mul(new anchor_1.BN(2));\n            if (lastUpdateDelay.gt(maxDelayForNextPeriod)) {\n                // too late for on the hour next period, delay to following period\n                nextUpdateWait = twoFundingPeriods.sub(lastUpdateDelay);\n            }\n            else {\n                // allow update on the hour\n                nextUpdateWait = updatePeriod.sub(lastUpdateDelay);\n            }\n            if (nextUpdateWait.gt(twoFundingPeriods)) {\n                nextUpdateWait = nextUpdateWait.sub(updatePeriod);\n            }\n        }\n    }\n    const timeRemainingUntilUpdate = nextUpdateWait\n        .sub(timeSinceLastUpdate)\n        .isNeg()\n        ? numericConstants_1.ZERO\n        : nextUpdateWait.sub(timeSinceLastUpdate);\n    return timeRemainingUntilUpdate;\n}\nexports.timeRemainingUntilUpdate = timeRemainingUntilUpdate;\nconst checkSameDate = (dateString1, dateString2) => {\n    const date1 = new Date(dateString1);\n    const date2 = new Date(dateString2);\n    const isSameDate = date1.getDate() === date2.getDate() &&\n        date1.getMonth() === date2.getMonth() &&\n        date1.getFullYear() === date2.getFullYear();\n    return isSameDate;\n};\nexports.checkSameDate = checkSameDate;\nfunction isBNSafe(number) {\n    return number <= 0x1fffffffffffff;\n}\nexports.isBNSafe = isBNSafe;\n/**\n * Converts a number to BN makes sure the number is safe to convert to BN (that it does not overflow number after multiplying by precision)\n * @param number the number to convert to BN\n * @param precision the BN precision to use (i.e. QUOTE_PRECISION and BASE_PRECISION from drift sdk)\n */\nfunction numberToSafeBN(number, precision) {\n    // check if number has decimals\n    const candidate = number * precision.toNumber();\n    if (isBNSafe(candidate)) {\n        return new anchor_1.BN(candidate);\n    }\n    else {\n        if (number % 1 === 0) {\n            return new anchor_1.BN(number.toString()).mul(precision);\n        }\n        else {\n            return new anchor_1.BN(number).mul(precision);\n        }\n    }\n}\nexports.numberToSafeBN = numberToSafeBN;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 109, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/tiers.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.perpTierIsAsSafeAs = exports.getSpotMarketTierNumber = exports.getPerpMarketTierNumber = void 0;\nconst types_1 = require(\"../types\");\nfunction getPerpMarketTierNumber(perpMarket) {\n    if ((0, types_1.isVariant)(perpMarket.contractTier, 'a')) {\n        return 0;\n    }\n    else if ((0, types_1.isVariant)(perpMarket.contractTier, 'b')) {\n        return 1;\n    }\n    else if ((0, types_1.isVariant)(perpMarket.contractTier, 'c')) {\n        return 2;\n    }\n    else if ((0, types_1.isVariant)(perpMarket.contractTier, 'speculative')) {\n        return 3;\n    }\n    else if ((0, types_1.isVariant)(perpMarket.contractTier, 'highlySpeculative')) {\n        return 4;\n    }\n    else {\n        return 5;\n    }\n}\nexports.getPerpMarketTierNumber = getPerpMarketTierNumber;\nfunction getSpotMarketTierNumber(spotMarket) {\n    if ((0, types_1.isVariant)(spotMarket.assetTier, 'collateral')) {\n        return 0;\n    }\n    else if ((0, types_1.isVariant)(spotMarket.assetTier, 'protected')) {\n        return 1;\n    }\n    else if ((0, types_1.isVariant)(spotMarket.assetTier, 'cross')) {\n        return 2;\n    }\n    else if ((0, types_1.isVariant)(spotMarket.assetTier, 'isolated')) {\n        return 3;\n    }\n    else if ((0, types_1.isVariant)(spotMarket.assetTier, 'unlisted')) {\n        return 4;\n    }\n    else {\n        return 5;\n    }\n}\nexports.getSpotMarketTierNumber = getSpotMarketTierNumber;\nfunction perpTierIsAsSafeAs(perpTier, otherPerpTier, otherSpotTier) {\n    const asSafeAsPerp = perpTier <= otherPerpTier;\n    const asSafeAsSpot = otherSpotTier === 4 || (otherSpotTier >= 2 && perpTier <= 2);\n    return asSafeAsSpot && asSafeAsPerp;\n}\nexports.perpTierIsAsSafeAs = perpTierIsAsSafeAs;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,kBAAkB,GAAG,QAAQ,uBAAuB,GAAG,QAAQ,uBAAuB,GAAG,KAAK;AACtG,MAAM;AACN,SAAS,wBAAwB,UAAU;IACvC,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,YAAY,EAAE,MAAM;QACtD,OAAO;IACX,OACK,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,YAAY,EAAE,MAAM;QAC3D,OAAO;IACX,OACK,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,YAAY,EAAE,MAAM;QAC3D,OAAO;IACX,OACK,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,YAAY,EAAE,gBAAgB;QACrE,OAAO;IACX,OACK,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,YAAY,EAAE,sBAAsB;QAC3E,OAAO;IACX,OACK;QACD,OAAO;IACX;AACJ;AACA,QAAQ,uBAAuB,GAAG;AAClC,SAAS,wBAAwB,UAAU;IACvC,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,SAAS,EAAE,eAAe;QAC5D,OAAO;IACX,OACK,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,SAAS,EAAE,cAAc;QAChE,OAAO;IACX,OACK,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,SAAS,EAAE,UAAU;QAC5D,OAAO;IACX,OACK,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,SAAS,EAAE,aAAa;QAC/D,OAAO;IACX,OACK,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,SAAS,EAAE,aAAa;QAC/D,OAAO;IACX,OACK;QACD,OAAO;IACX;AACJ;AACA,QAAQ,uBAAuB,GAAG;AAClC,SAAS,mBAAmB,QAAQ,EAAE,aAAa,EAAE,aAAa;IAC9D,MAAM,eAAe,YAAY;IACjC,MAAM,eAAe,kBAAkB,KAAM,iBAAiB,KAAK,YAAY;IAC/E,OAAO,gBAAgB;AAC3B;AACA,QAAQ,kBAAkB,GAAG","ignoreList":[0]}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/oracles.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getMultipleBetweenOracleSources = exports.trimVaaSignatures = exports.getNewOracleConfPct = exports.calculateLiveOracleStd = exports.calculateLiveOracleTwap = exports.isOracleTooDivergent = exports.isOracleValid = exports.getOracleValidity = exports.getMaxConfidenceIntervalMultiplier = exports.oraclePriceBands = void 0;\nconst types_1 = require(\"../types\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst assert_1 = require(\"../assert/assert\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nfunction oraclePriceBands(market, oraclePriceData) {\n    const maxPercentDiff = market.marginRatioInitial - market.marginRatioMaintenance;\n    const offset = oraclePriceData.price\n        .mul(new anchor_1.BN(maxPercentDiff))\n        .div(numericConstants_1.MARGIN_PRECISION);\n    (0, assert_1.assert)(offset.gte(numericConstants_1.ZERO));\n    return [oraclePriceData.price.sub(offset), oraclePriceData.price.add(offset)];\n}\nexports.oraclePriceBands = oraclePriceBands;\nfunction getMaxConfidenceIntervalMultiplier(market) {\n    let maxConfidenceIntervalMultiplier;\n    if ((0, types_1.isVariant)(market.contractTier, 'a')) {\n        maxConfidenceIntervalMultiplier = new anchor_1.BN(1);\n    }\n    else if ((0, types_1.isVariant)(market.contractTier, 'b')) {\n        maxConfidenceIntervalMultiplier = new anchor_1.BN(1);\n    }\n    else if ((0, types_1.isVariant)(market.contractTier, 'c')) {\n        maxConfidenceIntervalMultiplier = new anchor_1.BN(2);\n    }\n    else if ((0, types_1.isVariant)(market.contractTier, 'speculative')) {\n        maxConfidenceIntervalMultiplier = new anchor_1.BN(10);\n    }\n    else {\n        maxConfidenceIntervalMultiplier = new anchor_1.BN(50);\n    }\n    return maxConfidenceIntervalMultiplier;\n}\nexports.getMaxConfidenceIntervalMultiplier = getMaxConfidenceIntervalMultiplier;\nfunction getOracleValidity(market, oraclePriceData, oracleGuardRails, slot, oracleStalenessBuffer = numericConstants_1.FIVE) {\n    const isNonPositive = oraclePriceData.price.lte(numericConstants_1.ZERO);\n    const isTooVolatile = anchor_1.BN.max(oraclePriceData.price, market.amm.historicalOracleData.lastOraclePriceTwap)\n        .div(anchor_1.BN.max(numericConstants_1.ONE, anchor_1.BN.min(oraclePriceData.price, market.amm.historicalOracleData.lastOraclePriceTwap)))\n        .gt(oracleGuardRails.validity.tooVolatileRatio);\n    const confPctOfPrice = oraclePriceData.confidence\n        .mul(numericConstants_1.BID_ASK_SPREAD_PRECISION)\n        .div(oraclePriceData.price);\n    const isConfTooLarge = confPctOfPrice.gt(oracleGuardRails.validity.confidenceIntervalMaxSize.mul(getMaxConfidenceIntervalMultiplier(market)));\n    const oracleDelay = slot.sub(oraclePriceData.slot).sub(oracleStalenessBuffer);\n    let isStaleForAmmImmediate = true;\n    if (market.amm.oracleSlotDelayOverride != 0) {\n        isStaleForAmmImmediate = oracleDelay.gt(anchor_1.BN.max(new anchor_1.BN(market.amm.oracleSlotDelayOverride), numericConstants_1.ZERO));\n    }\n    let isStaleForAmmLowRisk = false;\n    if (market.amm.oracleLowRiskSlotDelayOverride != 0) {\n        isStaleForAmmLowRisk = oracleDelay.gt(anchor_1.BN.max(new anchor_1.BN(market.amm.oracleLowRiskSlotDelayOverride), numericConstants_1.ZERO));\n    }\n    else {\n        isStaleForAmmLowRisk = oracleDelay.gt(oracleGuardRails.validity.slotsBeforeStaleForAmm);\n    }\n    let isStaleForMargin = oracleDelay.gt(new anchor_1.BN(oracleGuardRails.validity.slotsBeforeStaleForMargin));\n    if ((0, types_1.isOneOfVariant)(market.amm.oracleSource, [\n        'pythStableCoinPull',\n        'pythLazerStableCoin',\n    ])) {\n        isStaleForMargin = oracleDelay.gt(new anchor_1.BN(oracleGuardRails.validity.slotsBeforeStaleForMargin).muln(3));\n    }\n    if (isNonPositive) {\n        return types_1.OracleValidity.NonPositive;\n    }\n    else if (isTooVolatile) {\n        return types_1.OracleValidity.TooVolatile;\n    }\n    else if (isConfTooLarge) {\n        return types_1.OracleValidity.TooUncertain;\n    }\n    else if (isStaleForMargin) {\n        return types_1.OracleValidity.StaleForMargin;\n    }\n    else if (!oraclePriceData.hasSufficientNumberOfDataPoints) {\n        return types_1.OracleValidity.InsufficientDataPoints;\n    }\n    else if (isStaleForAmmLowRisk) {\n        return types_1.OracleValidity.StaleForAMMLowRisk;\n    }\n    else if (isStaleForAmmImmediate) {\n        return types_1.OracleValidity.isStaleForAmmImmediate;\n    }\n    else {\n        return types_1.OracleValidity.Valid;\n    }\n}\nexports.getOracleValidity = getOracleValidity;\nfunction isOracleValid(market, oraclePriceData, oracleGuardRails, slot) {\n    // checks if oracle is valid for an AMM only fill\n    const amm = market.amm;\n    const isOraclePriceNonPositive = oraclePriceData.price.lte(numericConstants_1.ZERO);\n    const isOraclePriceTooVolatile = oraclePriceData.price\n        .div(anchor_1.BN.max(numericConstants_1.ONE, amm.historicalOracleData.lastOraclePriceTwap))\n        .gt(oracleGuardRails.validity.tooVolatileRatio) ||\n        amm.historicalOracleData.lastOraclePriceTwap\n            .div(anchor_1.BN.max(numericConstants_1.ONE, oraclePriceData.price))\n            .gt(oracleGuardRails.validity.tooVolatileRatio);\n    const maxConfidenceIntervalMultiplier = getMaxConfidenceIntervalMultiplier(market);\n    const isConfidenceTooLarge = anchor_1.BN.max(numericConstants_1.ONE, oraclePriceData.confidence)\n        .mul(numericConstants_1.BID_ASK_SPREAD_PRECISION)\n        .div(oraclePriceData.price)\n        .gt(oracleGuardRails.validity.confidenceIntervalMaxSize.mul(maxConfidenceIntervalMultiplier));\n    const oracleIsStale = new anchor_1.BN(slot)\n        .sub(oraclePriceData.slot)\n        .gt(oracleGuardRails.validity.slotsBeforeStaleForAmm);\n    return !(!oraclePriceData.hasSufficientNumberOfDataPoints ||\n        oracleIsStale ||\n        isOraclePriceNonPositive ||\n        isOraclePriceTooVolatile ||\n        isConfidenceTooLarge);\n}\nexports.isOracleValid = isOracleValid;\nfunction isOracleTooDivergent(amm, oraclePriceData, oracleGuardRails) {\n    const oracleSpreadPct = oraclePriceData.price\n        .sub(amm.historicalOracleData.lastOraclePriceTwap5Min)\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(amm.historicalOracleData.lastOraclePriceTwap5Min);\n    const maxDivergence = anchor_1.BN.max(oracleGuardRails.priceDivergence.oracleTwap5MinPercentDivergence, numericConstants_1.PERCENTAGE_PRECISION.div(new anchor_1.BN(2)));\n    const tooDivergent = oracleSpreadPct.abs().gte(maxDivergence);\n    return tooDivergent;\n}\nexports.isOracleTooDivergent = isOracleTooDivergent;\nfunction calculateLiveOracleTwap(histOracleData, oraclePriceData, now, period) {\n    let oracleTwap = undefined;\n    if (period.eq(numericConstants_1.FIVE_MINUTE)) {\n        oracleTwap = histOracleData.lastOraclePriceTwap5Min;\n    }\n    else {\n        //todo: assumes its fundingPeriod (1hr)\n        // period = amm.fundingPeriod;\n        oracleTwap = histOracleData.lastOraclePriceTwap;\n    }\n    const sinceLastUpdate = anchor_1.BN.max(numericConstants_1.ONE, now.sub(histOracleData.lastOraclePriceTwapTs));\n    const sinceStart = anchor_1.BN.max(numericConstants_1.ZERO, period.sub(sinceLastUpdate));\n    const clampRange = oracleTwap.div(new anchor_1.BN(3));\n    const clampedOraclePrice = anchor_1.BN.min(oracleTwap.add(clampRange), anchor_1.BN.max(oraclePriceData.price, oracleTwap.sub(clampRange)));\n    const newOracleTwap = oracleTwap\n        .mul(sinceStart)\n        .add(clampedOraclePrice.mul(sinceLastUpdate))\n        .div(sinceStart.add(sinceLastUpdate));\n    return newOracleTwap;\n}\nexports.calculateLiveOracleTwap = calculateLiveOracleTwap;\nfunction calculateLiveOracleStd(amm, oraclePriceData, now) {\n    const sinceLastUpdate = anchor_1.BN.max(numericConstants_1.ONE, now.sub(amm.historicalOracleData.lastOraclePriceTwapTs));\n    const sinceStart = anchor_1.BN.max(numericConstants_1.ZERO, amm.fundingPeriod.sub(sinceLastUpdate));\n    const liveOracleTwap = calculateLiveOracleTwap(amm.historicalOracleData, oraclePriceData, now, amm.fundingPeriod);\n    const liveOracleTwap5MIN = calculateLiveOracleTwap(amm.historicalOracleData, oraclePriceData, now, numericConstants_1.FIVE_MINUTE);\n    const priceDeltaVsTwap = anchor_1.BN.max(oraclePriceData.price.sub(liveOracleTwap).abs(), oraclePriceData.price.sub(liveOracleTwap5MIN).abs());\n    const oracleStd = priceDeltaVsTwap.add(amm.oracleStd.mul(sinceStart).div(sinceStart.add(sinceLastUpdate)));\n    return oracleStd;\n}\nexports.calculateLiveOracleStd = calculateLiveOracleStd;\nfunction getNewOracleConfPct(amm, oraclePriceData, reservePrice, now) {\n    const confInterval = oraclePriceData.confidence || numericConstants_1.ZERO;\n    const sinceLastUpdate = anchor_1.BN.max(numericConstants_1.ZERO, now.sub(amm.historicalOracleData.lastOraclePriceTwapTs));\n    let lowerBoundConfPct = amm.lastOracleConfPct;\n    if (sinceLastUpdate.gt(numericConstants_1.ZERO)) {\n        const lowerBoundConfDivisor = anchor_1.BN.max(new anchor_1.BN(21).sub(sinceLastUpdate), new anchor_1.BN(5));\n        lowerBoundConfPct = amm.lastOracleConfPct.sub(amm.lastOracleConfPct.div(lowerBoundConfDivisor));\n    }\n    const confIntervalPct = confInterval\n        .mul(numericConstants_1.BID_ASK_SPREAD_PRECISION)\n        .div(reservePrice);\n    const confIntervalPctResult = anchor_1.BN.max(confIntervalPct, lowerBoundConfPct);\n    return confIntervalPctResult;\n}\nexports.getNewOracleConfPct = getNewOracleConfPct;\nfunction trimVaaSignatures(vaa, n = 3) {\n    const currentNumSignatures = vaa[5];\n    if (n > currentNumSignatures) {\n        throw new Error(\"Resulting VAA can't have more signatures than the original VAA\");\n    }\n    const trimmedVaa = Buffer.concat([\n        vaa.subarray(0, 6 + n * 66),\n        vaa.subarray(6 + currentNumSignatures * 66),\n    ]);\n    trimmedVaa[5] = n;\n    return trimmedVaa;\n}\nexports.trimVaaSignatures = trimVaaSignatures;\nfunction getMultipleBetweenOracleSources(firstOracleSource, secondOracleSource) {\n    if ((0, types_1.isVariant)(firstOracleSource, 'pythPull') &&\n        (0, types_1.isVariant)(secondOracleSource, 'pyth1MPull')) {\n        return { numerator: new anchor_1.BN(1000000), denominator: new anchor_1.BN(1) };\n    }\n    if ((0, types_1.isVariant)(firstOracleSource, 'pythPull') &&\n        (0, types_1.isVariant)(secondOracleSource, 'pyth1KPull')) {\n        return { numerator: new anchor_1.BN(1000), denominator: new anchor_1.BN(1) };\n    }\n    if ((0, types_1.isVariant)(firstOracleSource, 'pyth1MPull') &&\n        (0, types_1.isVariant)(secondOracleSource, 'pythPull')) {\n        return { numerator: new anchor_1.BN(1), denominator: new anchor_1.BN(1000000) };\n    }\n    if ((0, types_1.isVariant)(firstOracleSource, 'pyth1KPull') &&\n        (0, types_1.isVariant)(secondOracleSource, 'pythPull')) {\n        return { numerator: new anchor_1.BN(1), denominator: new anchor_1.BN(1000) };\n    }\n    if ((0, types_1.isVariant)(firstOracleSource, 'pythLazer') &&\n        (0, types_1.isVariant)(secondOracleSource, 'pythLazer1M')) {\n        return { numerator: new anchor_1.BN(1000000), denominator: new anchor_1.BN(1) };\n    }\n    if ((0, types_1.isVariant)(firstOracleSource, 'pythLazer') &&\n        (0, types_1.isVariant)(secondOracleSource, 'pythLazer1K')) {\n        return { numerator: new anchor_1.BN(1000), denominator: new anchor_1.BN(1) };\n    }\n    if ((0, types_1.isVariant)(firstOracleSource, 'pythLazer1M') &&\n        (0, types_1.isVariant)(secondOracleSource, 'pythLazer')) {\n        return { numerator: new anchor_1.BN(1), denominator: new anchor_1.BN(1000000) };\n    }\n    if ((0, types_1.isVariant)(firstOracleSource, 'pythLazer1K') &&\n        (0, types_1.isVariant)(secondOracleSource, 'pythLazer')) {\n        return { numerator: new anchor_1.BN(1), denominator: new anchor_1.BN(1000) };\n    }\n    return { numerator: new anchor_1.BN(1), denominator: new anchor_1.BN(1) };\n}\nexports.getMultipleBetweenOracleSources = getMultipleBetweenOracleSources;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 362, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/exchangeStatus.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.isAmmDrawdownPause = exports.isOperationPaused = exports.ammPaused = exports.fillPaused = exports.exchangePaused = void 0;\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst types_1 = require(\"../types\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nfunction exchangePaused(state) {\n    return state.exchangeStatus !== types_1.ExchangeStatus.ACTIVE;\n}\nexports.exchangePaused = exchangePaused;\nfunction fillPaused(state, market) {\n    if ((state.exchangeStatus & types_1.ExchangeStatus.FILL_PAUSED) ===\n        types_1.ExchangeStatus.FILL_PAUSED) {\n        return true;\n    }\n    if (market.hasOwnProperty('amm')) {\n        return isOperationPaused(market.pausedOperations, types_1.PerpOperation.FILL);\n    }\n    else {\n        return isOperationPaused(market.pausedOperations, types_1.SpotOperation.FILL);\n    }\n}\nexports.fillPaused = fillPaused;\nfunction ammPaused(state, market) {\n    if ((state.exchangeStatus & types_1.ExchangeStatus.AMM_PAUSED) ===\n        types_1.ExchangeStatus.AMM_PAUSED) {\n        return true;\n    }\n    if (market.hasOwnProperty('amm')) {\n        const operationPaused = isOperationPaused(market.pausedOperations, types_1.PerpOperation.AMM_FILL);\n        if (operationPaused) {\n            return true;\n        }\n        if (isAmmDrawdownPause(market)) {\n            return true;\n        }\n    }\n    return false;\n}\nexports.ammPaused = ammPaused;\nfunction isOperationPaused(pausedOperations, operation) {\n    return (pausedOperations & operation) > 0;\n}\nexports.isOperationPaused = isOperationPaused;\nfunction isAmmDrawdownPause(market) {\n    let quoteDrawdownLimitBreached;\n    if ((0, types_1.isVariant)(market.contractTier, 'a') ||\n        (0, types_1.isVariant)(market.contractTier, 'b')) {\n        quoteDrawdownLimitBreached = market.amm.netRevenueSinceLastFunding.lte(numericConstants_1.DEFAULT_REVENUE_SINCE_LAST_FUNDING_SPREAD_RETREAT.muln(400));\n    }\n    else {\n        quoteDrawdownLimitBreached = market.amm.netRevenueSinceLastFunding.lte(numericConstants_1.DEFAULT_REVENUE_SINCE_LAST_FUNDING_SPREAD_RETREAT.muln(200));\n    }\n    if (quoteDrawdownLimitBreached) {\n        const percentDrawdown = market.amm.netRevenueSinceLastFunding\n            .mul(numericConstants_1.PERCENTAGE_PRECISION)\n            .div(anchor_1.BN.max(market.amm.totalFeeMinusDistributions, numericConstants_1.ONE));\n        let percentDrawdownLimitBreached;\n        if ((0, types_1.isVariant)(market.contractTier, 'a')) {\n            percentDrawdownLimitBreached = percentDrawdown.lte(numericConstants_1.PERCENTAGE_PRECISION.divn(50).neg());\n        }\n        else if ((0, types_1.isVariant)(market.contractTier, 'b')) {\n            percentDrawdownLimitBreached = percentDrawdown.lte(numericConstants_1.PERCENTAGE_PRECISION.divn(33).neg());\n        }\n        else if ((0, types_1.isVariant)(market.contractTier, 'c')) {\n            percentDrawdownLimitBreached = percentDrawdown.lte(numericConstants_1.PERCENTAGE_PRECISION.divn(25).neg());\n        }\n        else {\n            percentDrawdownLimitBreached = percentDrawdown.lte(numericConstants_1.PERCENTAGE_PRECISION.divn(20).neg());\n        }\n        if (percentDrawdownLimitBreached) {\n            return true;\n        }\n    }\n    return false;\n}\nexports.isAmmDrawdownPause = isAmmDrawdownPause;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 434, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/auction.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getTriggerAuctionStartAndExecutionPrice = exports.getTriggerAuctionStartPrice = exports.deriveOracleAuctionParams = exports.getAuctionPriceForOracleOffsetAuction = exports.getAuctionPriceForFixedAuction = exports.getAuctionPrice = exports.isFallbackAvailableLiquiditySource = exports.isAuctionComplete = void 0;\nconst types_1 = require(\"../types\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst types_2 = require(\"../types\");\nconst tiers_1 = require(\"./tiers\");\nconst orders_1 = require(\"./orders\");\nconst oracles_1 = require(\"./oracles\");\nconst exchangeStatus_1 = require(\"./exchangeStatus\");\nfunction isAuctionComplete(order, slot) {\n    if (order.auctionDuration === 0) {\n        return true;\n    }\n    return new anchor_1.BN(slot).sub(order.slot).gt(new anchor_1.BN(order.auctionDuration));\n}\nexports.isAuctionComplete = isAuctionComplete;\nfunction isFallbackAvailableLiquiditySource(order, mmOraclePriceData, slot, state, market, isLiquidation) {\n    if ((0, exchangeStatus_1.isOperationPaused)(market.pausedOperations, types_1.PerpOperation.AMM_FILL)) {\n        return false;\n    }\n    // TODO: include too much drawdown check & mm oracle volatility\n    const oracleValidity = (0, oracles_1.getOracleValidity)(market, {\n        price: mmOraclePriceData.price,\n        slot: mmOraclePriceData.slot,\n        confidence: mmOraclePriceData.confidence,\n        hasSufficientNumberOfDataPoints: mmOraclePriceData.hasSufficientNumberOfDataPoints,\n    }, state.oracleGuardRails, new anchor_1.BN(slot));\n    if (oracleValidity <= types_1.OracleValidity.StaleForAMMLowRisk) {\n        return false;\n    }\n    if (oracleValidity == types_1.OracleValidity.Valid) {\n        return true;\n    }\n    const isOrderLowRiskForAmm = (0, orders_1.isLowRiskForAmm)(order, mmOraclePriceData, isLiquidation);\n    if (!isOrderLowRiskForAmm) {\n        return false;\n    }\n    else {\n        return true;\n    }\n}\nexports.isFallbackAvailableLiquiditySource = isFallbackAvailableLiquiditySource;\n/**\n *\n * @param order\n * @param slot\n * @param oraclePrice Use MMOraclePriceData source for perp orders, OraclePriceData for spot\n * @returns BN\n */\nfunction getAuctionPrice(order, slot, oraclePrice) {\n    if ((0, types_1.isOneOfVariant)(order.orderType, ['market', 'triggerLimit']) ||\n        ((0, types_1.isVariant)(order.orderType, 'triggerMarket') &&\n            (order.bitFlags & types_2.OrderBitFlag.OracleTriggerMarket) === 0)) {\n        return getAuctionPriceForFixedAuction(order, slot);\n    }\n    else if ((0, types_1.isVariant)(order.orderType, 'limit')) {\n        if (order.oraclePriceOffset != null && order.oraclePriceOffset !== 0) {\n            return getAuctionPriceForOracleOffsetAuction(order, slot, oraclePrice);\n        }\n        else {\n            return getAuctionPriceForFixedAuction(order, slot);\n        }\n    }\n    else if ((0, types_1.isVariant)(order.orderType, 'oracle') ||\n        ((0, types_1.isVariant)(order.orderType, 'triggerMarket') &&\n            (order.bitFlags & types_2.OrderBitFlag.OracleTriggerMarket) !== 0)) {\n        return getAuctionPriceForOracleOffsetAuction(order, slot, oraclePrice);\n    }\n    else {\n        throw Error(`Cant get auction price for order type ${(0, types_2.getVariant)(order.orderType)}`);\n    }\n}\nexports.getAuctionPrice = getAuctionPrice;\nfunction getAuctionPriceForFixedAuction(order, slot) {\n    const slotsElapsed = new anchor_1.BN(slot).sub(order.slot);\n    const deltaDenominator = new anchor_1.BN(order.auctionDuration);\n    const deltaNumerator = anchor_1.BN.min(slotsElapsed, deltaDenominator);\n    if (deltaDenominator.eq(numericConstants_1.ZERO)) {\n        return order.auctionEndPrice;\n    }\n    let priceDelta;\n    if ((0, types_1.isVariant)(order.direction, 'long')) {\n        priceDelta = order.auctionEndPrice\n            .sub(order.auctionStartPrice)\n            .mul(deltaNumerator)\n            .div(deltaDenominator);\n    }\n    else {\n        priceDelta = order.auctionStartPrice\n            .sub(order.auctionEndPrice)\n            .mul(deltaNumerator)\n            .div(deltaDenominator);\n    }\n    let price;\n    if ((0, types_1.isVariant)(order.direction, 'long')) {\n        price = order.auctionStartPrice.add(priceDelta);\n    }\n    else {\n        price = order.auctionStartPrice.sub(priceDelta);\n    }\n    return price;\n}\nexports.getAuctionPriceForFixedAuction = getAuctionPriceForFixedAuction;\n/**\n *\n * @param order\n * @param slot\n * @param oraclePrice Use MMOraclePriceData source for perp orders, OraclePriceData for spot\n * @returns\n */\nfunction getAuctionPriceForOracleOffsetAuction(order, slot, oraclePrice) {\n    const slotsElapsed = new anchor_1.BN(slot).sub(order.slot);\n    const deltaDenominator = new anchor_1.BN(order.auctionDuration);\n    const deltaNumerator = anchor_1.BN.min(slotsElapsed, deltaDenominator);\n    if (deltaDenominator.eq(numericConstants_1.ZERO)) {\n        return anchor_1.BN.max(oraclePrice.add(order.auctionEndPrice), numericConstants_1.ONE);\n    }\n    let priceOffsetDelta;\n    if ((0, types_1.isVariant)(order.direction, 'long')) {\n        priceOffsetDelta = order.auctionEndPrice\n            .sub(order.auctionStartPrice)\n            .mul(deltaNumerator)\n            .div(deltaDenominator);\n    }\n    else {\n        priceOffsetDelta = order.auctionStartPrice\n            .sub(order.auctionEndPrice)\n            .mul(deltaNumerator)\n            .div(deltaDenominator);\n    }\n    let priceOffset;\n    if ((0, types_1.isVariant)(order.direction, 'long')) {\n        priceOffset = order.auctionStartPrice.add(priceOffsetDelta);\n    }\n    else {\n        priceOffset = order.auctionStartPrice.sub(priceOffsetDelta);\n    }\n    return anchor_1.BN.max(oraclePrice.add(priceOffset), numericConstants_1.ONE);\n}\nexports.getAuctionPriceForOracleOffsetAuction = getAuctionPriceForOracleOffsetAuction;\nfunction deriveOracleAuctionParams({ direction, oraclePrice, auctionStartPrice, auctionEndPrice, limitPrice, auctionPriceCaps, }) {\n    let oraclePriceOffset;\n    if (limitPrice.eq(numericConstants_1.ZERO) || oraclePrice.eq(numericConstants_1.ZERO)) {\n        oraclePriceOffset = numericConstants_1.ZERO;\n    }\n    else {\n        oraclePriceOffset = limitPrice.sub(oraclePrice);\n    }\n    if (oraclePriceOffset.eq(numericConstants_1.ZERO)) {\n        oraclePriceOffset = (0, types_1.isVariant)(direction, 'long')\n            ? auctionEndPrice.sub(oraclePrice).add(numericConstants_1.ONE)\n            : auctionEndPrice.sub(oraclePrice).sub(numericConstants_1.ONE);\n    }\n    let oraclePriceOffsetNum;\n    try {\n        oraclePriceOffsetNum = oraclePriceOffset.toNumber();\n    }\n    catch (e) {\n        oraclePriceOffsetNum = 0;\n    }\n    if (auctionPriceCaps) {\n        auctionStartPrice = anchor_1.BN.min(anchor_1.BN.max(auctionStartPrice, auctionPriceCaps.min), auctionPriceCaps.max);\n        auctionEndPrice = anchor_1.BN.min(anchor_1.BN.max(auctionEndPrice, auctionPriceCaps.min), auctionPriceCaps.max);\n    }\n    return {\n        auctionStartPrice: auctionStartPrice.sub(oraclePrice),\n        auctionEndPrice: auctionEndPrice.sub(oraclePrice),\n        oraclePriceOffset: oraclePriceOffsetNum,\n    };\n}\nexports.deriveOracleAuctionParams = deriveOracleAuctionParams;\n/**\n *\n * @param params Use OraclePriceData.price for oraclePrice param\n * @returns\n */\nfunction getTriggerAuctionStartPrice(params) {\n    const { perpMarket, direction, oraclePrice, limitPrice } = params;\n    const twapMismatch = perpMarket.amm.historicalOracleData.lastOraclePriceTwapTs\n        .sub(perpMarket.amm.lastMarkPriceTwapTs)\n        .abs()\n        .gte(new anchor_1.BN(60)) ||\n        perpMarket.amm.volume24H.lte(new anchor_1.BN(100000).mul(numericConstants_1.QUOTE_PRECISION));\n    let baselineStartOffset;\n    if (twapMismatch) {\n        const contractTierNumber = (0, tiers_1.getPerpMarketTierNumber)(perpMarket);\n        const priceDivisor = contractTierNumber <= 1 ? 500 : 100;\n        baselineStartOffset = (0, types_1.isVariant)(direction, 'long')\n            ? perpMarket.amm.lastBidPriceTwap.divn(priceDivisor)\n            : perpMarket.amm.lastAskPriceTwap.divn(priceDivisor).neg();\n    }\n    else {\n        const markTwapSlow = (0, types_1.isVariant)(direction, 'long')\n            ? perpMarket.amm.lastBidPriceTwap\n            : perpMarket.amm.lastAskPriceTwap;\n        const markTwapFast = perpMarket.amm.lastMarkPriceTwap5Min;\n        const oracleTwapSlow = perpMarket.amm.historicalOracleData.lastOraclePriceTwap;\n        const oracleTwapFast = perpMarket.amm.historicalOracleData.lastOraclePriceTwap5Min;\n        const offsetSlow = markTwapSlow.sub(oracleTwapSlow);\n        const offsetFast = markTwapFast.sub(oracleTwapFast);\n        const fracOfLongSpreadInPrice = new anchor_1.BN(perpMarket.amm.longSpread)\n            .mul(markTwapSlow)\n            .div(numericConstants_1.PRICE_PRECISION.muln(10)); // divide by 10x for safety\n        const fracOfShortSpreadInPrice = new anchor_1.BN(perpMarket.amm.shortSpread)\n            .mul(markTwapSlow)\n            .div(numericConstants_1.PRICE_PRECISION.muln(10)); // divide by 10x for safety\n        baselineStartOffset = (0, types_1.isVariant)(direction, 'long')\n            ? anchor_1.BN.min(offsetSlow.add(fracOfLongSpreadInPrice), offsetFast.sub(fracOfShortSpreadInPrice))\n            : anchor_1.BN.max(offsetSlow.sub(fracOfShortSpreadInPrice), offsetFast.add(fracOfLongSpreadInPrice));\n    }\n    let startBuffer = -3500;\n    if ((0, types_1.isVariant)(perpMarket.contractTier, 'a') ||\n        (0, types_1.isVariant)(perpMarket.contractTier, 'b')) {\n        startBuffer = -500;\n    }\n    // Apply start buffer (in BPS)\n    const startBufferPrice = oraclePrice\n        .mul(new anchor_1.BN(startBuffer))\n        .div(new anchor_1.BN(numericConstants_1.PRICE_PRECISION));\n    let auctionStartPrice = (0, types_1.isVariant)(direction, 'long')\n        ? oraclePrice.add(baselineStartOffset).sub(startBufferPrice)\n        : oraclePrice.add(baselineStartOffset).add(startBufferPrice);\n    if (limitPrice) {\n        if ((0, types_1.isVariant)(direction, 'long')) {\n            auctionStartPrice = anchor_1.BN.min(auctionStartPrice, limitPrice);\n        }\n        else {\n            auctionStartPrice = anchor_1.BN.max(auctionStartPrice, limitPrice);\n        }\n    }\n    return auctionStartPrice;\n}\nexports.getTriggerAuctionStartPrice = getTriggerAuctionStartPrice;\n/**\n *\n * @param params Use OraclePriceData.price for oraclePrice param and MMOraclePriceData.price for mmOraclePrice\n * @returns\n */\nfunction getTriggerAuctionStartAndExecutionPrice(params) {\n    const { perpMarket, direction, oraclePrice, limitPrice, mmOraclePrice } = params;\n    const startPrice = getTriggerAuctionStartPrice({\n        perpMarket,\n        direction,\n        oraclePrice,\n        limitPrice,\n    });\n    const offsetPlusBuffer = startPrice.sub(oraclePrice);\n    let executionPrice = mmOraclePrice.add(offsetPlusBuffer);\n    if (limitPrice) {\n        if ((0, types_1.isVariant)(direction, 'long')) {\n            executionPrice = anchor_1.BN.min(executionPrice, limitPrice);\n        }\n        else {\n            executionPrice = anchor_1.BN.max(executionPrice, limitPrice);\n        }\n    }\n    return { startPrice, executionPrice };\n}\nexports.getTriggerAuctionStartAndExecutionPrice = getTriggerAuctionStartAndExecutionPrice;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 651, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/spotBalance.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getSpotLiabilityValue = exports.getSpotAssetValue = exports.calculateWithdrawLimit = exports.calculateTokenUtilizationLimits = exports.calculateInterestAccumulated = exports.calculateBorrowRate = exports.calculateDepositRate = exports.calculateInterestRate = exports.calculateSpotMarketBorrowCapacity = exports.calculateUtilization = exports.calculateLiabilityWeight = exports.calculateScaledInitialAssetWeight = exports.calculateAssetWeight = exports.getTokenValue = exports.getStrictTokenValue = exports.getSignedTokenAmount = exports.getTokenAmount = exports.getBalance = void 0;\nconst types_1 = require(\"../types\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst margin_1 = require(\"./margin\");\nconst numericConstants_2 = require(\"../constants/numericConstants\");\nconst utils_1 = require(\"./utils\");\n/**\n * Calculates the balance of a given token amount including any accumulated interest. This\n * is the same as `SpotPosition.scaledBalance`.\n *\n * @param {BN} tokenAmount - the amount of tokens\n * @param {SpotMarketAccount} spotMarket - the spot market account\n * @param {SpotBalanceType} balanceType - the balance type ('deposit' or 'borrow')\n * @return {BN} the calculated balance, scaled by `SPOT_MARKET_BALANCE_PRECISION`\n */\nfunction getBalance(tokenAmount, spotMarket, balanceType) {\n    const precisionIncrease = numericConstants_1.TEN.pow(new anchor_1.BN(19 - spotMarket.decimals));\n    const cumulativeInterest = (0, types_1.isVariant)(balanceType, 'deposit')\n        ? spotMarket.cumulativeDepositInterest\n        : spotMarket.cumulativeBorrowInterest;\n    let balance = tokenAmount.mul(precisionIncrease).div(cumulativeInterest);\n    if (!balance.eq(numericConstants_1.ZERO) && (0, types_1.isVariant)(balanceType, 'borrow')) {\n        balance = balance.add(numericConstants_1.ONE);\n    }\n    return balance;\n}\nexports.getBalance = getBalance;\n/**\n * Calculates the spot token amount including any accumulated interest.\n *\n * @param {BN} balanceAmount - The balance amount, typically from `SpotPosition.scaledBalance`\n * @param {SpotMarketAccount} spotMarket - The spot market account details\n * @param {SpotBalanceType} balanceType - The balance type to be used for calculation\n * @returns {BN} The calculated token amount, scaled by `SpotMarketConfig.precision`\n */\nfunction getTokenAmount(balanceAmount, spotMarket, balanceType) {\n    const precisionDecrease = numericConstants_1.TEN.pow(new anchor_1.BN(19 - spotMarket.decimals));\n    if ((0, types_1.isVariant)(balanceType, 'deposit')) {\n        return balanceAmount\n            .mul(spotMarket.cumulativeDepositInterest)\n            .div(precisionDecrease);\n    }\n    else {\n        return (0, utils_1.divCeil)(balanceAmount.mul(spotMarket.cumulativeBorrowInterest), precisionDecrease);\n    }\n}\nexports.getTokenAmount = getTokenAmount;\n/**\n * Returns the signed (positive for deposit,negative for borrow) token amount based on the balance type.\n *\n * @param {BN} tokenAmount - The token amount to convert (from `getTokenAmount`)\n * @param {SpotBalanceType} balanceType - The balance type to determine the sign of the token amount.\n * @returns {BN} - The signed token amount, scaled by `SpotMarketConfig.precision`\n */\nfunction getSignedTokenAmount(tokenAmount, balanceType) {\n    if ((0, types_1.isVariant)(balanceType, 'deposit')) {\n        return tokenAmount;\n    }\n    else {\n        return tokenAmount.abs().neg();\n    }\n}\nexports.getSignedTokenAmount = getSignedTokenAmount;\n/**\n * Calculates the value of a given token amount using the worst of the provided oracle price and its TWAP.\n *\n * @param {BN} tokenAmount - The amount of tokens to calculate the value for (from `getTokenAmount`)\n * @param {number} spotDecimals - The number of decimals in the token.\n * @param {StrictOraclePrice} strictOraclePrice - Contains oracle price and 5min twap.\n * @return {BN} The calculated value of the given token amount, scaled by `PRICE_PRECISION`\n */\nfunction getStrictTokenValue(tokenAmount, spotDecimals, strictOraclePrice) {\n    if (tokenAmount.eq(numericConstants_1.ZERO)) {\n        return numericConstants_1.ZERO;\n    }\n    let price;\n    if (tokenAmount.gte(numericConstants_1.ZERO)) {\n        price = strictOraclePrice.min();\n    }\n    else {\n        price = strictOraclePrice.max();\n    }\n    const precisionDecrease = numericConstants_1.TEN.pow(new anchor_1.BN(spotDecimals));\n    return tokenAmount.mul(price).div(precisionDecrease);\n}\nexports.getStrictTokenValue = getStrictTokenValue;\n/**\n * Calculates the value of a given token amount in relation to an oracle price data\n *\n * @param {BN} tokenAmount - The amount of tokens to calculate the value for (from `getTokenAmount`)\n * @param {number} spotDecimals - The number of decimal places of the token.\n * @param {OraclePriceData} oraclePriceData - The oracle price data (typically a token/USD oracle).\n * @return {BN} The value of the token based on the oracle, scaled by `PRICE_PRECISION`\n */\nfunction getTokenValue(tokenAmount, spotDecimals, oraclePriceData) {\n    if (tokenAmount.eq(numericConstants_1.ZERO)) {\n        return numericConstants_1.ZERO;\n    }\n    const precisionDecrease = numericConstants_1.TEN.pow(new anchor_1.BN(spotDecimals));\n    return tokenAmount.mul(oraclePriceData.price).div(precisionDecrease);\n}\nexports.getTokenValue = getTokenValue;\nfunction calculateAssetWeight(balanceAmount, oraclePrice, spotMarket, marginCategory) {\n    const sizePrecision = numericConstants_1.TEN.pow(new anchor_1.BN(spotMarket.decimals));\n    let sizeInAmmReservePrecision;\n    if (sizePrecision.gt(numericConstants_1.AMM_RESERVE_PRECISION)) {\n        sizeInAmmReservePrecision = balanceAmount.div(sizePrecision.div(numericConstants_1.AMM_RESERVE_PRECISION));\n    }\n    else {\n        sizeInAmmReservePrecision = balanceAmount\n            .mul(numericConstants_1.AMM_RESERVE_PRECISION)\n            .div(sizePrecision);\n    }\n    let assetWeight;\n    switch (marginCategory) {\n        case 'Initial':\n            assetWeight = (0, margin_1.calculateSizeDiscountAssetWeight)(sizeInAmmReservePrecision, new anchor_1.BN(spotMarket.imfFactor), calculateScaledInitialAssetWeight(spotMarket, oraclePrice));\n            break;\n        case 'Maintenance':\n            assetWeight = (0, margin_1.calculateSizeDiscountAssetWeight)(sizeInAmmReservePrecision, new anchor_1.BN(spotMarket.imfFactor), new anchor_1.BN(spotMarket.maintenanceAssetWeight));\n            break;\n        default:\n            assetWeight = calculateScaledInitialAssetWeight(spotMarket, oraclePrice);\n            break;\n    }\n    return assetWeight;\n}\nexports.calculateAssetWeight = calculateAssetWeight;\nfunction calculateScaledInitialAssetWeight(spotMarket, oraclePrice) {\n    if (spotMarket.scaleInitialAssetWeightStart.eq(numericConstants_1.ZERO)) {\n        return new anchor_1.BN(spotMarket.initialAssetWeight);\n    }\n    const deposits = getTokenAmount(spotMarket.depositBalance, spotMarket, types_1.SpotBalanceType.DEPOSIT);\n    const depositsValue = getTokenValue(deposits, spotMarket.decimals, {\n        price: oraclePrice,\n    });\n    if (depositsValue.lt(spotMarket.scaleInitialAssetWeightStart)) {\n        return new anchor_1.BN(spotMarket.initialAssetWeight);\n    }\n    else {\n        return new anchor_1.BN(spotMarket.initialAssetWeight)\n            .mul(spotMarket.scaleInitialAssetWeightStart)\n            .div(depositsValue);\n    }\n}\nexports.calculateScaledInitialAssetWeight = calculateScaledInitialAssetWeight;\nfunction calculateLiabilityWeight(size, spotMarket, marginCategory) {\n    const sizePrecision = numericConstants_1.TEN.pow(new anchor_1.BN(spotMarket.decimals));\n    let sizeInAmmReservePrecision;\n    if (sizePrecision.gt(numericConstants_1.AMM_RESERVE_PRECISION)) {\n        sizeInAmmReservePrecision = size.div(sizePrecision.div(numericConstants_1.AMM_RESERVE_PRECISION));\n    }\n    else {\n        sizeInAmmReservePrecision = size\n            .mul(numericConstants_1.AMM_RESERVE_PRECISION)\n            .div(sizePrecision);\n    }\n    let liabilityWeight;\n    switch (marginCategory) {\n        case 'Initial':\n            liabilityWeight = (0, margin_1.calculateSizePremiumLiabilityWeight)(sizeInAmmReservePrecision, new anchor_1.BN(spotMarket.imfFactor), new anchor_1.BN(spotMarket.initialLiabilityWeight), numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION);\n            break;\n        case 'Maintenance':\n            liabilityWeight = (0, margin_1.calculateSizePremiumLiabilityWeight)(sizeInAmmReservePrecision, new anchor_1.BN(spotMarket.imfFactor), new anchor_1.BN(spotMarket.maintenanceLiabilityWeight), numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION);\n            break;\n        default:\n            liabilityWeight = new anchor_1.BN(spotMarket.initialLiabilityWeight);\n            break;\n    }\n    return liabilityWeight;\n}\nexports.calculateLiabilityWeight = calculateLiabilityWeight;\nfunction calculateUtilization(bank, delta = numericConstants_1.ZERO) {\n    let tokenDepositAmount = getTokenAmount(bank.depositBalance, bank, types_1.SpotBalanceType.DEPOSIT);\n    let tokenBorrowAmount = getTokenAmount(bank.borrowBalance, bank, types_1.SpotBalanceType.BORROW);\n    if (delta.gt(numericConstants_1.ZERO)) {\n        tokenDepositAmount = tokenDepositAmount.add(delta);\n    }\n    else if (delta.lt(numericConstants_1.ZERO)) {\n        tokenBorrowAmount = tokenBorrowAmount.add(delta.abs());\n    }\n    let utilization;\n    if (tokenBorrowAmount.eq(numericConstants_1.ZERO) && tokenDepositAmount.eq(numericConstants_1.ZERO)) {\n        utilization = numericConstants_1.ZERO;\n    }\n    else if (tokenDepositAmount.eq(numericConstants_1.ZERO)) {\n        utilization = numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION;\n    }\n    else {\n        utilization = tokenBorrowAmount\n            .mul(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n            .div(tokenDepositAmount);\n    }\n    return utilization;\n}\nexports.calculateUtilization = calculateUtilization;\n/**\n * calculates max borrow amount where rate would stay below targetBorrowRate\n * @param spotMarketAccount\n * @param targetBorrowRate\n * @returns : Precision: TOKEN DECIMALS\n */\nfunction calculateSpotMarketBorrowCapacity(spotMarketAccount, targetBorrowRate) {\n    const currentBorrowRate = calculateBorrowRate(spotMarketAccount);\n    const tokenDepositAmount = getTokenAmount(spotMarketAccount.depositBalance, spotMarketAccount, types_1.SpotBalanceType.DEPOSIT);\n    const tokenBorrowAmount = getTokenAmount(spotMarketAccount.borrowBalance, spotMarketAccount, types_1.SpotBalanceType.BORROW);\n    let targetUtilization;\n    // target utilization past mid point\n    if (targetBorrowRate.gte(new anchor_1.BN(spotMarketAccount.optimalBorrowRate))) {\n        const borrowRateSlope = new anchor_1.BN(spotMarketAccount.maxBorrowRate - spotMarketAccount.optimalBorrowRate)\n            .mul(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n            .div(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION.sub(new anchor_1.BN(spotMarketAccount.optimalUtilization)));\n        const surplusTargetUtilization = targetBorrowRate\n            .sub(new anchor_1.BN(spotMarketAccount.optimalBorrowRate))\n            .mul(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n            .div(borrowRateSlope);\n        targetUtilization = surplusTargetUtilization.add(new anchor_1.BN(spotMarketAccount.optimalUtilization));\n    }\n    else {\n        const borrowRateSlope = new anchor_1.BN(spotMarketAccount.optimalBorrowRate)\n            .mul(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n            .div(new anchor_1.BN(spotMarketAccount.optimalUtilization));\n        targetUtilization = targetBorrowRate\n            .mul(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n            .div(borrowRateSlope);\n    }\n    const totalCapacity = tokenDepositAmount\n        .mul(targetUtilization)\n        .div(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION);\n    let remainingCapacity;\n    if (currentBorrowRate.gte(targetBorrowRate)) {\n        remainingCapacity = numericConstants_1.ZERO;\n    }\n    else {\n        remainingCapacity = anchor_1.BN.max(numericConstants_1.ZERO, totalCapacity.sub(tokenBorrowAmount));\n    }\n    if (spotMarketAccount.maxTokenBorrowsFraction > 0) {\n        const maxTokenBorrows = spotMarketAccount.maxTokenDeposits\n            .mul(new anchor_1.BN(spotMarketAccount.maxTokenBorrowsFraction))\n            .divn(10000);\n        remainingCapacity = anchor_1.BN.min(remainingCapacity, anchor_1.BN.max(numericConstants_1.ZERO, maxTokenBorrows.sub(tokenBorrowAmount)));\n    }\n    return { totalCapacity, remainingCapacity };\n}\nexports.calculateSpotMarketBorrowCapacity = calculateSpotMarketBorrowCapacity;\nfunction calculateInterestRate(bank, delta = numericConstants_1.ZERO, currentUtilization = null) {\n    // todo: ensure both a delta and current util aren't pass?\n    const utilization = currentUtilization || calculateUtilization(bank, delta);\n    const optimalUtil = new anchor_1.BN(bank.optimalUtilization);\n    const optimalRate = new anchor_1.BN(bank.optimalBorrowRate);\n    const maxRate = new anchor_1.BN(bank.maxBorrowRate);\n    const minRate = new anchor_1.BN(bank.minBorrowRate).mul(numericConstants_2.PERCENTAGE_PRECISION.divn(200));\n    const weightsDivisor = new anchor_1.BN(1000);\n    const segments = [\n        [new anchor_1.BN(850000), new anchor_1.BN(50)],\n        [new anchor_1.BN(900000), new anchor_1.BN(100)],\n        [new anchor_1.BN(950000), new anchor_1.BN(150)],\n        [new anchor_1.BN(990000), new anchor_1.BN(200)],\n        [new anchor_1.BN(995000), new anchor_1.BN(250)],\n        [numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION, new anchor_1.BN(250)],\n    ];\n    let rate;\n    if (utilization.lte(optimalUtil)) {\n        // below optimal: linear ramp from 0 to optimalRate\n        const slope = optimalRate\n            .mul(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n            .div(optimalUtil);\n        rate = utilization.mul(slope).div(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION);\n    }\n    else {\n        // above optimal: piecewise segments\n        const totalExtraRate = maxRate.sub(optimalRate);\n        rate = optimalRate.clone();\n        let prevUtil = optimalUtil.clone();\n        for (const [bp, weight] of segments) {\n            const segmentEnd = bp.gt(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n                ? numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION\n                : bp;\n            const segmentRange = segmentEnd.sub(prevUtil);\n            const segmentRateTotal = totalExtraRate.mul(weight).div(weightsDivisor);\n            if (utilization.lte(segmentEnd)) {\n                const partialUtil = utilization.sub(prevUtil);\n                const partialRate = segmentRateTotal.mul(partialUtil).div(segmentRange);\n                rate = rate.add(partialRate);\n                break;\n            }\n            else {\n                rate = rate.add(segmentRateTotal);\n                prevUtil = segmentEnd;\n            }\n        }\n    }\n    return anchor_1.BN.max(minRate, rate);\n}\nexports.calculateInterestRate = calculateInterestRate;\nfunction calculateDepositRate(bank, delta = numericConstants_1.ZERO, currentUtilization = null) {\n    // positive delta => adding to deposit\n    // negative delta => adding to borrow\n    const utilization = currentUtilization || calculateUtilization(bank, delta);\n    const borrowRate = calculateBorrowRate(bank, delta, utilization);\n    const depositRate = borrowRate\n        .mul(numericConstants_2.PERCENTAGE_PRECISION.sub(new anchor_1.BN(bank.insuranceFund.totalFactor)))\n        .mul(utilization)\n        .div(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n        .div(numericConstants_2.PERCENTAGE_PRECISION);\n    return depositRate;\n}\nexports.calculateDepositRate = calculateDepositRate;\nfunction calculateBorrowRate(bank, delta = numericConstants_1.ZERO, currentUtilization = null) {\n    return calculateInterestRate(bank, delta, currentUtilization);\n}\nexports.calculateBorrowRate = calculateBorrowRate;\nfunction calculateInterestAccumulated(bank, now) {\n    const interestRate = calculateInterestRate(bank);\n    const timeSinceLastUpdate = now.sub(bank.lastInterestTs);\n    const modifiedBorrowRate = interestRate.mul(timeSinceLastUpdate);\n    const utilization = calculateUtilization(bank);\n    const modifiedDepositRate = modifiedBorrowRate\n        .mul(utilization)\n        .div(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION);\n    const borrowInterest = bank.cumulativeBorrowInterest\n        .mul(modifiedBorrowRate)\n        .div(numericConstants_1.ONE_YEAR)\n        .div(numericConstants_1.SPOT_MARKET_RATE_PRECISION)\n        .add(numericConstants_1.ONE);\n    const depositInterest = bank.cumulativeDepositInterest\n        .mul(modifiedDepositRate)\n        .div(numericConstants_1.ONE_YEAR)\n        .div(numericConstants_1.SPOT_MARKET_RATE_PRECISION);\n    return { borrowInterest, depositInterest };\n}\nexports.calculateInterestAccumulated = calculateInterestAccumulated;\nfunction calculateTokenUtilizationLimits(depositTokenAmount, borrowTokenAmount, spotMarket) {\n    // Calculates the allowable minimum deposit and maximum borrow amounts for immediate withdrawal based on market utilization.\n    // First, it determines a maximum withdrawal utilization from the market's target and historic utilization.\n    // Then, it deduces corresponding deposit/borrow amounts.\n    // Note: For deposit sizes below the guard threshold, withdrawals aren't blocked.\n    const maxWithdrawUtilization = anchor_1.BN.max(new anchor_1.BN(spotMarket.optimalUtilization), spotMarket.utilizationTwap.add(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION.sub(spotMarket.utilizationTwap).div(new anchor_1.BN(2))));\n    let minDepositTokensForUtilization = borrowTokenAmount\n        .mul(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION)\n        .div(maxWithdrawUtilization);\n    // don't block withdraws for deposit sizes below guard threshold\n    minDepositTokensForUtilization = anchor_1.BN.min(minDepositTokensForUtilization, depositTokenAmount.sub(spotMarket.withdrawGuardThreshold));\n    let maxBorrowTokensForUtilization = maxWithdrawUtilization\n        .mul(depositTokenAmount)\n        .div(numericConstants_1.SPOT_MARKET_UTILIZATION_PRECISION);\n    maxBorrowTokensForUtilization = anchor_1.BN.max(spotMarket.withdrawGuardThreshold, maxBorrowTokensForUtilization);\n    return {\n        minDepositTokensForUtilization,\n        maxBorrowTokensForUtilization,\n    };\n}\nexports.calculateTokenUtilizationLimits = calculateTokenUtilizationLimits;\nfunction calculateWithdrawLimit(spotMarket, now) {\n    const marketDepositTokenAmount = getTokenAmount(spotMarket.depositBalance, spotMarket, types_1.SpotBalanceType.DEPOSIT);\n    const marketBorrowTokenAmount = getTokenAmount(spotMarket.borrowBalance, spotMarket, types_1.SpotBalanceType.BORROW);\n    const twentyFourHours = new anchor_1.BN(60 * 60 * 24);\n    const sinceLast = now.sub(spotMarket.lastTwapTs);\n    const sinceStart = anchor_1.BN.max(numericConstants_1.ZERO, twentyFourHours.sub(sinceLast));\n    const borrowTokenTwapLive = spotMarket.borrowTokenTwap\n        .mul(sinceStart)\n        .add(marketBorrowTokenAmount.mul(sinceLast))\n        .div(sinceLast.add(sinceStart));\n    const depositTokenTwapLive = spotMarket.depositTokenTwap\n        .mul(sinceStart)\n        .add(marketDepositTokenAmount.mul(sinceLast))\n        .div(sinceLast.add(sinceStart));\n    const lesserDepositAmount = anchor_1.BN.min(marketDepositTokenAmount, depositTokenTwapLive);\n    let maxBorrowTokensTwap;\n    if (spotMarket.poolId == 0) {\n        maxBorrowTokensTwap = anchor_1.BN.max(spotMarket.withdrawGuardThreshold, anchor_1.BN.min(anchor_1.BN.max(marketDepositTokenAmount.div(new anchor_1.BN(3)), borrowTokenTwapLive.add(lesserDepositAmount.div(new anchor_1.BN(7)))), lesserDepositAmount.sub(lesserDepositAmount.div(new anchor_1.BN(8))))); // main pool between ~30-92.5% utilization with friction on twap in 20% increments\n    }\n    else {\n        maxBorrowTokensTwap = anchor_1.BN.max(spotMarket.withdrawGuardThreshold, anchor_1.BN.min(anchor_1.BN.max(marketDepositTokenAmount.div(new anchor_1.BN(2)), borrowTokenTwapLive.add(lesserDepositAmount.div(new anchor_1.BN(3)))), lesserDepositAmount.sub(lesserDepositAmount.div(new anchor_1.BN(20))))); // isolated pools between 50-95% utilization with friction on twap in 33% increments\n    }\n    const minDepositTokensTwap = depositTokenTwapLive.sub(anchor_1.BN.max(depositTokenTwapLive.div(new anchor_1.BN(4)), anchor_1.BN.min(spotMarket.withdrawGuardThreshold, depositTokenTwapLive)));\n    const { minDepositTokensForUtilization, maxBorrowTokensForUtilization } = calculateTokenUtilizationLimits(marketDepositTokenAmount, marketBorrowTokenAmount, spotMarket);\n    const minDepositTokens = anchor_1.BN.max(minDepositTokensForUtilization, minDepositTokensTwap);\n    let maxBorrowTokens = anchor_1.BN.min(maxBorrowTokensForUtilization, maxBorrowTokensTwap);\n    const withdrawLimit = anchor_1.BN.max(marketDepositTokenAmount.sub(minDepositTokens), numericConstants_1.ZERO);\n    let borrowLimit = maxBorrowTokens.sub(marketBorrowTokenAmount);\n    borrowLimit = anchor_1.BN.min(borrowLimit, marketDepositTokenAmount.sub(marketBorrowTokenAmount));\n    if (spotMarket.maxTokenBorrowsFraction > 0) {\n        const maxTokenBorrowsByFraction = spotMarket.maxTokenDeposits\n            .mul(new anchor_1.BN(spotMarket.maxTokenBorrowsFraction))\n            .divn(10000);\n        const trueMaxBorrowTokensAvailable = maxTokenBorrowsByFraction.sub(marketBorrowTokenAmount);\n        maxBorrowTokens = anchor_1.BN.min(maxBorrowTokens, trueMaxBorrowTokensAvailable);\n        borrowLimit = anchor_1.BN.min(borrowLimit, maxBorrowTokens);\n    }\n    if (withdrawLimit.eq(numericConstants_1.ZERO) || (0, types_1.isVariant)(spotMarket.assetTier, 'protected')) {\n        borrowLimit = numericConstants_1.ZERO;\n    }\n    return {\n        borrowLimit,\n        withdrawLimit,\n        maxBorrowAmount: maxBorrowTokens,\n        minDepositAmount: minDepositTokens,\n        currentDepositAmount: marketDepositTokenAmount,\n        currentBorrowAmount: marketBorrowTokenAmount,\n    };\n}\nexports.calculateWithdrawLimit = calculateWithdrawLimit;\nfunction getSpotAssetValue(tokenAmount, strictOraclePrice, spotMarketAccount, maxMarginRatio, marginCategory) {\n    let assetValue = getStrictTokenValue(tokenAmount, spotMarketAccount.decimals, strictOraclePrice);\n    if (marginCategory !== undefined) {\n        let weight = calculateAssetWeight(tokenAmount, strictOraclePrice.current, spotMarketAccount, marginCategory);\n        if (marginCategory === 'Initial' &&\n            spotMarketAccount.marketIndex !== numericConstants_1.QUOTE_SPOT_MARKET_INDEX) {\n            const userCustomAssetWeight = anchor_1.BN.max(numericConstants_1.ZERO, numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION.subn(maxMarginRatio));\n            weight = anchor_1.BN.min(weight, userCustomAssetWeight);\n        }\n        assetValue = assetValue.mul(weight).div(numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION);\n    }\n    return assetValue;\n}\nexports.getSpotAssetValue = getSpotAssetValue;\nfunction getSpotLiabilityValue(tokenAmount, strictOraclePrice, spotMarketAccount, maxMarginRatio, marginCategory, liquidationBuffer) {\n    let liabilityValue = getStrictTokenValue(tokenAmount, spotMarketAccount.decimals, strictOraclePrice);\n    if (marginCategory !== undefined) {\n        let weight = calculateLiabilityWeight(tokenAmount, spotMarketAccount, marginCategory);\n        if (marginCategory === 'Initial' &&\n            spotMarketAccount.marketIndex !== numericConstants_1.QUOTE_SPOT_MARKET_INDEX) {\n            weight = anchor_1.BN.max(weight, numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION.addn(maxMarginRatio));\n        }\n        if (liquidationBuffer !== undefined) {\n            weight = weight.add(liquidationBuffer);\n        }\n        liabilityValue = liabilityValue\n            .mul(weight)\n            .div(numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION);\n    }\n    return liabilityValue;\n}\nexports.getSpotLiabilityValue = getSpotLiabilityValue;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 1040, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/market.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getTriggerPrice = exports.calculatePerpMarketBaseLiquidatorFee = exports.calculateAvailablePerpLiquidity = exports.calculateNetUserPnlImbalance = exports.calculateNetUserPnl = exports.calculateMarketMaxAvailableInsurance = exports.calculateMarketAvailablePNL = exports.calculateUnrealizedAssetWeight = exports.calculateMarketMarginRatio = exports.calculateOracleSpread = exports.calculateOracleReserveSpread = exports.calculateNewMarketAfterTrade = exports.calculateAskPrice = exports.calculateBidPrice = exports.calculateReservePrice = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst types_1 = require(\"../types\");\nconst amm_1 = require(\"./amm\");\nconst margin_1 = require(\"./margin\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst spotBalance_1 = require(\"./spotBalance\");\nconst assert_1 = require(\"../assert/assert\");\n/**\n * Calculates market mark price\n *\n * @param market\n * @return markPrice : Precision PRICE_PRECISION\n */\nfunction calculateReservePrice(market, mmOraclePriceData) {\n    const newAmm = (0, amm_1.calculateUpdatedAMM)(market.amm, mmOraclePriceData);\n    return (0, amm_1.calculatePrice)(newAmm.baseAssetReserve, newAmm.quoteAssetReserve, newAmm.pegMultiplier);\n}\nexports.calculateReservePrice = calculateReservePrice;\n/**\n * Calculates market bid price\n *\n * @param market\n * @return bidPrice : Precision PRICE_PRECISION\n */\nfunction calculateBidPrice(market, mmOraclePriceData, latestSlot) {\n    const { baseAssetReserve, quoteAssetReserve, newPeg } = (0, amm_1.calculateUpdatedAMMSpreadReserves)(market.amm, types_1.PositionDirection.SHORT, mmOraclePriceData, undefined, latestSlot);\n    return (0, amm_1.calculatePrice)(baseAssetReserve, quoteAssetReserve, newPeg);\n}\nexports.calculateBidPrice = calculateBidPrice;\n/**\n * Calculates market ask price\n *\n * @param market\n * @return askPrice : Precision PRICE_PRECISION\n */\nfunction calculateAskPrice(market, mmOraclePriceData, latestSlot) {\n    const { baseAssetReserve, quoteAssetReserve, newPeg } = (0, amm_1.calculateUpdatedAMMSpreadReserves)(market.amm, types_1.PositionDirection.LONG, mmOraclePriceData, undefined, latestSlot);\n    return (0, amm_1.calculatePrice)(baseAssetReserve, quoteAssetReserve, newPeg);\n}\nexports.calculateAskPrice = calculateAskPrice;\nfunction calculateNewMarketAfterTrade(baseAssetAmount, direction, market) {\n    const [newQuoteAssetReserve, newBaseAssetReserve] = (0, amm_1.calculateAmmReservesAfterSwap)(market.amm, 'base', baseAssetAmount.abs(), (0, amm_1.getSwapDirection)('base', direction));\n    const newAmm = Object.assign({}, market.amm);\n    const newMarket = Object.assign({}, market);\n    newMarket.amm = newAmm;\n    newMarket.amm.quoteAssetReserve = newQuoteAssetReserve;\n    newMarket.amm.baseAssetReserve = newBaseAssetReserve;\n    return newMarket;\n}\nexports.calculateNewMarketAfterTrade = calculateNewMarketAfterTrade;\nfunction calculateOracleReserveSpread(market, mmOraclePriceData) {\n    const reservePrice = calculateReservePrice(market, mmOraclePriceData);\n    return calculateOracleSpread(reservePrice, mmOraclePriceData);\n}\nexports.calculateOracleReserveSpread = calculateOracleReserveSpread;\nfunction calculateOracleSpread(price, oraclePriceData) {\n    return price.sub(oraclePriceData.price);\n}\nexports.calculateOracleSpread = calculateOracleSpread;\nfunction calculateMarketMarginRatio(market, size, marginCategory, customMarginRatio = 0, userHighLeverageMode = false) {\n    if (market.status === 'Settlement')\n        return 0;\n    const isHighLeverageUser = userHighLeverageMode &&\n        market.highLeverageMarginRatioInitial > 0 &&\n        market.highLeverageMarginRatioMaintenance > 0;\n    const marginRatioInitial = isHighLeverageUser\n        ? market.highLeverageMarginRatioInitial\n        : market.marginRatioInitial;\n    const marginRatioMaintenance = isHighLeverageUser\n        ? market.highLeverageMarginRatioMaintenance\n        : market.marginRatioMaintenance;\n    let defaultMarginRatio;\n    switch (marginCategory) {\n        case 'Initial':\n            defaultMarginRatio = marginRatioInitial;\n            break;\n        case 'Maintenance':\n            defaultMarginRatio = marginRatioMaintenance;\n            break;\n        default:\n            throw new Error('Invalid margin category');\n    }\n    let marginRatio;\n    if (isHighLeverageUser && marginCategory !== 'Maintenance') {\n        // Use ordinary-mode initial/fill ratios for size-adjusted calc\n        let preSizeAdjMarginRatio;\n        switch (marginCategory) {\n            case 'Initial':\n                preSizeAdjMarginRatio = market.marginRatioInitial;\n                break;\n            default:\n                preSizeAdjMarginRatio = marginRatioMaintenance;\n                break;\n        }\n        const sizeAdjMarginRatio = (0, margin_1.calculateSizePremiumLiabilityWeight)(size, new anchor_1.BN(market.imfFactor), new anchor_1.BN(preSizeAdjMarginRatio), numericConstants_1.MARGIN_PRECISION, false).toNumber();\n        marginRatio = (0, margin_1.calcHighLeverageModeInitialMarginRatioFromSize)(new anchor_1.BN(preSizeAdjMarginRatio), new anchor_1.BN(sizeAdjMarginRatio), new anchor_1.BN(defaultMarginRatio)).toNumber();\n    }\n    else {\n        const sizeAdjMarginRatio = (0, margin_1.calculateSizePremiumLiabilityWeight)(size, new anchor_1.BN(market.imfFactor), new anchor_1.BN(defaultMarginRatio), numericConstants_1.MARGIN_PRECISION, true).toNumber();\n        marginRatio = Math.max(defaultMarginRatio, sizeAdjMarginRatio);\n    }\n    if (marginCategory === 'Initial') {\n        marginRatio = Math.max(marginRatio, customMarginRatio);\n    }\n    return marginRatio;\n}\nexports.calculateMarketMarginRatio = calculateMarketMarginRatio;\nfunction calculateUnrealizedAssetWeight(market, quoteSpotMarket, unrealizedPnl, marginCategory, oraclePriceData) {\n    let assetWeight;\n    switch (marginCategory) {\n        case 'Initial':\n            assetWeight = new anchor_1.BN(market.unrealizedPnlInitialAssetWeight);\n            if (market.unrealizedPnlMaxImbalance.gt(numericConstants_1.ZERO)) {\n                const netUnsettledPnl = calculateNetUserPnlImbalance(market, quoteSpotMarket, oraclePriceData);\n                if (netUnsettledPnl.gt(market.unrealizedPnlMaxImbalance)) {\n                    assetWeight = assetWeight\n                        .mul(market.unrealizedPnlMaxImbalance)\n                        .div(netUnsettledPnl);\n                }\n            }\n            assetWeight = (0, margin_1.calculateSizeDiscountAssetWeight)(unrealizedPnl, new anchor_1.BN(market.unrealizedPnlImfFactor), assetWeight);\n            break;\n        case 'Maintenance':\n            assetWeight = new anchor_1.BN(market.unrealizedPnlMaintenanceAssetWeight);\n            break;\n    }\n    return assetWeight;\n}\nexports.calculateUnrealizedAssetWeight = calculateUnrealizedAssetWeight;\nfunction calculateMarketAvailablePNL(perpMarket, spotMarket) {\n    return (0, spotBalance_1.getTokenAmount)(perpMarket.pnlPool.scaledBalance, spotMarket, types_1.SpotBalanceType.DEPOSIT);\n}\nexports.calculateMarketAvailablePNL = calculateMarketAvailablePNL;\nfunction calculateMarketMaxAvailableInsurance(perpMarket, spotMarket) {\n    (0, assert_1.assert)(spotMarket.marketIndex == numericConstants_1.QUOTE_SPOT_MARKET_INDEX);\n    // todo: insuranceFundAllocation technically not guaranteed to be in Insurance Fund\n    const insuranceFundAllocation = perpMarket.insuranceClaim.quoteMaxInsurance.sub(perpMarket.insuranceClaim.quoteSettledInsurance);\n    const ammFeePool = (0, spotBalance_1.getTokenAmount)(perpMarket.amm.feePool.scaledBalance, spotMarket, types_1.SpotBalanceType.DEPOSIT);\n    return insuranceFundAllocation.add(ammFeePool);\n}\nexports.calculateMarketMaxAvailableInsurance = calculateMarketMaxAvailableInsurance;\nfunction calculateNetUserPnl(perpMarket, oraclePriceData) {\n    const netUserPositionValue = perpMarket.amm.baseAssetAmountWithAmm\n        .add(perpMarket.amm.baseAssetAmountWithUnsettledLp)\n        .mul(oraclePriceData.price)\n        .div(numericConstants_1.BASE_PRECISION)\n        .div(numericConstants_1.PRICE_TO_QUOTE_PRECISION);\n    const netUserCostBasis = perpMarket.amm.quoteAssetAmount\n        .add(perpMarket.amm.quoteAssetAmountWithUnsettledLp)\n        .add(perpMarket.amm.netUnsettledFundingPnl);\n    const netUserPnl = netUserPositionValue.add(netUserCostBasis);\n    return netUserPnl;\n}\nexports.calculateNetUserPnl = calculateNetUserPnl;\nfunction calculateNetUserPnlImbalance(perpMarket, spotMarket, oraclePriceData, applyFeePoolDiscount = true) {\n    const netUserPnl = calculateNetUserPnl(perpMarket, oraclePriceData);\n    const pnlPool = (0, spotBalance_1.getTokenAmount)(perpMarket.pnlPool.scaledBalance, spotMarket, types_1.SpotBalanceType.DEPOSIT);\n    let feePool = (0, spotBalance_1.getTokenAmount)(perpMarket.amm.feePool.scaledBalance, spotMarket, types_1.SpotBalanceType.DEPOSIT);\n    if (applyFeePoolDiscount) {\n        feePool = feePool.div(new anchor_1.BN(5));\n    }\n    const imbalance = netUserPnl.sub(pnlPool.add(feePool));\n    return imbalance;\n}\nexports.calculateNetUserPnlImbalance = calculateNetUserPnlImbalance;\nfunction calculateAvailablePerpLiquidity(market, mmOraclePriceData, dlob, slot) {\n    let [bids, asks] = (0, amm_1.calculateMarketOpenBidAsk)(market.amm.baseAssetReserve, market.amm.minBaseAssetReserve, market.amm.maxBaseAssetReserve, market.amm.orderStepSize);\n    asks = asks.abs();\n    for (const bid of dlob.getRestingLimitBids(market.marketIndex, slot, types_1.MarketType.PERP, mmOraclePriceData)) {\n        bids = bids.add(bid.order.baseAssetAmount.sub(bid.order.baseAssetAmountFilled));\n    }\n    for (const ask of dlob.getRestingLimitAsks(market.marketIndex, slot, types_1.MarketType.PERP, mmOraclePriceData)) {\n        asks = asks.add(ask.order.baseAssetAmount.sub(ask.order.baseAssetAmountFilled));\n    }\n    return {\n        bids: bids,\n        asks: asks,\n    };\n}\nexports.calculateAvailablePerpLiquidity = calculateAvailablePerpLiquidity;\nfunction calculatePerpMarketBaseLiquidatorFee(market, userHighLeverageMode) {\n    if (userHighLeverageMode && market.highLeverageMarginRatioMaintenance > 0) {\n        const marginRatio = market.highLeverageMarginRatioMaintenance * 100;\n        // min(liquidator_fee, .8 * high_leverage_margin_ratio_maintenance)\n        return Math.min(market.liquidatorFee, marginRatio - Math.floor(marginRatio / 5));\n    }\n    else {\n        return market.liquidatorFee;\n    }\n}\nexports.calculatePerpMarketBaseLiquidatorFee = calculatePerpMarketBaseLiquidatorFee;\n/**\n * Calculates trigger price for a perp market based on oracle price and current time\n * Implements the same logic as the Rust get_trigger_price function\n *\n * @param market - The perp market account\n * @param oraclePrice - Current oracle price (precision: PRICE_PRECISION)\n * @param now - Current timestamp in seconds\n * @returns trigger price (precision: PRICE_PRECISION)\n */\nfunction getTriggerPrice(market, oraclePrice, now, useMedianPrice) {\n    if (!useMedianPrice) {\n        return oraclePrice.abs();\n    }\n    const lastFillPrice = market.lastFillPrice;\n    // Calculate 5-minute basis\n    const markPrice5minTwap = market.amm.lastMarkPriceTwap5Min;\n    const lastOraclePriceTwap5min = market.amm.historicalOracleData.lastOraclePriceTwap5Min;\n    const basis5min = markPrice5minTwap.sub(lastOraclePriceTwap5min);\n    const oraclePlusBasis5min = oraclePrice.add(basis5min);\n    // Calculate funding basis\n    const lastFundingBasis = getLastFundingBasis(market, oraclePrice, now);\n    const oraclePlusFundingBasis = oraclePrice.add(lastFundingBasis);\n    const prices = [\n        lastFillPrice.gt(numericConstants_1.ZERO) ? lastFillPrice : oraclePrice,\n        oraclePlusFundingBasis,\n        oraclePlusBasis5min,\n    ].sort((a, b) => a.cmp(b));\n    const medianPrice = prices[1];\n    return clampTriggerPrice(market, oraclePrice.abs(), medianPrice);\n}\nexports.getTriggerPrice = getTriggerPrice;\n/**\n * Calculates the last funding basis for trigger price calculation\n * Implements the same logic as the Rust get_last_funding_basis function\n */\nfunction getLastFundingBasis(market, oraclePrice, now) {\n    if (market.amm.lastFundingOracleTwap.gt(numericConstants_1.ZERO)) {\n        const lastFundingRate = market.amm.lastFundingRate\n            .mul(numericConstants_1.PRICE_PRECISION)\n            .div(market.amm.lastFundingOracleTwap)\n            .muln(24);\n        const lastFundingRatePreAdj = lastFundingRate.sub(numericConstants_1.FUNDING_RATE_PRECISION.div(new anchor_1.BN(5000)) // FUNDING_RATE_OFFSET_PERCENTAGE\n        );\n        const timeLeftUntilFundingUpdate = anchor_1.BN.min(anchor_1.BN.max(now.sub(market.amm.lastFundingRateTs), numericConstants_1.ZERO), market.amm.fundingPeriod);\n        const lastFundingBasis = oraclePrice\n            .mul(lastFundingRatePreAdj)\n            .div(numericConstants_1.PERCENTAGE_PRECISION)\n            .mul(market.amm.fundingPeriod.sub(timeLeftUntilFundingUpdate))\n            .div(market.amm.fundingPeriod)\n            .div(new anchor_1.BN(1000)); // FUNDING_RATE_BUFFER\n        return lastFundingBasis;\n    }\n    else {\n        return numericConstants_1.ZERO;\n    }\n}\n/**\n * Clamps trigger price based on contract tier\n * Implements the same logic as the Rust clamp_trigger_price function\n */\nfunction clampTriggerPrice(market, oraclePrice, medianPrice) {\n    let maxBpsDiff;\n    const tier = market.contractTier;\n    if ((0, types_1.isVariant)(tier, 'a') || (0, types_1.isVariant)(tier, 'b')) {\n        maxBpsDiff = new anchor_1.BN(500); // 20 BPS\n    }\n    else if ((0, types_1.isVariant)(tier, 'c')) {\n        maxBpsDiff = new anchor_1.BN(100); // 100 BPS\n    }\n    else {\n        maxBpsDiff = new anchor_1.BN(40); // 250 BPS\n    }\n    const maxOracleDiff = oraclePrice.div(maxBpsDiff);\n    return anchor_1.BN.min(anchor_1.BN.max(medianPrice, oraclePrice.sub(maxOracleDiff)), oraclePrice.add(maxOracleDiff));\n}\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 1280, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/spotMarket.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.calculateMaxRemainingDeposit = exports.calculateSpotMarketMarginRatio = exports.castNumberToSpotPrecision = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst types_1 = require(\"../types\");\nconst spotBalance_1 = require(\"./spotBalance\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst utils_1 = require(\"./utils\");\nfunction castNumberToSpotPrecision(value, spotMarket) {\n    if (typeof value === 'number') {\n        return (0, utils_1.numberToSafeBN)(value, new anchor_1.BN(Math.pow(10, spotMarket.decimals)));\n    }\n    else {\n        return value.mul(new anchor_1.BN(Math.pow(10, spotMarket.decimals)));\n    }\n}\nexports.castNumberToSpotPrecision = castNumberToSpotPrecision;\nfunction calculateSpotMarketMarginRatio(market, oraclePrice, marginCategory, size, balanceType, customMarginRatio = 0) {\n    let marginRatio;\n    if ((0, types_1.isVariant)(balanceType, 'deposit')) {\n        const assetWeight = (0, spotBalance_1.calculateAssetWeight)(size, oraclePrice, market, marginCategory);\n        marginRatio = numericConstants_1.MARGIN_PRECISION.sub(assetWeight).toNumber();\n    }\n    else {\n        const liabilityWeight = (0, spotBalance_1.calculateLiabilityWeight)(size, market, marginCategory);\n        marginRatio = liabilityWeight.sub(numericConstants_1.MARGIN_PRECISION).toNumber();\n    }\n    if (marginCategory === 'Initial') {\n        // use lowest leverage between max allowed and optional user custom max\n        return Math.max(marginRatio, customMarginRatio);\n    }\n    return marginRatio;\n}\nexports.calculateSpotMarketMarginRatio = calculateSpotMarketMarginRatio;\n/**\n * Returns the maximum remaining deposit that can be made to the spot market. If the maxTokenDeposits on the market is zero then there is no limit and this function will also return zero. (so that needs to be checked)\n * @param market\n * @returns\n */\nfunction calculateMaxRemainingDeposit(market) {\n    const marketMaxTokenDeposits = market.maxTokenDeposits;\n    if (marketMaxTokenDeposits.eq(numericConstants_1.ZERO)) {\n        // If the maxTokenDeposits is set to zero then that means there is no limit. Return the largest number we can to represent infinite available deposit.\n        return numericConstants_1.ZERO;\n    }\n    const totalDepositsTokenAmount = (0, spotBalance_1.getTokenAmount)(market.depositBalance, market, types_1.SpotBalanceType.DEPOSIT);\n    return marketMaxTokenDeposits.sub(totalDepositsTokenAmount);\n}\nexports.calculateMaxRemainingDeposit = calculateMaxRemainingDeposit;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,4BAA4B,GAAG,QAAQ,8BAA8B,GAAG,QAAQ,yBAAyB,GAAG,KAAK;AACzH,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,SAAS,0BAA0B,KAAK,EAAE,UAAU;IAChD,IAAI,OAAO,UAAU,UAAU;QAC3B,OAAO,CAAC,GAAG,QAAQ,cAAc,EAAE,OAAO,IAAI,SAAS,EAAE,CAAC,KAAK,GAAG,CAAC,IAAI,WAAW,QAAQ;IAC9F,OACK;QACD,OAAO,MAAM,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,KAAK,GAAG,CAAC,IAAI,WAAW,QAAQ;IACrE;AACJ;AACA,QAAQ,yBAAyB,GAAG;AACpC,SAAS,+BAA+B,MAAM,EAAE,WAAW,EAAE,cAAc,EAAE,IAAI,EAAE,WAAW,EAAE,oBAAoB,CAAC;IACjH,IAAI;IACJ,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,aAAa,YAAY;QAChD,MAAM,cAAc,CAAC,GAAG,cAAc,oBAAoB,EAAE,MAAM,aAAa,QAAQ;QACvF,cAAc,mBAAmB,gBAAgB,CAAC,GAAG,CAAC,aAAa,QAAQ;IAC/E,OACK;QACD,MAAM,kBAAkB,CAAC,GAAG,cAAc,wBAAwB,EAAE,MAAM,QAAQ;QAClF,cAAc,gBAAgB,GAAG,CAAC,mBAAmB,gBAAgB,EAAE,QAAQ;IACnF;IACA,IAAI,mBAAmB,WAAW;QAC9B,uEAAuE;QACvE,OAAO,KAAK,GAAG,CAAC,aAAa;IACjC;IACA,OAAO;AACX;AACA,QAAQ,8BAA8B,GAAG;AACzC;;;;CAIC,GACD,SAAS,6BAA6B,MAAM;IACxC,MAAM,yBAAyB,OAAO,gBAAgB;IACtD,IAAI,uBAAuB,EAAE,CAAC,mBAAmB,IAAI,GAAG;QACpD,sJAAsJ;QACtJ,OAAO,mBAAmB,IAAI;IAClC;IACA,MAAM,2BAA2B,CAAC,GAAG,cAAc,cAAc,EAAE,OAAO,cAAc,EAAE,QAAQ,QAAQ,eAAe,CAAC,OAAO;IACjI,OAAO,uBAAuB,GAAG,CAAC;AACtC;AACA,QAAQ,4BAA4B,GAAG","ignoreList":[0]}},
    {"offset": {"line": 1331, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/trade.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getUser30dRollingVolumeEstimate = exports.calculateEstimatedEntryPriceWithL2 = exports.calculateEstimatedSpotEntryPrice = exports.calculateEstimatedPerpEntryPrice = exports.calculateTargetPriceTrade = exports.calculateTradeAcquiredAmounts = exports.calculateTradeSlippage = void 0;\nconst types_1 = require(\"../types\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst assert_1 = require(\"../assert/assert\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst market_1 = require(\"./market\");\nconst amm_1 = require(\"./amm\");\nconst utils_1 = require(\"./utils\");\nconst types_2 = require(\"../types\");\nconst MAXPCT = new anchor_1.BN(1000); //percentage units are [0,1000] => [0,1]\n/**\n * Calculates avg/max slippage (price impact) for candidate trade\n *\n * @deprecated use calculateEstimatedPerpEntryPrice instead\n *\n * @param direction\n * @param amount\n * @param market\n * @param inputAssetType which asset is being traded\n * @param useSpread whether to consider spread with calculating slippage\n * @return [pctAvgSlippage, pctMaxSlippage, entryPrice, newPrice]\n *\n * 'pctAvgSlippage' =>  the percentage change to entryPrice (average est slippage in execution) : Precision PRICE_PRECISION\n *\n * 'pctMaxSlippage' =>  the percentage change to maxPrice (highest est slippage in execution) : Precision PRICE_PRECISION\n *\n * 'entryPrice' => the average price of the trade : Precision PRICE_PRECISION\n *\n * 'newPrice' => the price of the asset after the trade : Precision PRICE_PRECISION\n */\nfunction calculateTradeSlippage(direction, amount, market, inputAssetType = 'quote', mmOraclePriceData, useSpread = true, latestSlot) {\n    let oldPrice;\n    if (useSpread && market.amm.baseSpread > 0) {\n        if ((0, types_2.isVariant)(direction, 'long')) {\n            oldPrice = (0, market_1.calculateAskPrice)(market, mmOraclePriceData);\n        }\n        else {\n            oldPrice = (0, market_1.calculateBidPrice)(market, mmOraclePriceData);\n        }\n    }\n    else {\n        oldPrice = (0, market_1.calculateReservePrice)(market, mmOraclePriceData);\n    }\n    if (amount.eq(numericConstants_1.ZERO)) {\n        return [numericConstants_1.ZERO, numericConstants_1.ZERO, oldPrice, oldPrice];\n    }\n    const [acquiredBaseReserve, acquiredQuoteReserve, acquiredQuoteAssetAmount] = calculateTradeAcquiredAmounts(direction, amount, market, inputAssetType, mmOraclePriceData, useSpread);\n    const entryPrice = acquiredQuoteAssetAmount\n        .mul(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO)\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .div(acquiredBaseReserve.abs());\n    let amm;\n    if (useSpread && market.amm.baseSpread > 0) {\n        const { baseAssetReserve, quoteAssetReserve, sqrtK, newPeg } = (0, amm_1.calculateUpdatedAMMSpreadReserves)(market.amm, direction, mmOraclePriceData, undefined, latestSlot);\n        amm = {\n            baseAssetReserve,\n            quoteAssetReserve,\n            sqrtK: sqrtK,\n            pegMultiplier: newPeg,\n        };\n    }\n    else {\n        amm = market.amm;\n    }\n    const newPrice = (0, amm_1.calculatePrice)(amm.baseAssetReserve.sub(acquiredBaseReserve), amm.quoteAssetReserve.sub(acquiredQuoteReserve), amm.pegMultiplier);\n    if (direction == types_1.PositionDirection.SHORT) {\n        (0, assert_1.assert)(newPrice.lte(oldPrice));\n    }\n    else {\n        (0, assert_1.assert)(oldPrice.lte(newPrice));\n    }\n    const pctMaxSlippage = newPrice\n        .sub(oldPrice)\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .div(oldPrice)\n        .abs();\n    const pctAvgSlippage = entryPrice\n        .sub(oldPrice)\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .div(oldPrice)\n        .abs();\n    return [pctAvgSlippage, pctMaxSlippage, entryPrice, newPrice];\n}\nexports.calculateTradeSlippage = calculateTradeSlippage;\n/**\n * Calculates acquired amounts for trade executed\n * @param direction\n * @param amount\n * @param market\n * @param inputAssetType\n * @param useSpread\n * @return\n * \t| 'acquiredBase' =>  positive/negative change in user's base : BN AMM_RESERVE_PRECISION\n * \t| 'acquiredQuote' => positive/negative change in user's quote : BN TODO-PRECISION\n */\nfunction calculateTradeAcquiredAmounts(direction, amount, market, inputAssetType = 'quote', mmOraclePriceData, useSpread = true, latestSlot) {\n    if (amount.eq(numericConstants_1.ZERO)) {\n        return [numericConstants_1.ZERO, numericConstants_1.ZERO, numericConstants_1.ZERO];\n    }\n    const swapDirection = (0, amm_1.getSwapDirection)(inputAssetType, direction);\n    let amm;\n    if (useSpread && market.amm.baseSpread > 0) {\n        const { baseAssetReserve, quoteAssetReserve, sqrtK, newPeg } = (0, amm_1.calculateUpdatedAMMSpreadReserves)(market.amm, direction, mmOraclePriceData, undefined, latestSlot);\n        amm = {\n            baseAssetReserve,\n            quoteAssetReserve,\n            sqrtK: sqrtK,\n            pegMultiplier: newPeg,\n        };\n    }\n    else {\n        amm = market.amm;\n    }\n    const [newQuoteAssetReserve, newBaseAssetReserve] = (0, amm_1.calculateAmmReservesAfterSwap)(amm, inputAssetType, amount, swapDirection);\n    const acquiredBase = amm.baseAssetReserve.sub(newBaseAssetReserve);\n    const acquiredQuote = amm.quoteAssetReserve.sub(newQuoteAssetReserve);\n    const acquiredQuoteAssetAmount = (0, amm_1.calculateQuoteAssetAmountSwapped)(acquiredQuote.abs(), amm.pegMultiplier, swapDirection);\n    return [acquiredBase, acquiredQuote, acquiredQuoteAssetAmount];\n}\nexports.calculateTradeAcquiredAmounts = calculateTradeAcquiredAmounts;\n/**\n * calculateTargetPriceTrade\n * simple function for finding arbitraging trades\n *\n * @deprecated\n *\n * @param market\n * @param targetPrice\n * @param pct optional default is 100% gap filling, can set smaller.\n * @param outputAssetType which asset to trade.\n * @param useSpread whether or not to consider the spread when calculating the trade size\n * @returns trade direction/size in order to push price to a targetPrice,\n *\n * [\n *   direction => direction of trade required, PositionDirection\n *   tradeSize => size of trade required, TODO-PRECISION\n *   entryPrice => the entry price for the trade, PRICE_PRECISION\n *   targetPrice => the target price PRICE_PRECISION\n * ]\n */\nfunction calculateTargetPriceTrade(market, targetPrice, pct = MAXPCT, outputAssetType = 'quote', mmOraclePriceData, useSpread = true, latestSlot) {\n    (0, assert_1.assert)(market.amm.baseAssetReserve.gt(numericConstants_1.ZERO));\n    (0, assert_1.assert)(targetPrice.gt(numericConstants_1.ZERO));\n    (0, assert_1.assert)(pct.lte(MAXPCT) && pct.gt(numericConstants_1.ZERO));\n    const reservePriceBefore = (0, market_1.calculateReservePrice)(market, mmOraclePriceData);\n    const bidPriceBefore = (0, market_1.calculateBidPrice)(market, mmOraclePriceData);\n    const askPriceBefore = (0, market_1.calculateAskPrice)(market, mmOraclePriceData);\n    let direction;\n    if (targetPrice.gt(reservePriceBefore)) {\n        const priceGap = targetPrice.sub(reservePriceBefore);\n        const priceGapScaled = priceGap.mul(pct).div(MAXPCT);\n        targetPrice = reservePriceBefore.add(priceGapScaled);\n        direction = types_1.PositionDirection.LONG;\n    }\n    else {\n        const priceGap = reservePriceBefore.sub(targetPrice);\n        const priceGapScaled = priceGap.mul(pct).div(MAXPCT);\n        targetPrice = reservePriceBefore.sub(priceGapScaled);\n        direction = types_1.PositionDirection.SHORT;\n    }\n    let tradeSize;\n    let baseSize;\n    let baseAssetReserveBefore;\n    let quoteAssetReserveBefore;\n    let peg = market.amm.pegMultiplier;\n    if (useSpread && market.amm.baseSpread > 0) {\n        const { baseAssetReserve, quoteAssetReserve, newPeg } = (0, amm_1.calculateUpdatedAMMSpreadReserves)(market.amm, direction, mmOraclePriceData, undefined, latestSlot);\n        baseAssetReserveBefore = baseAssetReserve;\n        quoteAssetReserveBefore = quoteAssetReserve;\n        peg = newPeg;\n    }\n    else {\n        baseAssetReserveBefore = market.amm.baseAssetReserve;\n        quoteAssetReserveBefore = market.amm.quoteAssetReserve;\n    }\n    const invariant = market.amm.sqrtK.mul(market.amm.sqrtK);\n    const k = invariant.mul(numericConstants_1.PRICE_PRECISION);\n    let baseAssetReserveAfter;\n    let quoteAssetReserveAfter;\n    const biasModifier = new anchor_1.BN(1);\n    let markPriceAfter;\n    if (useSpread &&\n        targetPrice.lt(askPriceBefore) &&\n        targetPrice.gt(bidPriceBefore)) {\n        // no trade, market is at target\n        if (reservePriceBefore.gt(targetPrice)) {\n            direction = types_1.PositionDirection.SHORT;\n        }\n        else {\n            direction = types_1.PositionDirection.LONG;\n        }\n        tradeSize = numericConstants_1.ZERO;\n        return [direction, tradeSize, targetPrice, targetPrice];\n    }\n    else if (reservePriceBefore.gt(targetPrice)) {\n        // overestimate y2\n        baseAssetReserveAfter = (0, utils_1.squareRootBN)(k.div(targetPrice).mul(peg).div(numericConstants_1.PEG_PRECISION).sub(biasModifier)).sub(new anchor_1.BN(1));\n        quoteAssetReserveAfter = k.div(numericConstants_1.PRICE_PRECISION).div(baseAssetReserveAfter);\n        markPriceAfter = (0, amm_1.calculatePrice)(baseAssetReserveAfter, quoteAssetReserveAfter, peg);\n        direction = types_1.PositionDirection.SHORT;\n        tradeSize = quoteAssetReserveBefore\n            .sub(quoteAssetReserveAfter)\n            .mul(peg)\n            .div(numericConstants_1.PEG_PRECISION)\n            .div(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO);\n        baseSize = baseAssetReserveAfter.sub(baseAssetReserveBefore);\n    }\n    else if (reservePriceBefore.lt(targetPrice)) {\n        // underestimate y2\n        baseAssetReserveAfter = (0, utils_1.squareRootBN)(k.div(targetPrice).mul(peg).div(numericConstants_1.PEG_PRECISION).add(biasModifier)).add(new anchor_1.BN(1));\n        quoteAssetReserveAfter = k.div(numericConstants_1.PRICE_PRECISION).div(baseAssetReserveAfter);\n        markPriceAfter = (0, amm_1.calculatePrice)(baseAssetReserveAfter, quoteAssetReserveAfter, peg);\n        direction = types_1.PositionDirection.LONG;\n        tradeSize = quoteAssetReserveAfter\n            .sub(quoteAssetReserveBefore)\n            .mul(peg)\n            .div(numericConstants_1.PEG_PRECISION)\n            .div(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO);\n        baseSize = baseAssetReserveBefore.sub(baseAssetReserveAfter);\n    }\n    else {\n        // no trade, market is at target\n        direction = types_1.PositionDirection.LONG;\n        tradeSize = numericConstants_1.ZERO;\n        return [direction, tradeSize, targetPrice, targetPrice];\n    }\n    let tp1 = targetPrice;\n    let tp2 = markPriceAfter;\n    let originalDiff = targetPrice.sub(reservePriceBefore);\n    if (direction == types_1.PositionDirection.SHORT) {\n        tp1 = markPriceAfter;\n        tp2 = targetPrice;\n        originalDiff = reservePriceBefore.sub(targetPrice);\n    }\n    const entryPrice = tradeSize\n        .mul(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO)\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .div(baseSize.abs());\n    (0, assert_1.assert)(tp1.sub(tp2).lte(originalDiff), 'Target Price Calculation incorrect');\n    (0, assert_1.assert)(tp2.lte(tp1) || tp2.sub(tp1).abs() < 100000, 'Target Price Calculation incorrect' +\n        tp2.toString() +\n        '>=' +\n        tp1.toString() +\n        'err: ' +\n        tp2.sub(tp1).abs().toString());\n    if (outputAssetType == 'quote') {\n        return [direction, tradeSize, entryPrice, targetPrice];\n    }\n    else {\n        return [direction, baseSize, entryPrice, targetPrice];\n    }\n}\nexports.calculateTargetPriceTrade = calculateTargetPriceTrade;\n/**\n * Calculates the estimated entry price and price impact of order, in base or quote\n * Price impact is based on the difference between the entry price and the best bid/ask price (whether it's dlob or vamm)\n *\n * @param assetType\n * @param amount\n * @param direction\n * @param market\n * @param oraclePriceData\n * @param dlob\n * @param slot\n * @param usersToSkip\n */\nfunction calculateEstimatedPerpEntryPrice(assetType, amount, direction, market, mmOraclePriceData, dlob, slot, usersToSkip = new Map()) {\n    if (amount.eq(numericConstants_1.ZERO)) {\n        return {\n            entryPrice: numericConstants_1.ZERO,\n            priceImpact: numericConstants_1.ZERO,\n            bestPrice: numericConstants_1.ZERO,\n            worstPrice: numericConstants_1.ZERO,\n            baseFilled: numericConstants_1.ZERO,\n            quoteFilled: numericConstants_1.ZERO,\n        };\n    }\n    const takerIsLong = (0, types_2.isVariant)(direction, 'long');\n    const limitOrders = dlob[takerIsLong ? 'getRestingLimitAsks' : 'getRestingLimitBids'](market.marketIndex, slot, types_1.MarketType.PERP, mmOraclePriceData);\n    const swapDirection = (0, amm_1.getSwapDirection)(assetType, direction);\n    const { baseAssetReserve, quoteAssetReserve, sqrtK, newPeg } = (0, amm_1.calculateUpdatedAMMSpreadReserves)(market.amm, direction, mmOraclePriceData, undefined, new anchor_1.BN(slot));\n    const amm = {\n        baseAssetReserve,\n        quoteAssetReserve,\n        sqrtK: sqrtK,\n        pegMultiplier: newPeg,\n    };\n    const [ammBids, ammAsks] = (0, amm_1.calculateMarketOpenBidAsk)(market.amm.baseAssetReserve, market.amm.minBaseAssetReserve, market.amm.maxBaseAssetReserve, market.amm.orderStepSize);\n    let ammLiquidity;\n    if (assetType === 'base') {\n        ammLiquidity = takerIsLong ? ammAsks.abs() : ammBids;\n    }\n    else {\n        const [afterSwapQuoteReserves, _] = (0, amm_1.calculateAmmReservesAfterSwap)(amm, 'base', takerIsLong ? ammAsks.abs() : ammBids, (0, amm_1.getSwapDirection)('base', direction));\n        ammLiquidity = (0, amm_1.calculateQuoteAssetAmountSwapped)(amm.quoteAssetReserve.sub(afterSwapQuoteReserves).abs(), amm.pegMultiplier, swapDirection);\n    }\n    const invariant = amm.sqrtK.mul(amm.sqrtK);\n    let bestPrice = (0, amm_1.calculatePrice)(amm.baseAssetReserve, amm.quoteAssetReserve, amm.pegMultiplier);\n    let cumulativeBaseFilled = numericConstants_1.ZERO;\n    let cumulativeQuoteFilled = numericConstants_1.ZERO;\n    let limitOrder = limitOrders.next().value;\n    if (limitOrder) {\n        const limitOrderPrice = limitOrder.getPrice(mmOraclePriceData, slot);\n        bestPrice = takerIsLong\n            ? anchor_1.BN.min(limitOrderPrice, bestPrice)\n            : anchor_1.BN.max(limitOrderPrice, bestPrice);\n    }\n    let worstPrice = bestPrice;\n    if (assetType === 'base') {\n        while (!cumulativeBaseFilled.eq(amount) &&\n            (ammLiquidity.gt(numericConstants_1.ZERO) || limitOrder)) {\n            const limitOrderPrice = limitOrder === null || limitOrder === void 0 ? void 0 : limitOrder.getPrice(mmOraclePriceData, slot);\n            let maxAmmFill;\n            if (limitOrderPrice) {\n                const newBaseReserves = (0, utils_1.squareRootBN)(invariant\n                    .mul(numericConstants_1.PRICE_PRECISION)\n                    .mul(amm.pegMultiplier)\n                    .div(limitOrderPrice)\n                    .div(numericConstants_1.PEG_PRECISION));\n                // will be zero if the limit order price is better than the amm price\n                maxAmmFill = takerIsLong\n                    ? amm.baseAssetReserve.sub(newBaseReserves)\n                    : newBaseReserves.sub(amm.baseAssetReserve);\n            }\n            else {\n                maxAmmFill = amount.sub(cumulativeBaseFilled);\n            }\n            maxAmmFill = anchor_1.BN.min(maxAmmFill, ammLiquidity);\n            if (maxAmmFill.gt(numericConstants_1.ZERO)) {\n                const baseFilled = anchor_1.BN.min(amount.sub(cumulativeBaseFilled), maxAmmFill);\n                const [afterSwapQuoteReserves, afterSwapBaseReserves] = (0, amm_1.calculateAmmReservesAfterSwap)(amm, 'base', baseFilled, swapDirection);\n                ammLiquidity = ammLiquidity.sub(baseFilled);\n                const quoteFilled = (0, amm_1.calculateQuoteAssetAmountSwapped)(amm.quoteAssetReserve.sub(afterSwapQuoteReserves).abs(), amm.pegMultiplier, swapDirection);\n                cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n                cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n                amm.baseAssetReserve = afterSwapBaseReserves;\n                amm.quoteAssetReserve = afterSwapQuoteReserves;\n                worstPrice = (0, amm_1.calculatePrice)(amm.baseAssetReserve, amm.quoteAssetReserve, amm.pegMultiplier);\n                if (cumulativeBaseFilled.eq(amount)) {\n                    break;\n                }\n            }\n            if (!limitOrder) {\n                continue;\n            }\n            if (usersToSkip.has(limitOrder.userAccount)) {\n                continue;\n            }\n            const baseFilled = anchor_1.BN.min(limitOrder.order.baseAssetAmount.sub(limitOrder.order.baseAssetAmountFilled), amount.sub(cumulativeBaseFilled));\n            const quoteFilled = baseFilled.mul(limitOrderPrice).div(numericConstants_1.BASE_PRECISION);\n            cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n            cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n            worstPrice = limitOrderPrice;\n            if (cumulativeBaseFilled.eq(amount)) {\n                break;\n            }\n            limitOrder = limitOrders.next().value;\n        }\n    }\n    else {\n        while (!cumulativeQuoteFilled.eq(amount) &&\n            (ammLiquidity.gt(numericConstants_1.ZERO) || limitOrder)) {\n            const limitOrderPrice = limitOrder === null || limitOrder === void 0 ? void 0 : limitOrder.getPrice(mmOraclePriceData, slot);\n            let maxAmmFill;\n            if (limitOrderPrice) {\n                const newQuoteReserves = (0, utils_1.squareRootBN)(invariant\n                    .mul(numericConstants_1.PEG_PRECISION)\n                    .mul(limitOrderPrice)\n                    .div(amm.pegMultiplier)\n                    .div(numericConstants_1.PRICE_PRECISION));\n                // will be zero if the limit order price is better than the amm price\n                maxAmmFill = takerIsLong\n                    ? newQuoteReserves.sub(amm.quoteAssetReserve)\n                    : amm.quoteAssetReserve.sub(newQuoteReserves);\n            }\n            else {\n                maxAmmFill = amount.sub(cumulativeQuoteFilled);\n            }\n            maxAmmFill = anchor_1.BN.min(maxAmmFill, ammLiquidity);\n            if (maxAmmFill.gt(numericConstants_1.ZERO)) {\n                const quoteFilled = anchor_1.BN.min(amount.sub(cumulativeQuoteFilled), maxAmmFill);\n                const [afterSwapQuoteReserves, afterSwapBaseReserves] = (0, amm_1.calculateAmmReservesAfterSwap)(amm, 'quote', quoteFilled, swapDirection);\n                ammLiquidity = ammLiquidity.sub(quoteFilled);\n                const baseFilled = afterSwapBaseReserves\n                    .sub(amm.baseAssetReserve)\n                    .abs();\n                cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n                cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n                amm.baseAssetReserve = afterSwapBaseReserves;\n                amm.quoteAssetReserve = afterSwapQuoteReserves;\n                worstPrice = (0, amm_1.calculatePrice)(amm.baseAssetReserve, amm.quoteAssetReserve, amm.pegMultiplier);\n                if (cumulativeQuoteFilled.eq(amount)) {\n                    break;\n                }\n            }\n            if (!limitOrder) {\n                continue;\n            }\n            if (usersToSkip.has(limitOrder.userAccount)) {\n                continue;\n            }\n            const quoteFilled = anchor_1.BN.min(limitOrder.order.baseAssetAmount\n                .sub(limitOrder.order.baseAssetAmountFilled)\n                .mul(limitOrderPrice)\n                .div(numericConstants_1.BASE_PRECISION), amount.sub(cumulativeQuoteFilled));\n            const baseFilled = quoteFilled.mul(numericConstants_1.BASE_PRECISION).div(limitOrderPrice);\n            cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n            cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n            worstPrice = limitOrderPrice;\n            if (cumulativeQuoteFilled.eq(amount)) {\n                break;\n            }\n            limitOrder = limitOrders.next().value;\n        }\n    }\n    const entryPrice = cumulativeBaseFilled && cumulativeBaseFilled.gt(numericConstants_1.ZERO)\n        ? cumulativeQuoteFilled.mul(numericConstants_1.BASE_PRECISION).div(cumulativeBaseFilled)\n        : numericConstants_1.ZERO;\n    const priceImpact = bestPrice && bestPrice.gt(numericConstants_1.ZERO)\n        ? entryPrice.sub(bestPrice).mul(numericConstants_1.PRICE_PRECISION).div(bestPrice).abs()\n        : numericConstants_1.ZERO;\n    return {\n        entryPrice,\n        priceImpact,\n        bestPrice,\n        worstPrice,\n        baseFilled: cumulativeBaseFilled,\n        quoteFilled: cumulativeQuoteFilled,\n    };\n}\nexports.calculateEstimatedPerpEntryPrice = calculateEstimatedPerpEntryPrice;\n/**\n * Calculates the estimated entry price and price impact of order, in base or quote\n * Price impact is based on the difference between the entry price and the best bid/ask price (whether it's dlob or serum)\n *\n * @param assetType\n * @param amount\n * @param direction\n * @param market\n * @param oraclePriceData\n * @param dlob\n * @param serumBids\n * @param serumAsks\n * @param slot\n * @param usersToSkip\n */\nfunction calculateEstimatedSpotEntryPrice(assetType, amount, direction, market, oraclePriceData, dlob, serumBids, serumAsks, slot, usersToSkip = new Map()) {\n    if (amount.eq(numericConstants_1.ZERO)) {\n        return {\n            entryPrice: numericConstants_1.ZERO,\n            priceImpact: numericConstants_1.ZERO,\n            bestPrice: numericConstants_1.ZERO,\n            worstPrice: numericConstants_1.ZERO,\n            baseFilled: numericConstants_1.ZERO,\n            quoteFilled: numericConstants_1.ZERO,\n        };\n    }\n    const basePrecision = new anchor_1.BN(Math.pow(10, market.decimals));\n    const takerIsLong = (0, types_2.isVariant)(direction, 'long');\n    const dlobLimitOrders = dlob[takerIsLong ? 'getRestingLimitAsks' : 'getRestingLimitBids'](market.marketIndex, slot, types_1.MarketType.SPOT, oraclePriceData);\n    const serumLimitOrders = takerIsLong\n        ? serumAsks.getL2(100)\n        : serumBids.getL2(100);\n    let cumulativeBaseFilled = numericConstants_1.ZERO;\n    let cumulativeQuoteFilled = numericConstants_1.ZERO;\n    let dlobLimitOrder = dlobLimitOrders.next().value;\n    let serumLimitOrder = serumLimitOrders.shift();\n    const dlobLimitOrderPrice = dlobLimitOrder === null || dlobLimitOrder === void 0 ? void 0 : dlobLimitOrder.getPrice(oraclePriceData, slot);\n    const serumLimitOrderPrice = serumLimitOrder\n        ? new anchor_1.BN(serumLimitOrder[0] * numericConstants_1.PRICE_PRECISION.toNumber())\n        : undefined;\n    const bestPrice = takerIsLong\n        ? anchor_1.BN.min(serumLimitOrderPrice || numericConstants_1.BN_MAX, dlobLimitOrderPrice || numericConstants_1.BN_MAX)\n        : anchor_1.BN.max(serumLimitOrderPrice || numericConstants_1.ZERO, dlobLimitOrderPrice || numericConstants_1.ZERO);\n    let worstPrice = bestPrice;\n    if (assetType === 'base') {\n        while (!cumulativeBaseFilled.eq(amount) &&\n            (dlobLimitOrder || serumLimitOrder)) {\n            const dlobLimitOrderPrice = dlobLimitOrder === null || dlobLimitOrder === void 0 ? void 0 : dlobLimitOrder.getPrice(oraclePriceData, slot);\n            const serumLimitOrderPrice = serumLimitOrder\n                ? new anchor_1.BN(serumLimitOrder[0] * numericConstants_1.PRICE_PRECISION.toNumber())\n                : undefined;\n            const useSerum = takerIsLong\n                ? (serumLimitOrderPrice || numericConstants_1.BN_MAX).lt(dlobLimitOrderPrice || numericConstants_1.BN_MAX)\n                : (serumLimitOrderPrice || numericConstants_1.ZERO).gt(dlobLimitOrderPrice || numericConstants_1.ZERO);\n            if (!useSerum) {\n                if (dlobLimitOrder && usersToSkip.has(dlobLimitOrder.userAccount)) {\n                    continue;\n                }\n                const baseFilled = anchor_1.BN.min(dlobLimitOrder.order.baseAssetAmount.sub(dlobLimitOrder.order.baseAssetAmountFilled), amount.sub(cumulativeBaseFilled));\n                const quoteFilled = baseFilled\n                    .mul(dlobLimitOrderPrice)\n                    .div(basePrecision);\n                cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n                cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n                worstPrice = dlobLimitOrderPrice;\n                dlobLimitOrder = dlobLimitOrders.next().value;\n            }\n            else {\n                const baseFilled = anchor_1.BN.min(new anchor_1.BN(serumLimitOrder[1] * basePrecision.toNumber()), amount.sub(cumulativeBaseFilled));\n                const quoteFilled = baseFilled\n                    .mul(serumLimitOrderPrice)\n                    .div(basePrecision);\n                cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n                cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n                worstPrice = serumLimitOrderPrice;\n                serumLimitOrder = serumLimitOrders.shift();\n            }\n        }\n    }\n    else {\n        while (!cumulativeQuoteFilled.eq(amount) &&\n            (dlobLimitOrder || serumLimitOrder)) {\n            const dlobLimitOrderPrice = dlobLimitOrder === null || dlobLimitOrder === void 0 ? void 0 : dlobLimitOrder.getPrice(oraclePriceData, slot);\n            const serumLimitOrderPrice = serumLimitOrder\n                ? new anchor_1.BN(serumLimitOrder[0] * numericConstants_1.PRICE_PRECISION.toNumber())\n                : undefined;\n            const useSerum = takerIsLong\n                ? (serumLimitOrderPrice || numericConstants_1.BN_MAX).lt(dlobLimitOrderPrice || numericConstants_1.BN_MAX)\n                : (serumLimitOrderPrice || numericConstants_1.ZERO).gt(dlobLimitOrderPrice || numericConstants_1.ZERO);\n            if (!useSerum) {\n                if (dlobLimitOrder && usersToSkip.has(dlobLimitOrder.userAccount)) {\n                    continue;\n                }\n                const quoteFilled = anchor_1.BN.min(dlobLimitOrder.order.baseAssetAmount\n                    .sub(dlobLimitOrder.order.baseAssetAmountFilled)\n                    .mul(dlobLimitOrderPrice)\n                    .div(basePrecision), amount.sub(cumulativeQuoteFilled));\n                const baseFilled = quoteFilled\n                    .mul(basePrecision)\n                    .div(dlobLimitOrderPrice);\n                cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n                cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n                worstPrice = dlobLimitOrderPrice;\n                dlobLimitOrder = dlobLimitOrders.next().value;\n            }\n            else {\n                const serumOrderBaseAmount = new anchor_1.BN(serumLimitOrder[1] * basePrecision.toNumber());\n                const quoteFilled = anchor_1.BN.min(serumOrderBaseAmount.mul(serumLimitOrderPrice).div(basePrecision), amount.sub(cumulativeQuoteFilled));\n                const baseFilled = quoteFilled\n                    .mul(basePrecision)\n                    .div(serumLimitOrderPrice);\n                cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n                cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n                worstPrice = serumLimitOrderPrice;\n                serumLimitOrder = serumLimitOrders.shift();\n            }\n        }\n    }\n    const entryPrice = cumulativeBaseFilled && cumulativeBaseFilled.gt(numericConstants_1.ZERO)\n        ? cumulativeQuoteFilled.mul(basePrecision).div(cumulativeBaseFilled)\n        : numericConstants_1.ZERO;\n    const priceImpact = bestPrice && bestPrice.gt(numericConstants_1.ZERO)\n        ? entryPrice.sub(bestPrice).mul(numericConstants_1.PRICE_PRECISION).div(bestPrice).abs()\n        : numericConstants_1.ZERO;\n    return {\n        entryPrice,\n        priceImpact,\n        bestPrice,\n        worstPrice,\n        baseFilled: cumulativeBaseFilled,\n        quoteFilled: cumulativeQuoteFilled,\n    };\n}\nexports.calculateEstimatedSpotEntryPrice = calculateEstimatedSpotEntryPrice;\nfunction calculateEstimatedEntryPriceWithL2(assetType, amount, direction, basePrecision, l2) {\n    const takerIsLong = (0, types_2.isVariant)(direction, 'long');\n    let cumulativeBaseFilled = numericConstants_1.ZERO;\n    let cumulativeQuoteFilled = numericConstants_1.ZERO;\n    const levels = [...(takerIsLong ? l2.asks : l2.bids)];\n    let nextLevel = levels.shift();\n    let bestPrice;\n    let worstPrice;\n    if (nextLevel) {\n        bestPrice = nextLevel.price;\n        worstPrice = nextLevel.price;\n    }\n    else {\n        bestPrice = takerIsLong ? numericConstants_1.BN_MAX : numericConstants_1.ZERO;\n        worstPrice = bestPrice;\n    }\n    if (assetType === 'base') {\n        while (!cumulativeBaseFilled.eq(amount) && nextLevel) {\n            const price = nextLevel.price;\n            const size = nextLevel.size;\n            worstPrice = price;\n            const baseFilled = anchor_1.BN.min(size, amount.sub(cumulativeBaseFilled));\n            const quoteFilled = baseFilled.mul(price).div(basePrecision);\n            cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n            cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n            nextLevel = levels.shift();\n        }\n    }\n    else {\n        while (!cumulativeQuoteFilled.eq(amount) && nextLevel) {\n            const price = nextLevel.price;\n            const size = nextLevel.size;\n            worstPrice = price;\n            const quoteFilled = anchor_1.BN.min(size.mul(price).div(basePrecision), amount.sub(cumulativeQuoteFilled));\n            const baseFilled = quoteFilled.mul(basePrecision).div(price);\n            cumulativeBaseFilled = cumulativeBaseFilled.add(baseFilled);\n            cumulativeQuoteFilled = cumulativeQuoteFilled.add(quoteFilled);\n            nextLevel = levels.shift();\n        }\n    }\n    const entryPrice = cumulativeBaseFilled && cumulativeBaseFilled.gt(numericConstants_1.ZERO)\n        ? cumulativeQuoteFilled.mul(basePrecision).div(cumulativeBaseFilled)\n        : numericConstants_1.ZERO;\n    const priceImpact = bestPrice && bestPrice.gt(numericConstants_1.ZERO)\n        ? entryPrice.sub(bestPrice).mul(numericConstants_1.PRICE_PRECISION).div(bestPrice).abs()\n        : numericConstants_1.ZERO;\n    return {\n        entryPrice,\n        priceImpact,\n        bestPrice,\n        worstPrice,\n        baseFilled: cumulativeBaseFilled,\n        quoteFilled: cumulativeQuoteFilled,\n    };\n}\nexports.calculateEstimatedEntryPriceWithL2 = calculateEstimatedEntryPriceWithL2;\nfunction getUser30dRollingVolumeEstimate(userStatsAccount, now) {\n    now = now || new anchor_1.BN(new Date().getTime() / 1000);\n    const sinceLastTaker = anchor_1.BN.max(now.sub(userStatsAccount.lastTakerVolume30DTs), numericConstants_1.ZERO);\n    const sinceLastMaker = anchor_1.BN.max(now.sub(userStatsAccount.lastMakerVolume30DTs), numericConstants_1.ZERO);\n    const thirtyDaysInSeconds = new anchor_1.BN(60 * 60 * 24 * 30);\n    const last30dVolume = userStatsAccount.takerVolume30D\n        .mul(anchor_1.BN.max(thirtyDaysInSeconds.sub(sinceLastTaker), numericConstants_1.ZERO))\n        .div(thirtyDaysInSeconds)\n        .add(userStatsAccount.makerVolume30D\n        .mul(anchor_1.BN.max(thirtyDaysInSeconds.sub(sinceLastMaker), numericConstants_1.ZERO))\n        .div(thirtyDaysInSeconds));\n    return last30dVolume;\n}\nexports.getUser30dRollingVolumeEstimate = getUser30dRollingVolumeEstimate;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 1893, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/spotPosition.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.simulateOrderFill = exports.calculateWeightedTokenValue = exports.getWorstCaseTokenAmounts = exports.isSpotPositionAvailable = void 0;\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst spotBalance_1 = require(\"./spotBalance\");\nfunction isSpotPositionAvailable(position) {\n    return position.scaledBalance.eq(numericConstants_1.ZERO) && position.openOrders === 0;\n}\nexports.isSpotPositionAvailable = isSpotPositionAvailable;\nfunction getWorstCaseTokenAmounts(spotPosition, spotMarketAccount, strictOraclePrice, marginCategory, customMarginRatio) {\n    const tokenAmount = (0, spotBalance_1.getSignedTokenAmount)((0, spotBalance_1.getTokenAmount)(spotPosition.scaledBalance, spotMarketAccount, spotPosition.balanceType), spotPosition.balanceType);\n    const tokenValue = (0, spotBalance_1.getStrictTokenValue)(tokenAmount, spotMarketAccount.decimals, strictOraclePrice);\n    if (spotPosition.openBids.eq(numericConstants_1.ZERO) && spotPosition.openAsks.eq(numericConstants_1.ZERO)) {\n        const { weight, weightedTokenValue } = calculateWeightedTokenValue(tokenAmount, tokenValue, strictOraclePrice.current, spotMarketAccount, marginCategory, customMarginRatio);\n        return {\n            tokenAmount,\n            ordersValue: numericConstants_1.ZERO,\n            tokenValue,\n            weight,\n            weightedTokenValue,\n            freeCollateralContribution: weightedTokenValue,\n        };\n    }\n    const bidsSimulation = simulateOrderFill(tokenAmount, tokenValue, spotPosition.openBids, strictOraclePrice, spotMarketAccount, marginCategory, customMarginRatio);\n    const asksSimulation = simulateOrderFill(tokenAmount, tokenValue, spotPosition.openAsks, strictOraclePrice, spotMarketAccount, marginCategory, customMarginRatio);\n    if (asksSimulation.freeCollateralContribution.lt(bidsSimulation.freeCollateralContribution)) {\n        return asksSimulation;\n    }\n    else {\n        return bidsSimulation;\n    }\n}\nexports.getWorstCaseTokenAmounts = getWorstCaseTokenAmounts;\nfunction calculateWeightedTokenValue(tokenAmount, tokenValue, oraclePrice, spotMarket, marginCategory, customMarginRatio) {\n    let weight;\n    if (tokenValue.gte(numericConstants_1.ZERO)) {\n        weight = (0, spotBalance_1.calculateAssetWeight)(tokenAmount, oraclePrice, spotMarket, marginCategory);\n    }\n    else {\n        weight = (0, spotBalance_1.calculateLiabilityWeight)(tokenAmount.abs(), spotMarket, marginCategory);\n    }\n    if (marginCategory === 'Initial' &&\n        customMarginRatio &&\n        spotMarket.marketIndex !== numericConstants_1.QUOTE_SPOT_MARKET_INDEX) {\n        const userCustomAssetWeight = tokenValue.gte(numericConstants_1.ZERO)\n            ? anchor_1.BN.max(numericConstants_1.ZERO, numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION.subn(customMarginRatio))\n            : numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION.addn(customMarginRatio);\n        weight = tokenValue.gte(numericConstants_1.ZERO)\n            ? anchor_1.BN.min(weight, userCustomAssetWeight)\n            : anchor_1.BN.max(weight, userCustomAssetWeight);\n    }\n    return {\n        weight: weight,\n        weightedTokenValue: tokenValue\n            .mul(weight)\n            .div(numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION),\n    };\n}\nexports.calculateWeightedTokenValue = calculateWeightedTokenValue;\nfunction simulateOrderFill(tokenAmount, tokenValue, openOrders, strictOraclePrice, spotMarket, marginCategory, customMarginRatio) {\n    const ordersValue = (0, spotBalance_1.getTokenValue)(openOrders.neg(), spotMarket.decimals, {\n        price: strictOraclePrice.max(),\n    });\n    const tokenAmountAfterFill = tokenAmount.add(openOrders);\n    const tokenValueAfterFill = tokenValue.add(ordersValue.neg());\n    const { weight, weightedTokenValue: weightedTokenValueAfterFill } = calculateWeightedTokenValue(tokenAmountAfterFill, tokenValueAfterFill, strictOraclePrice.current, spotMarket, marginCategory, customMarginRatio);\n    const freeCollateralContribution = weightedTokenValueAfterFill.add(ordersValue);\n    return {\n        tokenAmount: tokenAmountAfterFill,\n        ordersValue: ordersValue,\n        tokenValue: tokenValueAfterFill,\n        weight,\n        weightedTokenValue: weightedTokenValueAfterFill,\n        freeCollateralContribution,\n    };\n}\nexports.simulateOrderFill = simulateOrderFill;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 1966, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/fuel.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.calculatePerpFuelBonus = exports.calculateSpotFuelBonus = exports.calculateInsuranceFuelBonus = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nfunction calculateInsuranceFuelBonus(spotMarket, tokenStakeAmount, fuelBonusNumerator) {\n    const result = tokenStakeAmount\n        .abs()\n        .mul(fuelBonusNumerator)\n        .mul(new anchor_1.BN(spotMarket.fuelBoostInsurance))\n        .div(numericConstants_1.FUEL_WINDOW)\n        .div(numericConstants_1.QUOTE_PRECISION.div(new anchor_1.BN(10)));\n    return result;\n}\nexports.calculateInsuranceFuelBonus = calculateInsuranceFuelBonus;\nfunction calculateSpotFuelBonus(spotMarket, signedTokenValue, fuelBonusNumerator) {\n    let result;\n    if (signedTokenValue.abs().lte(numericConstants_1.QUOTE_PRECISION)) {\n        result = numericConstants_1.ZERO;\n    }\n    else if (signedTokenValue.gt(new anchor_1.BN(0))) {\n        result = signedTokenValue\n            .abs()\n            .mul(fuelBonusNumerator)\n            .mul(new anchor_1.BN(spotMarket.fuelBoostDeposits))\n            .div(numericConstants_1.FUEL_WINDOW)\n            .div(numericConstants_1.QUOTE_PRECISION.div(new anchor_1.BN(10)));\n    }\n    else {\n        result = signedTokenValue\n            .abs()\n            .mul(fuelBonusNumerator)\n            .mul(new anchor_1.BN(spotMarket.fuelBoostBorrows))\n            .div(numericConstants_1.FUEL_WINDOW)\n            .div(numericConstants_1.QUOTE_PRECISION.div(new anchor_1.BN(10)));\n    }\n    return result;\n}\nexports.calculateSpotFuelBonus = calculateSpotFuelBonus;\nfunction calculatePerpFuelBonus(perpMarket, baseAssetValue, fuelBonusNumerator) {\n    let result;\n    if (baseAssetValue.abs().lte(numericConstants_1.QUOTE_PRECISION)) {\n        result = new anchor_1.BN(0);\n    }\n    else {\n        result = baseAssetValue\n            .abs()\n            .mul(fuelBonusNumerator)\n            .mul(new anchor_1.BN(perpMarket.fuelBoostPosition))\n            .div(numericConstants_1.FUEL_WINDOW)\n            .div(numericConstants_1.QUOTE_PRECISION.div(new anchor_1.BN(10)));\n    }\n    return result;\n}\nexports.calculatePerpFuelBonus = calculatePerpFuelBonus;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,sBAAsB,GAAG,QAAQ,sBAAsB,GAAG,QAAQ,2BAA2B,GAAG,KAAK;AAC7G,MAAM;AACN,MAAM;AACN,SAAS,4BAA4B,UAAU,EAAE,gBAAgB,EAAE,kBAAkB;IACjF,MAAM,SAAS,iBACV,GAAG,GACH,GAAG,CAAC,oBACJ,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,WAAW,kBAAkB,GACjD,GAAG,CAAC,mBAAmB,WAAW,EAClC,GAAG,CAAC,mBAAmB,eAAe,CAAC,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC;IAChE,OAAO;AACX;AACA,QAAQ,2BAA2B,GAAG;AACtC,SAAS,uBAAuB,UAAU,EAAE,gBAAgB,EAAE,kBAAkB;IAC5E,IAAI;IACJ,IAAI,iBAAiB,GAAG,GAAG,GAAG,CAAC,mBAAmB,eAAe,GAAG;QAChE,SAAS,mBAAmB,IAAI;IACpC,OACK,IAAI,iBAAiB,EAAE,CAAC,IAAI,SAAS,EAAE,CAAC,KAAK;QAC9C,SAAS,iBACJ,GAAG,GACH,GAAG,CAAC,oBACJ,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,WAAW,iBAAiB,GAChD,GAAG,CAAC,mBAAmB,WAAW,EAClC,GAAG,CAAC,mBAAmB,eAAe,CAAC,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC;IACpE,OACK;QACD,SAAS,iBACJ,GAAG,GACH,GAAG,CAAC,oBACJ,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,WAAW,gBAAgB,GAC/C,GAAG,CAAC,mBAAmB,WAAW,EAClC,GAAG,CAAC,mBAAmB,eAAe,CAAC,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC;IACpE;IACA,OAAO;AACX;AACA,QAAQ,sBAAsB,GAAG;AACjC,SAAS,uBAAuB,UAAU,EAAE,cAAc,EAAE,kBAAkB;IAC1E,IAAI;IACJ,IAAI,eAAe,GAAG,GAAG,GAAG,CAAC,mBAAmB,eAAe,GAAG;QAC9D,SAAS,IAAI,SAAS,EAAE,CAAC;IAC7B,OACK;QACD,SAAS,eACJ,GAAG,GACH,GAAG,CAAC,oBACJ,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,WAAW,iBAAiB,GAChD,GAAG,CAAC,mBAAmB,WAAW,EAClC,GAAG,CAAC,mBAAmB,eAAe,CAAC,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC;IACpE;IACA,OAAO;AACX;AACA,QAAQ,sBAAsB,GAAG","ignoreList":[0]}},
    {"offset": {"line": 2003, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/margin.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.calcHighLeverageModeInitialMarginRatioFromSize = exports.calculateUserMaxPerpOrderSize = exports.calculateLiquidationPrice = exports.calculateCollateralValueOfDeposit = exports.calculateCollateralDepositRequiredForTrade = exports.calculateMarginUSDCRequiredForTrade = exports.calculatePerpLiabilityValue = exports.calculateWorstCasePerpLiabilityValue = exports.calculateWorstCaseBaseAssetAmount = exports.calculateBaseAssetValueWithOracle = exports.calculateOraclePriceForPerpMargin = exports.calculateSizeDiscountAssetWeight = exports.calculateSizePremiumLiabilityWeight = void 0;\nconst utils_1 = require(\"./utils\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst market_1 = require(\"./market\");\nconst spotBalance_1 = require(\"./spotBalance\");\nconst oneShotUserAccountSubscriber_1 = require(\"../accounts/oneShotUserAccountSubscriber\");\nconst user_1 = require(\"../user\");\nconst types_1 = require(\"../types\");\nconst assert_1 = require(\"../assert/assert\");\nfunction calculateSizePremiumLiabilityWeight(size, // AMM_RESERVE_PRECISION\nimfFactor, liabilityWeight, precision, isBounded = true) {\n    if (imfFactor.eq(numericConstants_1.ZERO)) {\n        return liabilityWeight;\n    }\n    const sizeSqrt = (0, utils_1.squareRootBN)(size.abs().mul(new anchor_1.BN(10)).add(new anchor_1.BN(1))); //1e9 -> 1e10 -> 1e5\n    const liabilityWeightNumerator = liabilityWeight.sub(liabilityWeight.div(new anchor_1.BN(5)));\n    const denom = new anchor_1.BN(100000).mul(numericConstants_1.SPOT_MARKET_IMF_PRECISION).div(precision);\n    (0, assert_1.assert)(denom.gt(numericConstants_1.ZERO));\n    const sizePremiumLiabilityWeight = liabilityWeightNumerator.add(sizeSqrt // 1e5\n        .mul(imfFactor)\n        .div(denom) // 1e5\n    );\n    let maxLiabilityWeight;\n    if (isBounded) {\n        maxLiabilityWeight = anchor_1.BN.max(liabilityWeight, sizePremiumLiabilityWeight);\n    }\n    else {\n        maxLiabilityWeight = sizePremiumLiabilityWeight;\n    }\n    return maxLiabilityWeight;\n}\nexports.calculateSizePremiumLiabilityWeight = calculateSizePremiumLiabilityWeight;\nfunction calculateSizeDiscountAssetWeight(size, // AMM_RESERVE_PRECISION\nimfFactor, assetWeight) {\n    if (imfFactor.eq(numericConstants_1.ZERO)) {\n        return assetWeight;\n    }\n    const sizeSqrt = (0, utils_1.squareRootBN)(size.abs().mul(new anchor_1.BN(10)).add(new anchor_1.BN(1))); //1e9 -> 1e10 -> 1e5\n    const imfNumerator = numericConstants_1.SPOT_MARKET_IMF_PRECISION.add(numericConstants_1.SPOT_MARKET_IMF_PRECISION.div(new anchor_1.BN(10)));\n    const sizeDiscountAssetWeight = imfNumerator\n        .mul(numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION)\n        .div(numericConstants_1.SPOT_MARKET_IMF_PRECISION.add(sizeSqrt // 1e5\n        .mul(imfFactor)\n        .div(new anchor_1.BN(100000)) // 1e5\n    ));\n    const minAssetWeight = anchor_1.BN.min(assetWeight, sizeDiscountAssetWeight);\n    return minAssetWeight;\n}\nexports.calculateSizeDiscountAssetWeight = calculateSizeDiscountAssetWeight;\nfunction calculateOraclePriceForPerpMargin(perpPosition, market, oraclePriceData) {\n    const oraclePriceOffset = anchor_1.BN.min(new anchor_1.BN(market.amm.maxSpread)\n        .mul(oraclePriceData.price)\n        .div(numericConstants_1.BID_ASK_SPREAD_PRECISION), oraclePriceData.confidence.add(new anchor_1.BN(market.amm.baseSpread)\n        .mul(oraclePriceData.price)\n        .div(numericConstants_1.BID_ASK_SPREAD_PRECISION)));\n    let marginPrice;\n    if (perpPosition.baseAssetAmount.gt(numericConstants_1.ZERO)) {\n        marginPrice = oraclePriceData.price.sub(oraclePriceOffset);\n    }\n    else {\n        marginPrice = oraclePriceData.price.add(oraclePriceOffset);\n    }\n    return marginPrice;\n}\nexports.calculateOraclePriceForPerpMargin = calculateOraclePriceForPerpMargin;\n/**\n * This is _not_ the same as liability value as for prediction markets, the liability for the short in prediction market is (1 - oracle price) * base\n * See {@link calculatePerpLiabilityValue} to get the liabiltiy value\n * @param market\n * @param perpPosition\n * @param oraclePriceData\n * @param includeOpenOrders\n */\nfunction calculateBaseAssetValueWithOracle(market, perpPosition, oraclePriceData, includeOpenOrders = false) {\n    let price = oraclePriceData.price;\n    if ((0, types_1.isVariant)(market.status, 'settlement')) {\n        price = market.expiryPrice;\n    }\n    const baseAssetAmount = includeOpenOrders\n        ? calculateWorstCaseBaseAssetAmount(perpPosition, market, oraclePriceData.price)\n        : perpPosition.baseAssetAmount;\n    return baseAssetAmount.abs().mul(price).div(numericConstants_1.AMM_RESERVE_PRECISION);\n}\nexports.calculateBaseAssetValueWithOracle = calculateBaseAssetValueWithOracle;\nfunction calculateWorstCaseBaseAssetAmount(perpPosition, perpMarket, oraclePrice) {\n    return calculateWorstCasePerpLiabilityValue(perpPosition, perpMarket, oraclePrice).worstCaseBaseAssetAmount;\n}\nexports.calculateWorstCaseBaseAssetAmount = calculateWorstCaseBaseAssetAmount;\nfunction calculateWorstCasePerpLiabilityValue(perpPosition, perpMarket, oraclePrice) {\n    const allBids = perpPosition.baseAssetAmount.add(perpPosition.openBids);\n    const allAsks = perpPosition.baseAssetAmount.add(perpPosition.openAsks);\n    const isPredictionMarket = (0, types_1.isVariant)(perpMarket.contractType, 'prediction');\n    const allBidsLiabilityValue = calculatePerpLiabilityValue(allBids, oraclePrice, isPredictionMarket);\n    const allAsksLiabilityValue = calculatePerpLiabilityValue(allAsks, oraclePrice, isPredictionMarket);\n    if (allAsksLiabilityValue.gte(allBidsLiabilityValue)) {\n        return {\n            worstCaseBaseAssetAmount: allAsks,\n            worstCaseLiabilityValue: allAsksLiabilityValue,\n        };\n    }\n    else {\n        return {\n            worstCaseBaseAssetAmount: allBids,\n            worstCaseLiabilityValue: allBidsLiabilityValue,\n        };\n    }\n}\nexports.calculateWorstCasePerpLiabilityValue = calculateWorstCasePerpLiabilityValue;\nfunction calculatePerpLiabilityValue(baseAssetAmount, price, isPredictionMarket) {\n    if (isPredictionMarket) {\n        if (baseAssetAmount.gt(numericConstants_1.ZERO)) {\n            return baseAssetAmount.mul(price).div(numericConstants_1.BASE_PRECISION);\n        }\n        else {\n            return baseAssetAmount\n                .abs()\n                .mul(numericConstants_1.MAX_PREDICTION_PRICE.sub(price))\n                .div(numericConstants_1.BASE_PRECISION);\n        }\n    }\n    else {\n        return baseAssetAmount.abs().mul(price).div(numericConstants_1.BASE_PRECISION);\n    }\n}\nexports.calculatePerpLiabilityValue = calculatePerpLiabilityValue;\n/**\n * Calculates the margin required to open a trade, in quote amount. Only accounts for the trade size as a scalar value, does not account for the trade direction or current open positions and whether the trade would _actually_ be risk-increasing and use any extra collateral.\n * @param targetMarketIndex\n * @param baseSize\n * @returns\n */\nfunction calculateMarginUSDCRequiredForTrade(driftClient, targetMarketIndex, baseSize, userMaxMarginRatio, userHighLeverageMode, entryPrice) {\n    const targetMarket = driftClient.getPerpMarketAccount(targetMarketIndex);\n    const price = entryPrice !== null && entryPrice !== void 0 ? entryPrice : driftClient.getOracleDataForPerpMarket(targetMarket.marketIndex).price;\n    const perpLiabilityValue = calculatePerpLiabilityValue(baseSize, price, (0, types_1.isVariant)(targetMarket.contractType, 'prediction'));\n    const marginRequired = new anchor_1.BN((0, market_1.calculateMarketMarginRatio)(targetMarket, baseSize.abs(), 'Initial', userMaxMarginRatio, userHighLeverageMode))\n        .mul(perpLiabilityValue)\n        .div(numericConstants_1.MARGIN_PRECISION);\n    return marginRequired;\n}\nexports.calculateMarginUSDCRequiredForTrade = calculateMarginUSDCRequiredForTrade;\n/**\n * Similar to calculatetMarginUSDCRequiredForTrade, but calculates how much of a given collateral is required to cover the margin requirements for a given trade. Basically does the same thing as getMarginUSDCRequiredForTrade but also accounts for asset weight of the selected collateral.\n *\n * Returns collateral required in the precision of the target collateral market.\n */\nfunction calculateCollateralDepositRequiredForTrade(driftClient, targetMarketIndex, baseSize, collateralIndex, userMaxMarginRatio, userHighLeverageMode, estEntryPrice) {\n    const marginRequiredUsdc = calculateMarginUSDCRequiredForTrade(driftClient, targetMarketIndex, baseSize, userMaxMarginRatio, userHighLeverageMode, estEntryPrice);\n    const collateralMarket = driftClient.getSpotMarketAccount(collateralIndex);\n    const collateralOracleData = driftClient.getOracleDataForSpotMarket(collateralIndex);\n    const scaledAssetWeight = (0, spotBalance_1.calculateScaledInitialAssetWeight)(collateralMarket, collateralOracleData.price);\n    // Base amount required to deposit = (marginRequiredUsdc / priceOfAsset) / assetWeight .. (E.g. $100 required / $10000 price / 0.5 weight)\n    const baseAmountRequired = driftClient\n        .convertToSpotPrecision(collateralIndex, marginRequiredUsdc)\n        .mul(numericConstants_1.PRICE_PRECISION) // adjust for division by oracle price\n        .mul(numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION) // adjust for division by scaled asset weight\n        .div(collateralOracleData.price)\n        .div(scaledAssetWeight)\n        .div(numericConstants_1.QUOTE_PRECISION); // adjust for marginRequiredUsdc value's QUOTE_PRECISION\n    // TODO : Round by step size?\n    return baseAmountRequired;\n}\nexports.calculateCollateralDepositRequiredForTrade = calculateCollateralDepositRequiredForTrade;\nfunction calculateCollateralValueOfDeposit(driftClient, collateralIndex, baseSize) {\n    const collateralMarket = driftClient.getSpotMarketAccount(collateralIndex);\n    const collateralOracleData = driftClient.getOracleDataForSpotMarket(collateralIndex);\n    const scaledAssetWeight = (0, spotBalance_1.calculateScaledInitialAssetWeight)(collateralMarket, collateralOracleData.price);\n    // CollateralBaseValue = oracle price * collateral base amount (and shift to QUOTE_PRECISION)\n    const collateralBaseValue = collateralOracleData.price\n        .mul(baseSize)\n        .mul(numericConstants_1.QUOTE_PRECISION)\n        .div(numericConstants_1.PRICE_PRECISION)\n        .div(new anchor_1.BN(10).pow(new anchor_1.BN(collateralMarket.decimals)));\n    const depositCollateralValue = collateralBaseValue\n        .mul(scaledAssetWeight)\n        .div(numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION);\n    return depositCollateralValue;\n}\nexports.calculateCollateralValueOfDeposit = calculateCollateralValueOfDeposit;\nfunction calculateLiquidationPrice(freeCollateral, freeCollateralDelta, oraclePrice) {\n    const liqPriceDelta = freeCollateral\n        .mul(numericConstants_1.QUOTE_PRECISION)\n        .div(freeCollateralDelta);\n    const liqPrice = oraclePrice.sub(liqPriceDelta);\n    if (liqPrice.lt(numericConstants_1.ZERO)) {\n        return new anchor_1.BN(-1);\n    }\n    return liqPrice;\n}\nexports.calculateLiquidationPrice = calculateLiquidationPrice;\nfunction calculateUserMaxPerpOrderSize(driftClient, userAccountKey, userAccount, targetMarketIndex, tradeSide) {\n    const userAccountSubscriber = new oneShotUserAccountSubscriber_1.OneShotUserAccountSubscriber(driftClient.program, userAccountKey, userAccount);\n    const user = new user_1.User({\n        driftClient,\n        userAccountPublicKey: userAccountKey,\n        accountSubscription: {\n            type: 'custom',\n            userAccountSubscriber: userAccountSubscriber,\n        },\n    });\n    user.isSubscribed = true;\n    return user.getMaxTradeSizeUSDCForPerp(targetMarketIndex, tradeSide);\n}\nexports.calculateUserMaxPerpOrderSize = calculateUserMaxPerpOrderSize;\nfunction calcHighLeverageModeInitialMarginRatioFromSize(preSizeAdjMarginRatio, sizeAdjMarginRatio, defaultMarginRatio) {\n    let result;\n    if (sizeAdjMarginRatio.lt(preSizeAdjMarginRatio)) {\n        const sizePctDiscountFactor = numericConstants_1.PERCENTAGE_PRECISION.sub(preSizeAdjMarginRatio\n            .sub(sizeAdjMarginRatio)\n            .mul(numericConstants_1.PERCENTAGE_PRECISION)\n            .div(preSizeAdjMarginRatio.div(new anchor_1.BN(5))));\n        const hlmMarginDelta = anchor_1.BN.max(preSizeAdjMarginRatio.sub(defaultMarginRatio), new anchor_1.BN(1));\n        const hlmMarginDeltaProportion = hlmMarginDelta\n            .mul(sizePctDiscountFactor)\n            .div(numericConstants_1.PERCENTAGE_PRECISION);\n        result = hlmMarginDeltaProportion.add(defaultMarginRatio);\n    }\n    else if (sizeAdjMarginRatio.eq(preSizeAdjMarginRatio)) {\n        result = defaultMarginRatio;\n    }\n    else {\n        result = sizeAdjMarginRatio;\n    }\n    return result;\n}\nexports.calcHighLeverageModeInitialMarginRatioFromSize = calcHighLeverageModeInitialMarginRatioFromSize;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,8CAA8C,GAAG,QAAQ,6BAA6B,GAAG,QAAQ,yBAAyB,GAAG,QAAQ,iCAAiC,GAAG,QAAQ,0CAA0C,GAAG,QAAQ,mCAAmC,GAAG,QAAQ,2BAA2B,GAAG,QAAQ,oCAAoC,GAAG,QAAQ,iCAAiC,GAAG,QAAQ,iCAAiC,GAAG,QAAQ,iCAAiC,GAAG,QAAQ,gCAAgC,GAAG,QAAQ,mCAAmC,GAAG,KAAK;AAC3kB,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,SAAS,oCAAoC,IAAI,EACjD,SAAS,EAAE,eAAe,EAAE,SAAS,EAAE,YAAY,IAAI;IACnD,IAAI,UAAU,EAAE,CAAC,mBAAmB,IAAI,GAAG;QACvC,OAAO;IACX;IACA,MAAM,WAAW,CAAC,GAAG,QAAQ,YAAY,EAAE,KAAK,GAAG,GAAG,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,KAAK,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,MAAM,oBAAoB;IAC7H,MAAM,2BAA2B,gBAAgB,GAAG,CAAC,gBAAgB,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC;IACzF,MAAM,QAAQ,IAAI,SAAS,EAAE,CAAC,QAAQ,GAAG,CAAC,mBAAmB,yBAAyB,EAAE,GAAG,CAAC;IAC5F,CAAC,GAAG,SAAS,MAAM,EAAE,MAAM,EAAE,CAAC,mBAAmB,IAAI;IACrD,MAAM,6BAA6B,yBAAyB,GAAG,CAAC,SAAS,MAAM;KAC1E,GAAG,CAAC,WACJ,GAAG,CAAC,OAAO,MAAM;;IAEtB,IAAI;IACJ,IAAI,WAAW;QACX,qBAAqB,SAAS,EAAE,CAAC,GAAG,CAAC,iBAAiB;IAC1D,OACK;QACD,qBAAqB;IACzB;IACA,OAAO;AACX;AACA,QAAQ,mCAAmC,GAAG;AAC9C,SAAS,iCAAiC,IAAI,EAC9C,SAAS,EAAE,WAAW;IAClB,IAAI,UAAU,EAAE,CAAC,mBAAmB,IAAI,GAAG;QACvC,OAAO;IACX;IACA,MAAM,WAAW,CAAC,GAAG,QAAQ,YAAY,EAAE,KAAK,GAAG,GAAG,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,KAAK,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,MAAM,oBAAoB;IAC7H,MAAM,eAAe,mBAAmB,yBAAyB,CAAC,GAAG,CAAC,mBAAmB,yBAAyB,CAAC,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC;IACvI,MAAM,0BAA0B,aAC3B,GAAG,CAAC,mBAAmB,4BAA4B,EACnD,GAAG,CAAC,mBAAmB,yBAAyB,CAAC,GAAG,CAAC,SAAS,MAAM;KACpE,GAAG,CAAC,WACJ,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,SAAS,MAAM;;IAExC,MAAM,iBAAiB,SAAS,EAAE,CAAC,GAAG,CAAC,aAAa;IACpD,OAAO;AACX;AACA,QAAQ,gCAAgC,GAAG;AAC3C,SAAS,kCAAkC,YAAY,EAAE,MAAM,EAAE,eAAe;IAC5E,MAAM,oBAAoB,SAAS,EAAE,CAAC,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,OAAO,GAAG,CAAC,SAAS,EACzE,GAAG,CAAC,gBAAgB,KAAK,EACzB,GAAG,CAAC,mBAAmB,wBAAwB,GAAG,gBAAgB,UAAU,CAAC,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,OAAO,GAAG,CAAC,UAAU,EACtH,GAAG,CAAC,gBAAgB,KAAK,EACzB,GAAG,CAAC,mBAAmB,wBAAwB;IACpD,IAAI;IACJ,IAAI,aAAa,eAAe,CAAC,EAAE,CAAC,mBAAmB,IAAI,GAAG;QAC1D,cAAc,gBAAgB,KAAK,CAAC,GAAG,CAAC;IAC5C,OACK;QACD,cAAc,gBAAgB,KAAK,CAAC,GAAG,CAAC;IAC5C;IACA,OAAO;AACX;AACA,QAAQ,iCAAiC,GAAG;AAC5C;;;;;;;CAOC,GACD,SAAS,kCAAkC,MAAM,EAAE,YAAY,EAAE,eAAe,EAAE,oBAAoB,KAAK;IACvG,IAAI,QAAQ,gBAAgB,KAAK;IACjC,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,OAAO,MAAM,EAAE,eAAe;QACrD,QAAQ,OAAO,WAAW;IAC9B;IACA,MAAM,kBAAkB,oBAClB,kCAAkC,cAAc,QAAQ,gBAAgB,KAAK,IAC7E,aAAa,eAAe;IAClC,OAAO,gBAAgB,GAAG,GAAG,GAAG,CAAC,OAAO,GAAG,CAAC,mBAAmB,qBAAqB;AACxF;AACA,QAAQ,iCAAiC,GAAG;AAC5C,SAAS,kCAAkC,YAAY,EAAE,UAAU,EAAE,WAAW;IAC5E,OAAO,qCAAqC,cAAc,YAAY,aAAa,wBAAwB;AAC/G;AACA,QAAQ,iCAAiC,GAAG;AAC5C,SAAS,qCAAqC,YAAY,EAAE,UAAU,EAAE,WAAW;IAC/E,MAAM,UAAU,aAAa,eAAe,CAAC,GAAG,CAAC,aAAa,QAAQ;IACtE,MAAM,UAAU,aAAa,eAAe,CAAC,GAAG,CAAC,aAAa,QAAQ;IACtE,MAAM,qBAAqB,CAAC,GAAG,QAAQ,SAAS,EAAE,WAAW,YAAY,EAAE;IAC3E,MAAM,wBAAwB,4BAA4B,SAAS,aAAa;IAChF,MAAM,wBAAwB,4BAA4B,SAAS,aAAa;IAChF,IAAI,sBAAsB,GAAG,CAAC,wBAAwB;QAClD,OAAO;YACH,0BAA0B;YAC1B,yBAAyB;QAC7B;IACJ,OACK;QACD,OAAO;YACH,0BAA0B;YAC1B,yBAAyB;QAC7B;IACJ;AACJ;AACA,QAAQ,oCAAoC,GAAG;AAC/C,SAAS,4BAA4B,eAAe,EAAE,KAAK,EAAE,kBAAkB;IAC3E,IAAI,oBAAoB;QACpB,IAAI,gBAAgB,EAAE,CAAC,mBAAmB,IAAI,GAAG;YAC7C,OAAO,gBAAgB,GAAG,CAAC,OAAO,GAAG,CAAC,mBAAmB,cAAc;QAC3E,OACK;YACD,OAAO,gBACF,GAAG,GACH,GAAG,CAAC,mBAAmB,oBAAoB,CAAC,GAAG,CAAC,QAChD,GAAG,CAAC,mBAAmB,cAAc;QAC9C;IACJ,OACK;QACD,OAAO,gBAAgB,GAAG,GAAG,GAAG,CAAC,OAAO,GAAG,CAAC,mBAAmB,cAAc;IACjF;AACJ;AACA,QAAQ,2BAA2B,GAAG;AACtC;;;;;CAKC,GACD,SAAS,oCAAoC,WAAW,EAAE,iBAAiB,EAAE,QAAQ,EAAE,kBAAkB,EAAE,oBAAoB,EAAE,UAAU;IACvI,MAAM,eAAe,YAAY,oBAAoB,CAAC;IACtD,MAAM,QAAQ,eAAe,QAAQ,eAAe,KAAK,IAAI,aAAa,YAAY,0BAA0B,CAAC,aAAa,WAAW,EAAE,KAAK;IAChJ,MAAM,qBAAqB,4BAA4B,UAAU,OAAO,CAAC,GAAG,QAAQ,SAAS,EAAE,aAAa,YAAY,EAAE;IAC1H,MAAM,iBAAiB,IAAI,SAAS,EAAE,CAAC,CAAC,GAAG,SAAS,0BAA0B,EAAE,cAAc,SAAS,GAAG,IAAI,WAAW,oBAAoB,uBACxI,GAAG,CAAC,oBACJ,GAAG,CAAC,mBAAmB,gBAAgB;IAC5C,OAAO;AACX;AACA,QAAQ,mCAAmC,GAAG;AAC9C;;;;CAIC,GACD,SAAS,2CAA2C,WAAW,EAAE,iBAAiB,EAAE,QAAQ,EAAE,eAAe,EAAE,kBAAkB,EAAE,oBAAoB,EAAE,aAAa;IAClK,MAAM,qBAAqB,oCAAoC,aAAa,mBAAmB,UAAU,oBAAoB,sBAAsB;IACnJ,MAAM,mBAAmB,YAAY,oBAAoB,CAAC;IAC1D,MAAM,uBAAuB,YAAY,0BAA0B,CAAC;IACpE,MAAM,oBAAoB,CAAC,GAAG,cAAc,iCAAiC,EAAE,kBAAkB,qBAAqB,KAAK;IAC3H,0IAA0I;IAC1I,MAAM,qBAAqB,YACtB,sBAAsB,CAAC,iBAAiB,oBACxC,GAAG,CAAC,mBAAmB,eAAe,EAAE,sCAAsC;KAC9E,GAAG,CAAC,mBAAmB,4BAA4B,EAAE,6CAA6C;KAClG,GAAG,CAAC,qBAAqB,KAAK,EAC9B,GAAG,CAAC,mBACJ,GAAG,CAAC,mBAAmB,eAAe,GAAG,wDAAwD;IACtG,6BAA6B;IAC7B,OAAO;AACX;AACA,QAAQ,0CAA0C,GAAG;AACrD,SAAS,kCAAkC,WAAW,EAAE,eAAe,EAAE,QAAQ;IAC7E,MAAM,mBAAmB,YAAY,oBAAoB,CAAC;IAC1D,MAAM,uBAAuB,YAAY,0BAA0B,CAAC;IACpE,MAAM,oBAAoB,CAAC,GAAG,cAAc,iCAAiC,EAAE,kBAAkB,qBAAqB,KAAK;IAC3H,6FAA6F;IAC7F,MAAM,sBAAsB,qBAAqB,KAAK,CACjD,GAAG,CAAC,UACJ,GAAG,CAAC,mBAAmB,eAAe,EACtC,GAAG,CAAC,mBAAmB,eAAe,EACtC,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,IAAI,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC,iBAAiB,QAAQ;IAC1E,MAAM,yBAAyB,oBAC1B,GAAG,CAAC,mBACJ,GAAG,CAAC,mBAAmB,4BAA4B;IACxD,OAAO;AACX;AACA,QAAQ,iCAAiC,GAAG;AAC5C,SAAS,0BAA0B,cAAc,EAAE,mBAAmB,EAAE,WAAW;IAC/E,MAAM,gBAAgB,eACjB,GAAG,CAAC,mBAAmB,eAAe,EACtC,GAAG,CAAC;IACT,MAAM,WAAW,YAAY,GAAG,CAAC;IACjC,IAAI,SAAS,EAAE,CAAC,mBAAmB,IAAI,GAAG;QACtC,OAAO,IAAI,SAAS,EAAE,CAAC,CAAC;IAC5B;IACA,OAAO;AACX;AACA,QAAQ,yBAAyB,GAAG;AACpC,SAAS,8BAA8B,WAAW,EAAE,cAAc,EAAE,WAAW,EAAE,iBAAiB,EAAE,SAAS;IACzG,MAAM,wBAAwB,IAAI,+BAA+B,4BAA4B,CAAC,YAAY,OAAO,EAAE,gBAAgB;IACnI,MAAM,OAAO,IAAI,OAAO,IAAI,CAAC;QACzB;QACA,sBAAsB;QACtB,qBAAqB;YACjB,MAAM;YACN,uBAAuB;QAC3B;IACJ;IACA,KAAK,YAAY,GAAG;IACpB,OAAO,KAAK,0BAA0B,CAAC,mBAAmB;AAC9D;AACA,QAAQ,6BAA6B,GAAG;AACxC,SAAS,+CAA+C,qBAAqB,EAAE,kBAAkB,EAAE,kBAAkB;IACjH,IAAI;IACJ,IAAI,mBAAmB,EAAE,CAAC,wBAAwB;QAC9C,MAAM,wBAAwB,mBAAmB,oBAAoB,CAAC,GAAG,CAAC,sBACrE,GAAG,CAAC,oBACJ,GAAG,CAAC,mBAAmB,oBAAoB,EAC3C,GAAG,CAAC,sBAAsB,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC;QACnD,MAAM,iBAAiB,SAAS,EAAE,CAAC,GAAG,CAAC,sBAAsB,GAAG,CAAC,qBAAqB,IAAI,SAAS,EAAE,CAAC;QACtG,MAAM,2BAA2B,eAC5B,GAAG,CAAC,uBACJ,GAAG,CAAC,mBAAmB,oBAAoB;QAChD,SAAS,yBAAyB,GAAG,CAAC;IAC1C,OACK,IAAI,mBAAmB,EAAE,CAAC,wBAAwB;QACnD,SAAS;IACb,OACK;QACD,SAAS;IACb;IACA,OAAO;AACX;AACA,QAAQ,8CAA8C,GAAG","ignoreList":[0]}},
    {"offset": {"line": 2193, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/orders.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.maxSizeForTargetLiabilityWeightBN = exports.calculateOrderBaseAssetAmount = exports.hasBuilder = exports.isSignedMsgOrder = exports.isTakingOrder = exports.isRestingLimitOrder = exports.isTriggered = exports.mustBeTriggered = exports.isLimitOrder = exports.isMarketOrder = exports.isOrderExpired = exports.calculateBaseAssetAmountToFillUpToLimitPrice = exports.calculateBaseAssetAmountForAmmToFulfill = exports.isLowRiskForAmm = exports.isFillableByVAMM = exports.hasAuctionPrice = exports.hasLimitPrice = exports.applyProtectedMakerParams = exports.getLimitPrice = exports.standardizePrice = exports.standardizeBaseAssetAmount = exports.isOrderReduceOnly = exports.isOrderRiskIncreasingInSameDirection = exports.isOrderRiskIncreasing = void 0;\nconst types_1 = require(\"../types\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst auction_1 = require(\"./auction\");\nconst amm_1 = require(\"./amm\");\nconst margin_1 = require(\"./margin\");\nfunction isOrderRiskIncreasing(user, order) {\n    if (!(0, types_1.isVariant)(order.status, 'open')) {\n        return false;\n    }\n    const position = user.getPerpPosition(order.marketIndex) ||\n        user.getEmptyPosition(order.marketIndex);\n    // if no position exists, it's risk increasing\n    if (position.baseAssetAmount.eq(numericConstants_1.ZERO)) {\n        return true;\n    }\n    // if position is long and order is long\n    if (position.baseAssetAmount.gt(numericConstants_1.ZERO) && (0, types_1.isVariant)(order.direction, 'long')) {\n        return true;\n    }\n    // if position is short and order is short\n    if (position.baseAssetAmount.lt(numericConstants_1.ZERO) &&\n        (0, types_1.isVariant)(order.direction, 'short')) {\n        return true;\n    }\n    const baseAssetAmountToFill = order.baseAssetAmount.sub(order.baseAssetAmountFilled);\n    // if order will flip position\n    if (baseAssetAmountToFill.gt(position.baseAssetAmount.abs().mul(numericConstants_1.TWO))) {\n        return true;\n    }\n    return false;\n}\nexports.isOrderRiskIncreasing = isOrderRiskIncreasing;\nfunction isOrderRiskIncreasingInSameDirection(user, order) {\n    if (!(0, types_1.isVariant)(order.status, 'open')) {\n        return false;\n    }\n    const position = user.getPerpPosition(order.marketIndex) ||\n        user.getEmptyPosition(order.marketIndex);\n    // if no position exists, it's risk increasing\n    if (position.baseAssetAmount.eq(numericConstants_1.ZERO)) {\n        return true;\n    }\n    // if position is long and order is long\n    if (position.baseAssetAmount.gt(numericConstants_1.ZERO) && (0, types_1.isVariant)(order.direction, 'long')) {\n        return true;\n    }\n    // if position is short and order is short\n    if (position.baseAssetAmount.lt(numericConstants_1.ZERO) &&\n        (0, types_1.isVariant)(order.direction, 'short')) {\n        return true;\n    }\n    return false;\n}\nexports.isOrderRiskIncreasingInSameDirection = isOrderRiskIncreasingInSameDirection;\nfunction isOrderReduceOnly(user, order) {\n    if (!(0, types_1.isVariant)(order.status, 'open')) {\n        return false;\n    }\n    const position = user.getPerpPosition(order.marketIndex) ||\n        user.getEmptyPosition(order.marketIndex);\n    // if position is long and order is long\n    if (position.baseAssetAmount.gte(numericConstants_1.ZERO) &&\n        (0, types_1.isVariant)(order.direction, 'long')) {\n        return false;\n    }\n    // if position is short and order is short\n    if (position.baseAssetAmount.lte(numericConstants_1.ZERO) &&\n        (0, types_1.isVariant)(order.direction, 'short')) {\n        return false;\n    }\n    return true;\n}\nexports.isOrderReduceOnly = isOrderReduceOnly;\nfunction standardizeBaseAssetAmount(baseAssetAmount, stepSize) {\n    const remainder = baseAssetAmount.mod(stepSize);\n    return baseAssetAmount.sub(remainder);\n}\nexports.standardizeBaseAssetAmount = standardizeBaseAssetAmount;\nfunction standardizePrice(price, tickSize, direction) {\n    if (price.eq(numericConstants_1.ZERO)) {\n        console.log('price is zero');\n        return price;\n    }\n    const remainder = price.mod(tickSize);\n    if (remainder.eq(numericConstants_1.ZERO)) {\n        return price;\n    }\n    if ((0, types_1.isVariant)(direction, 'long')) {\n        return price.sub(remainder);\n    }\n    else {\n        return price.add(tickSize).sub(remainder);\n    }\n}\nexports.standardizePrice = standardizePrice;\nfunction getLimitPrice(order, oraclePriceData, slot, fallbackPrice, protectedMakerParams) {\n    let limitPrice;\n    if (hasAuctionPrice(order, slot)) {\n        limitPrice = (0, auction_1.getAuctionPrice)(order, slot, oraclePriceData.price);\n    }\n    else if (order.oraclePriceOffset !== 0) {\n        limitPrice = anchor_1.BN.max(oraclePriceData.price.add(new anchor_1.BN(order.oraclePriceOffset)), numericConstants_1.ONE);\n    }\n    else if (order.price.eq(numericConstants_1.ZERO)) {\n        limitPrice = fallbackPrice;\n    }\n    else {\n        limitPrice = order.price;\n    }\n    if (protectedMakerParams) {\n        limitPrice = applyProtectedMakerParams(limitPrice, order.direction, protectedMakerParams);\n    }\n    return limitPrice;\n}\nexports.getLimitPrice = getLimitPrice;\nfunction applyProtectedMakerParams(limitPrice, direction, protectedMakerParams) {\n    const minOffset = protectedMakerParams.tickSize.muln(8);\n    let limitPriceBpsDivisor;\n    if (protectedMakerParams.limitPriceDivisor > 0) {\n        limitPriceBpsDivisor = 10000 / protectedMakerParams.limitPriceDivisor;\n    }\n    else {\n        limitPriceBpsDivisor = 1000;\n    }\n    const limitPriceOffset = anchor_1.BN.min(anchor_1.BN.max(anchor_1.BN.max(limitPrice.divn(limitPriceBpsDivisor), minOffset), protectedMakerParams.dynamicOffset), limitPrice.divn(20));\n    if ((0, types_1.isVariant)(direction, 'long')) {\n        return anchor_1.BN.max(limitPrice.sub(limitPriceOffset), protectedMakerParams.tickSize);\n    }\n    else {\n        return limitPrice.add(limitPriceOffset);\n    }\n}\nexports.applyProtectedMakerParams = applyProtectedMakerParams;\nfunction hasLimitPrice(order, slot) {\n    return (order.price.gt(numericConstants_1.ZERO) ||\n        order.oraclePriceOffset != 0 ||\n        !(0, auction_1.isAuctionComplete)(order, slot));\n}\nexports.hasLimitPrice = hasLimitPrice;\nfunction hasAuctionPrice(order, slot) {\n    return (!(0, auction_1.isAuctionComplete)(order, slot) &&\n        (!order.auctionStartPrice.eq(numericConstants_1.ZERO) || !order.auctionEndPrice.eq(numericConstants_1.ZERO)));\n}\nexports.hasAuctionPrice = hasAuctionPrice;\nfunction isFillableByVAMM(order, market, mmOraclePriceData, slot, ts, state) {\n    return (((0, auction_1.isFallbackAvailableLiquiditySource)(order, mmOraclePriceData, slot, state, market) &&\n        calculateBaseAssetAmountForAmmToFulfill(order, market, mmOraclePriceData, slot).gt(numericConstants_1.ZERO)) ||\n        isOrderExpired(order, ts));\n}\nexports.isFillableByVAMM = isFillableByVAMM;\nfunction isLowRiskForAmm(order, mmOraclePriceData, isLiquidation) {\n    if ((0, types_1.isVariant)(order.marketType, 'spot')) {\n        return false;\n    }\n    const orderOlderThanOracleDelay = new anchor_1.BN(order.slot).lte(mmOraclePriceData.slot);\n    return (orderOlderThanOracleDelay ||\n        isLiquidation ||\n        (order.bitFlags & types_1.OrderBitFlag.SafeTriggerOrder) !== 0);\n}\nexports.isLowRiskForAmm = isLowRiskForAmm;\nfunction calculateBaseAssetAmountForAmmToFulfill(order, market, mmOraclePriceData, slot) {\n    if (mustBeTriggered(order) && !isTriggered(order)) {\n        return numericConstants_1.ZERO;\n    }\n    const limitPrice = getLimitPrice(order, mmOraclePriceData, slot);\n    let baseAssetAmount;\n    const updatedAMM = (0, amm_1.calculateUpdatedAMM)(market.amm, mmOraclePriceData);\n    if (limitPrice !== undefined) {\n        baseAssetAmount = calculateBaseAssetAmountToFillUpToLimitPrice(order, updatedAMM, limitPrice, mmOraclePriceData);\n    }\n    else {\n        baseAssetAmount = order.baseAssetAmount.sub(order.baseAssetAmountFilled);\n    }\n    const maxBaseAssetAmount = (0, amm_1.calculateMaxBaseAssetAmountFillable)(updatedAMM, order.direction);\n    return anchor_1.BN.min(maxBaseAssetAmount, baseAssetAmount);\n}\nexports.calculateBaseAssetAmountForAmmToFulfill = calculateBaseAssetAmountForAmmToFulfill;\nfunction calculateBaseAssetAmountToFillUpToLimitPrice(order, amm, limitPrice, mmOraclePriceData) {\n    const adjustedLimitPrice = (0, types_1.isVariant)(order.direction, 'long')\n        ? limitPrice.sub(amm.orderTickSize)\n        : limitPrice.add(amm.orderTickSize);\n    const [maxAmountToTrade, direction] = (0, amm_1.calculateMaxBaseAssetAmountToTrade)(amm, adjustedLimitPrice, order.direction, mmOraclePriceData);\n    const baseAssetAmount = standardizeBaseAssetAmount(maxAmountToTrade, amm.orderStepSize);\n    // Check that directions are the same\n    const sameDirection = isSameDirection(direction, order.direction);\n    if (!sameDirection) {\n        return numericConstants_1.ZERO;\n    }\n    const baseAssetAmountUnfilled = order.baseAssetAmount.sub(order.baseAssetAmountFilled);\n    return baseAssetAmount.gt(baseAssetAmountUnfilled)\n        ? baseAssetAmountUnfilled\n        : baseAssetAmount;\n}\nexports.calculateBaseAssetAmountToFillUpToLimitPrice = calculateBaseAssetAmountToFillUpToLimitPrice;\nfunction isSameDirection(firstDirection, secondDirection) {\n    return (((0, types_1.isVariant)(firstDirection, 'long') && (0, types_1.isVariant)(secondDirection, 'long')) ||\n        ((0, types_1.isVariant)(firstDirection, 'short') && (0, types_1.isVariant)(secondDirection, 'short')));\n}\nfunction isOrderExpired(order, ts, enforceBuffer = false, bufferSeconds = 15) {\n    if (mustBeTriggered(order) ||\n        !(0, types_1.isVariant)(order.status, 'open') ||\n        order.maxTs.eq(numericConstants_1.ZERO)) {\n        return false;\n    }\n    let maxTs;\n    if (enforceBuffer && isLimitOrder(order)) {\n        maxTs = order.maxTs.addn(bufferSeconds);\n    }\n    else {\n        maxTs = order.maxTs;\n    }\n    return new anchor_1.BN(ts).gt(maxTs);\n}\nexports.isOrderExpired = isOrderExpired;\nfunction isMarketOrder(order) {\n    return (0, types_1.isOneOfVariant)(order.orderType, ['market', 'triggerMarket', 'oracle']);\n}\nexports.isMarketOrder = isMarketOrder;\nfunction isLimitOrder(order) {\n    return (0, types_1.isOneOfVariant)(order.orderType, ['limit', 'triggerLimit']);\n}\nexports.isLimitOrder = isLimitOrder;\nfunction mustBeTriggered(order) {\n    return (0, types_1.isOneOfVariant)(order.orderType, ['triggerMarket', 'triggerLimit']);\n}\nexports.mustBeTriggered = mustBeTriggered;\nfunction isTriggered(order) {\n    return (0, types_1.isOneOfVariant)(order.triggerCondition, [\n        'triggeredAbove',\n        'triggeredBelow',\n    ]);\n}\nexports.isTriggered = isTriggered;\nfunction isRestingLimitOrder(order, slot) {\n    if (!isLimitOrder(order)) {\n        return false;\n    }\n    return order.postOnly || (0, auction_1.isAuctionComplete)(order, slot);\n}\nexports.isRestingLimitOrder = isRestingLimitOrder;\nfunction isTakingOrder(order, slot) {\n    return isMarketOrder(order) || !isRestingLimitOrder(order, slot);\n}\nexports.isTakingOrder = isTakingOrder;\nconst FLAG_IS_SIGNED_MSG = 0x01;\nfunction isSignedMsgOrder(order) {\n    return (order.bitFlags & FLAG_IS_SIGNED_MSG) !== 0;\n}\nexports.isSignedMsgOrder = isSignedMsgOrder;\nconst FLAG_HAS_BUILDER = 0x10;\nfunction hasBuilder(order) {\n    return (order.bitFlags & FLAG_HAS_BUILDER) !== 0;\n}\nexports.hasBuilder = hasBuilder;\nfunction calculateOrderBaseAssetAmount(order, existingBaseAssetAmount) {\n    if (!order.reduceOnly) {\n        return order.baseAssetAmount;\n    }\n    if ((0, types_1.isVariant)(order.direction, 'long')) {\n        return anchor_1.BN.min(anchor_1.BN.min(existingBaseAssetAmount, numericConstants_1.ZERO).abs(), order.baseAssetAmount);\n    }\n    else {\n        return anchor_1.BN.min(anchor_1.BN.max(existingBaseAssetAmount, numericConstants_1.ZERO), order.baseAssetAmount);\n    }\n}\nexports.calculateOrderBaseAssetAmount = calculateOrderBaseAssetAmount;\n// ---------- inverse ----------\n/**\n * Invert the size-premium liability weight: given a target margin ratio (liability weight),\n * return the max `size` (AMM_RESERVE_PRECISION units) that still yields <= target.\n *\n * Returns:\n * - BN size (>=0) if bounded\n * - null if impossible (target < liabilityWeight) OR imfFactor == 0 (unbounded)\n */\nfunction maxSizeForTargetLiabilityWeightBN(target, imfFactor, liabilityWeight, market) {\n    if (target.lt(liabilityWeight))\n        return null;\n    if (imfFactor.isZero())\n        return null;\n    const base = liabilityWeight.muln(4).divn(5);\n    const denom = new anchor_1.BN(100000)\n        .mul(numericConstants_1.SPOT_MARKET_IMF_PRECISION)\n        .div(numericConstants_1.MARGIN_PRECISION);\n    if (denom.isZero())\n        throw new Error('denom=0: bad precision/spotImfPrecision');\n    const allowedInc = target.gt(base) ? target.sub(base) : numericConstants_1.ZERO;\n    const maxSqrt = allowedInc.mul(denom).div(imfFactor);\n    if (maxSqrt.lte(numericConstants_1.ZERO)) {\n        const fitsZero = (0, margin_1.calculateSizePremiumLiabilityWeight)(numericConstants_1.ZERO, imfFactor, liabilityWeight, numericConstants_1.MARGIN_PRECISION).lte(target);\n        return fitsZero ? numericConstants_1.ZERO : null;\n    }\n    let hi = maxSqrt.mul(maxSqrt).sub(numericConstants_1.ONE).divn(10);\n    if (hi.isNeg())\n        hi = numericConstants_1.ZERO;\n    let lo = numericConstants_1.ZERO;\n    while (lo.lt(hi)) {\n        const mid = lo.add(hi).add(numericConstants_1.ONE).divn(2); // upper mid to prevent infinite loop\n        if ((0, margin_1.calculateSizePremiumLiabilityWeight)(mid, imfFactor, liabilityWeight, numericConstants_1.MARGIN_PRECISION).lte(target)) {\n            lo = mid;\n        }\n        else {\n            hi = mid.sub(numericConstants_1.ONE);\n        }\n    }\n    // cap at max OI\n    const maxOpenInterest = market.amm.maxOpenInterest;\n    if (lo.gt(maxOpenInterest)) {\n        return maxOpenInterest;\n    }\n    return lo;\n}\nexports.maxSizeForTargetLiabilityWeightBN = maxSizeForTargetLiabilityWeightBN;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 2487, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/repeg.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.calculateBudgetedPeg = exports.calculateBudgetedK = exports.calculateBudgetedKBN = exports.calculateRepegCost = exports.calculateAdjustKCost = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst assert_1 = require(\"../assert/assert\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\n/**\n * Helper function calculating adjust k cost\n * @param amm\n * @param numerator\n * @param denomenator\n * @returns cost : Precision QUOTE_ASSET_PRECISION\n */\nfunction calculateAdjustKCost(amm, numerator, denomenator) {\n    // const k = market.amm.sqrtK.mul(market.amm.sqrtK);\n    const x = amm.baseAssetReserve;\n    const y = amm.quoteAssetReserve;\n    const d = amm.baseAssetAmountWithAmm;\n    const Q = amm.pegMultiplier;\n    const quoteScale = y.mul(d).mul(Q); //.div(AMM_RESERVE_PRECISION);\n    const p = numerator.mul(numericConstants_1.PRICE_PRECISION).div(denomenator);\n    const cost = quoteScale\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(x.add(d))\n        .sub(quoteScale\n        .mul(p)\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(numericConstants_1.PRICE_PRECISION)\n        .div(x.mul(p).div(numericConstants_1.PRICE_PRECISION).add(d)))\n        .div(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO)\n        .div(numericConstants_1.PEG_PRECISION);\n    return cost.mul(new anchor_1.BN(-1));\n}\nexports.calculateAdjustKCost = calculateAdjustKCost;\n// /**\n//  * Helper function calculating adjust k cost\n//  * @param amm\n//  * @param numerator\n//  * @param denomenator\n//  * @returns cost : Precision QUOTE_ASSET_PRECISION\n//  */\n// export function calculateAdjustKCost2(\n// \tamm: AMM,\n// \tnumerator: BN,\n// \tdenomenator: BN\n// ): BN {\n// \t// const k = market.amm.sqrtK.mul(market.amm.sqrtK);\n// \tconst directionToClose = amm.baseAssetAmountWithAmm.gt(ZERO)\n// \t\t? PositionDirection.SHORT\n// \t\t: PositionDirection.LONG;\n// \tconst [newQuoteAssetReserve, _newBaseAssetReserve] =\n// \t\tcalculateAmmReservesAfterSwap(\n// \t\t\tamm,\n// \t\t\t'base',\n// \t\t\tamm.baseAssetAmountWithAmm.abs(),\n// \t\t\tgetSwapDirection('base', directionToClose)\n// \t\t);\n// }\n/**\n * Helper function calculating adjust pegMultiplier (repeg) cost\n *\n * @param amm\n * @param newPeg\n * @returns cost : Precision QUOTE_ASSET_PRECISION\n */\nfunction calculateRepegCost(amm, newPeg) {\n    const dqar = amm.quoteAssetReserve.sub(amm.terminalQuoteAssetReserve);\n    const cost = dqar\n        .mul(newPeg.sub(amm.pegMultiplier))\n        .div(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO)\n        .div(numericConstants_1.PEG_PRECISION);\n    return cost;\n}\nexports.calculateRepegCost = calculateRepegCost;\nfunction calculateBudgetedKBN(x, y, budget, Q, d) {\n    (0, assert_1.assert)(Q.gt(new anchor_1.BN(0)));\n    const C = budget.mul(new anchor_1.BN(-1));\n    let dSign = new anchor_1.BN(1);\n    if (d.lt(new anchor_1.BN(0))) {\n        dSign = new anchor_1.BN(-1);\n    }\n    const pegged_y_d_d = y\n        .mul(d)\n        .mul(d)\n        .mul(Q)\n        .div(numericConstants_1.AMM_RESERVE_PRECISION)\n        .div(numericConstants_1.AMM_RESERVE_PRECISION)\n        .div(numericConstants_1.PEG_PRECISION);\n    const numer1 = pegged_y_d_d;\n    const numer2 = C.mul(d)\n        .div(numericConstants_1.QUOTE_PRECISION)\n        .mul(x.add(d))\n        .div(numericConstants_1.AMM_RESERVE_PRECISION)\n        .mul(dSign);\n    const denom1 = C.mul(x)\n        .mul(x.add(d))\n        .div(numericConstants_1.AMM_RESERVE_PRECISION)\n        .div(numericConstants_1.QUOTE_PRECISION);\n    const denom2 = pegged_y_d_d;\n    // protocol is spending to increase k\n    if (C.lt(numericConstants_1.ZERO)) {\n        // thus denom1 is negative and solution is unstable\n        if (denom1.abs().gt(denom2.abs())) {\n            console.log('denom1 > denom2', denom1.toString(), denom2.toString());\n            console.log('budget cost exceeds stable K solution');\n            return [new anchor_1.BN(10000), new anchor_1.BN(1)];\n        }\n    }\n    const numerator = numer1.sub(numer2).div(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO);\n    const denominator = denom1.add(denom2).div(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO);\n    return [numerator, denominator];\n}\nexports.calculateBudgetedKBN = calculateBudgetedKBN;\nfunction calculateBudgetedK(amm, cost) {\n    // wolframalpha.com\n    // (1/(x+d) - p/(x*p+d))*y*d*Q = C solve for p\n    // p = (d(y*d*Q - C(x+d))) / (C*x(x+d) + y*d*d*Q)\n    // numer\n    //   =  y*d*d*Q - Cxd - Cdd\n    //   =  y/x*Q*d*d - Cd - Cd/x\n    //   = mark      - C/d - C/(x)\n    //   =  mark/C    - 1/d - 1/x\n    // denom\n    // = C*x*x + C*x*d + y*d*d*Q\n    // = x/d**2 + 1 / d + mark/C\n    // todo: assumes k = x * y\n    // otherwise use: (y(1-p) + (kp^2/(x*p+d)) - k/(x+d)) * Q = C solve for p\n    const x = amm.baseAssetReserve;\n    const y = amm.quoteAssetReserve;\n    const d = amm.baseAssetAmountWithAmm;\n    const Q = amm.pegMultiplier;\n    const [numerator, denominator] = calculateBudgetedKBN(x, y, cost, Q, d);\n    return [numerator, denominator];\n}\nexports.calculateBudgetedK = calculateBudgetedK;\nfunction calculateBudgetedPeg(amm, budget, targetPrice) {\n    let perPegCost = amm.quoteAssetReserve\n        .sub(amm.terminalQuoteAssetReserve)\n        .div(numericConstants_1.AMM_RESERVE_PRECISION.div(numericConstants_1.PRICE_PRECISION));\n    if (perPegCost.gt(numericConstants_1.ZERO)) {\n        perPegCost = perPegCost.add(numericConstants_1.ONE);\n    }\n    else if (perPegCost.lt(numericConstants_1.ZERO)) {\n        perPegCost = perPegCost.sub(numericConstants_1.ONE);\n    }\n    const targetPeg = targetPrice\n        .mul(amm.baseAssetReserve)\n        .div(amm.quoteAssetReserve)\n        .div(numericConstants_1.PRICE_DIV_PEG);\n    const pegChangeDirection = targetPeg.sub(amm.pegMultiplier);\n    const useTargetPeg = (perPegCost.lt(numericConstants_1.ZERO) && pegChangeDirection.gt(numericConstants_1.ZERO)) ||\n        (perPegCost.gt(numericConstants_1.ZERO) && pegChangeDirection.lt(numericConstants_1.ZERO));\n    if (perPegCost.eq(numericConstants_1.ZERO) || useTargetPeg) {\n        return targetPeg;\n    }\n    const budgetDeltaPeg = budget.mul(numericConstants_1.PEG_PRECISION).div(perPegCost);\n    const newPeg = anchor_1.BN.max(numericConstants_1.ONE, amm.pegMultiplier.add(budgetDeltaPeg));\n    return newPeg;\n}\nexports.calculateBudgetedPeg = calculateBudgetedPeg;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 2627, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/amm.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.calculateMaxBaseAssetAmountFillable = exports.calculateQuoteAssetAmountSwapped = exports.calculateMaxBaseAssetAmountToTrade = exports.calculateTerminalPrice = exports.getSwapDirection = exports.calculateSwapOutput = exports.calculateSpreadReserves = exports.getQuoteAssetReservePredictionMarketBounds = exports.calculateSpread = exports.calculateSpreadBN = exports.calculateVolSpreadBN = exports.calculateMaxSpread = exports.calculateEffectiveLeverage = exports.calculateReferencePriceOffset = exports.calculateInventoryScale = exports.calculateInventoryLiquidityRatioForReferencePriceOffset = exports.calculateInventoryLiquidityRatio = exports.calculateMarketOpenBidAsk = exports.calculateAmmReservesAfterSwap = exports.calculatePrice = exports.calculateBidAskPrice = exports.calculateUpdatedAMMSpreadReserves = exports.calculateUpdatedAMM = exports.calculateNewAmm = exports.calculateOptimalPegAndBudget = exports.calculatePegFromTargetPrice = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst types_1 = require(\"../types\");\nconst assert_1 = require(\"../assert/assert\");\nconst utils_1 = require(\"./utils\");\nconst orders_1 = require(\"./orders\");\nconst repeg_1 = require(\"./repeg\");\nconst oracles_1 = require(\"./oracles\");\nfunction calculatePegFromTargetPrice(targetPrice, baseAssetReserve, quoteAssetReserve) {\n    return anchor_1.BN.max(targetPrice\n        .mul(baseAssetReserve)\n        .div(quoteAssetReserve)\n        .add(numericConstants_1.PRICE_DIV_PEG.div(new anchor_1.BN(2)))\n        .div(numericConstants_1.PRICE_DIV_PEG), numericConstants_1.ONE);\n}\nexports.calculatePegFromTargetPrice = calculatePegFromTargetPrice;\nfunction calculateOptimalPegAndBudget(amm, mmOraclePriceData) {\n    const reservePriceBefore = calculatePrice(amm.baseAssetReserve, amm.quoteAssetReserve, amm.pegMultiplier);\n    const targetPrice = mmOraclePriceData.price;\n    const newPeg = calculatePegFromTargetPrice(targetPrice, amm.baseAssetReserve, amm.quoteAssetReserve);\n    const prePegCost = (0, repeg_1.calculateRepegCost)(amm, newPeg);\n    const totalFeeLB = amm.totalExchangeFee.div(new anchor_1.BN(2));\n    const budget = anchor_1.BN.max(numericConstants_1.ZERO, amm.totalFeeMinusDistributions.sub(totalFeeLB));\n    let checkLowerBound = true;\n    if (budget.lt(prePegCost)) {\n        const halfMaxPriceSpread = new anchor_1.BN(amm.maxSpread)\n            .div(new anchor_1.BN(2))\n            .mul(targetPrice)\n            .div(numericConstants_1.BID_ASK_SPREAD_PRECISION);\n        let newTargetPrice;\n        let newOptimalPeg;\n        let newBudget;\n        const targetPriceGap = reservePriceBefore.sub(targetPrice);\n        if (targetPriceGap.abs().gt(halfMaxPriceSpread)) {\n            const markAdj = targetPriceGap.abs().sub(halfMaxPriceSpread);\n            if (targetPriceGap.lt(new anchor_1.BN(0))) {\n                newTargetPrice = reservePriceBefore.add(markAdj);\n            }\n            else {\n                newTargetPrice = reservePriceBefore.sub(markAdj);\n            }\n            newOptimalPeg = calculatePegFromTargetPrice(newTargetPrice, amm.baseAssetReserve, amm.quoteAssetReserve);\n            newBudget = (0, repeg_1.calculateRepegCost)(amm, newOptimalPeg);\n            checkLowerBound = false;\n            return [newTargetPrice, newOptimalPeg, newBudget, false];\n        }\n        else if (amm.totalFeeMinusDistributions.lt(amm.totalExchangeFee.div(new anchor_1.BN(2)))) {\n            checkLowerBound = false;\n        }\n    }\n    return [targetPrice, newPeg, budget, checkLowerBound];\n}\nexports.calculateOptimalPegAndBudget = calculateOptimalPegAndBudget;\nfunction calculateNewAmm(amm, mmOraclePriceData) {\n    let pKNumer = new anchor_1.BN(1);\n    let pKDenom = new anchor_1.BN(1);\n    const [targetPrice, _newPeg, budget, _checkLowerBound] = calculateOptimalPegAndBudget(amm, mmOraclePriceData);\n    let prePegCost = (0, repeg_1.calculateRepegCost)(amm, _newPeg);\n    let newPeg = _newPeg;\n    if (prePegCost.gte(budget) && prePegCost.gt(numericConstants_1.ZERO)) {\n        [pKNumer, pKDenom] = [new anchor_1.BN(999), new anchor_1.BN(1000)];\n        const deficitMadeup = (0, repeg_1.calculateAdjustKCost)(amm, pKNumer, pKDenom);\n        (0, assert_1.assert)(deficitMadeup.lte(new anchor_1.BN(0)));\n        prePegCost = budget.add(deficitMadeup.abs());\n        const newAmm = Object.assign({}, amm);\n        newAmm.baseAssetReserve = newAmm.baseAssetReserve.mul(pKNumer).div(pKDenom);\n        newAmm.sqrtK = newAmm.sqrtK.mul(pKNumer).div(pKDenom);\n        const invariant = newAmm.sqrtK.mul(newAmm.sqrtK);\n        newAmm.quoteAssetReserve = invariant.div(newAmm.baseAssetReserve);\n        const directionToClose = amm.baseAssetAmountWithAmm.gt(numericConstants_1.ZERO)\n            ? types_1.PositionDirection.SHORT\n            : types_1.PositionDirection.LONG;\n        const [newQuoteAssetReserve, _newBaseAssetReserve] = calculateAmmReservesAfterSwap(newAmm, 'base', amm.baseAssetAmountWithAmm.abs(), getSwapDirection('base', directionToClose));\n        newAmm.terminalQuoteAssetReserve = newQuoteAssetReserve;\n        newPeg = (0, repeg_1.calculateBudgetedPeg)(newAmm, prePegCost, targetPrice);\n        prePegCost = (0, repeg_1.calculateRepegCost)(newAmm, newPeg);\n    }\n    return [prePegCost, pKNumer, pKDenom, newPeg];\n}\nexports.calculateNewAmm = calculateNewAmm;\nfunction calculateUpdatedAMM(amm, mmOraclePriceData) {\n    if (amm.curveUpdateIntensity == 0 || mmOraclePriceData === undefined) {\n        return amm;\n    }\n    const newAmm = Object.assign({}, amm);\n    const [prepegCost, pKNumer, pKDenom, newPeg] = calculateNewAmm(amm, mmOraclePriceData);\n    newAmm.baseAssetReserve = newAmm.baseAssetReserve.mul(pKNumer).div(pKDenom);\n    newAmm.sqrtK = newAmm.sqrtK.mul(pKNumer).div(pKDenom);\n    const invariant = newAmm.sqrtK.mul(newAmm.sqrtK);\n    newAmm.quoteAssetReserve = invariant.div(newAmm.baseAssetReserve);\n    newAmm.pegMultiplier = newPeg;\n    const directionToClose = amm.baseAssetAmountWithAmm.gt(numericConstants_1.ZERO)\n        ? types_1.PositionDirection.SHORT\n        : types_1.PositionDirection.LONG;\n    const [newQuoteAssetReserve, _newBaseAssetReserve] = calculateAmmReservesAfterSwap(newAmm, 'base', amm.baseAssetAmountWithAmm.abs(), getSwapDirection('base', directionToClose));\n    newAmm.terminalQuoteAssetReserve = newQuoteAssetReserve;\n    newAmm.totalFeeMinusDistributions =\n        newAmm.totalFeeMinusDistributions.sub(prepegCost);\n    newAmm.netRevenueSinceLastFunding =\n        newAmm.netRevenueSinceLastFunding.sub(prepegCost);\n    return newAmm;\n}\nexports.calculateUpdatedAMM = calculateUpdatedAMM;\nfunction calculateUpdatedAMMSpreadReserves(amm, direction, mmOraclePriceData, isPrediction = false, latestSlot) {\n    const newAmm = calculateUpdatedAMM(amm, mmOraclePriceData);\n    const [shortReserves, longReserves] = calculateSpreadReserves(newAmm, mmOraclePriceData, undefined, isPrediction, latestSlot);\n    const dirReserves = (0, types_1.isVariant)(direction, 'long')\n        ? longReserves\n        : shortReserves;\n    const result = {\n        baseAssetReserve: dirReserves.baseAssetReserve,\n        quoteAssetReserve: dirReserves.quoteAssetReserve,\n        sqrtK: newAmm.sqrtK,\n        newPeg: newAmm.pegMultiplier,\n    };\n    return result;\n}\nexports.calculateUpdatedAMMSpreadReserves = calculateUpdatedAMMSpreadReserves;\nfunction calculateBidAskPrice(amm, mmOraclePriceData, withUpdate = true, isPrediction = false, latestSlot) {\n    let newAmm;\n    if (withUpdate) {\n        newAmm = calculateUpdatedAMM(amm, mmOraclePriceData);\n    }\n    else {\n        newAmm = amm;\n    }\n    const [bidReserves, askReserves] = calculateSpreadReserves(newAmm, mmOraclePriceData, undefined, isPrediction, latestSlot);\n    const askPrice = calculatePrice(askReserves.baseAssetReserve, askReserves.quoteAssetReserve, newAmm.pegMultiplier);\n    const bidPrice = calculatePrice(bidReserves.baseAssetReserve, bidReserves.quoteAssetReserve, newAmm.pegMultiplier);\n    return [bidPrice, askPrice];\n}\nexports.calculateBidAskPrice = calculateBidAskPrice;\n/**\n * Calculates a price given an arbitrary base and quote amount (they must have the same precision)\n *\n * @param baseAssetReserves\n * @param quoteAssetReserves\n * @param pegMultiplier\n * @returns price : Precision PRICE_PRECISION\n */\nfunction calculatePrice(baseAssetReserves, quoteAssetReserves, pegMultiplier) {\n    if (baseAssetReserves.abs().lte(numericConstants_1.ZERO)) {\n        return new anchor_1.BN(0);\n    }\n    return quoteAssetReserves\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .mul(pegMultiplier)\n        .div(numericConstants_1.PEG_PRECISION)\n        .div(baseAssetReserves);\n}\nexports.calculatePrice = calculatePrice;\n/**\n * Calculates what the amm reserves would be after swapping a quote or base asset amount.\n *\n * @param amm\n * @param inputAssetType\n * @param swapAmount\n * @param swapDirection\n * @returns quoteAssetReserve and baseAssetReserve after swap. : Precision AMM_RESERVE_PRECISION\n */\nfunction calculateAmmReservesAfterSwap(amm, inputAssetType, swapAmount, swapDirection) {\n    (0, assert_1.assert)(swapAmount.gte(numericConstants_1.ZERO), 'swapAmount must be greater than 0');\n    let newQuoteAssetReserve;\n    let newBaseAssetReserve;\n    if (inputAssetType === 'quote') {\n        swapAmount = swapAmount\n            .mul(numericConstants_1.AMM_TIMES_PEG_TO_QUOTE_PRECISION_RATIO)\n            .div(amm.pegMultiplier);\n        [newQuoteAssetReserve, newBaseAssetReserve] = calculateSwapOutput(amm.quoteAssetReserve, swapAmount, swapDirection, amm.sqrtK.mul(amm.sqrtK));\n    }\n    else {\n        [newBaseAssetReserve, newQuoteAssetReserve] = calculateSwapOutput(amm.baseAssetReserve, swapAmount, swapDirection, amm.sqrtK.mul(amm.sqrtK));\n    }\n    return [newQuoteAssetReserve, newBaseAssetReserve];\n}\nexports.calculateAmmReservesAfterSwap = calculateAmmReservesAfterSwap;\nfunction calculateMarketOpenBidAsk(baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve, stepSize) {\n    // open orders\n    let openAsks;\n    if (minBaseAssetReserve.lt(baseAssetReserve)) {\n        openAsks = baseAssetReserve.sub(minBaseAssetReserve).mul(new anchor_1.BN(-1));\n        if (stepSize && openAsks.abs().div(numericConstants_1.TWO).lt(stepSize)) {\n            openAsks = numericConstants_1.ZERO;\n        }\n    }\n    else {\n        openAsks = numericConstants_1.ZERO;\n    }\n    let openBids;\n    if (maxBaseAssetReserve.gt(baseAssetReserve)) {\n        openBids = maxBaseAssetReserve.sub(baseAssetReserve);\n        if (stepSize && openBids.div(numericConstants_1.TWO).lt(stepSize)) {\n            openBids = numericConstants_1.ZERO;\n        }\n    }\n    else {\n        openBids = numericConstants_1.ZERO;\n    }\n    return [openBids, openAsks];\n}\nexports.calculateMarketOpenBidAsk = calculateMarketOpenBidAsk;\nfunction calculateInventoryLiquidityRatio(baseAssetAmountWithAmm, baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve) {\n    // inventory skew\n    const [openBids, openAsks] = calculateMarketOpenBidAsk(baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve);\n    const minSideLiquidity = anchor_1.BN.min(openBids.abs(), openAsks.abs());\n    const inventoryScaleBN = anchor_1.BN.min(baseAssetAmountWithAmm\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(anchor_1.BN.max(minSideLiquidity, numericConstants_1.ONE))\n        .abs(), numericConstants_1.PERCENTAGE_PRECISION);\n    return inventoryScaleBN;\n}\nexports.calculateInventoryLiquidityRatio = calculateInventoryLiquidityRatio;\nfunction calculateInventoryLiquidityRatioForReferencePriceOffset(baseAssetAmountWithAmm, baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve) {\n    // inventory skew\n    const [openBids, openAsks] = calculateMarketOpenBidAsk(baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve);\n    const avgSideLiquidity = openBids.abs().add(openAsks.abs()).div(numericConstants_1.TWO);\n    const inventoryScaleBN = anchor_1.BN.min(baseAssetAmountWithAmm\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(anchor_1.BN.max(avgSideLiquidity, numericConstants_1.ONE))\n        .abs(), numericConstants_1.PERCENTAGE_PRECISION);\n    return inventoryScaleBN;\n}\nexports.calculateInventoryLiquidityRatioForReferencePriceOffset = calculateInventoryLiquidityRatioForReferencePriceOffset;\nfunction calculateInventoryScale(baseAssetAmountWithAmm, baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve, directionalSpread, maxSpread) {\n    if (baseAssetAmountWithAmm.eq(numericConstants_1.ZERO)) {\n        return 1;\n    }\n    const MAX_BID_ASK_INVENTORY_SKEW_FACTOR = numericConstants_1.BID_ASK_SPREAD_PRECISION.mul(new anchor_1.BN(10));\n    const inventoryScaleBN = calculateInventoryLiquidityRatio(baseAssetAmountWithAmm, baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve);\n    const inventoryScaleMaxBN = anchor_1.BN.max(MAX_BID_ASK_INVENTORY_SKEW_FACTOR, new anchor_1.BN(maxSpread)\n        .mul(numericConstants_1.BID_ASK_SPREAD_PRECISION)\n        .div(new anchor_1.BN(Math.max(directionalSpread, 1))));\n    const inventoryScaleCapped = anchor_1.BN.min(inventoryScaleMaxBN, numericConstants_1.BID_ASK_SPREAD_PRECISION.add(inventoryScaleMaxBN.mul(inventoryScaleBN).div(numericConstants_1.PERCENTAGE_PRECISION))).toNumber() / numericConstants_1.BID_ASK_SPREAD_PRECISION.toNumber();\n    return inventoryScaleCapped;\n}\nexports.calculateInventoryScale = calculateInventoryScale;\nfunction calculateReferencePriceOffset(reservePrice, last24hAvgFundingRate, liquidityFraction, oracleTwapFast, markTwapFast, oracleTwapSlow, markTwapSlow, maxOffsetPct) {\n    if (last24hAvgFundingRate.eq(numericConstants_1.ZERO) || liquidityFraction.eq(numericConstants_1.ZERO)) {\n        return numericConstants_1.ZERO;\n    }\n    const maxOffsetInPrice = new anchor_1.BN(maxOffsetPct)\n        .mul(reservePrice)\n        .div(numericConstants_1.PERCENTAGE_PRECISION);\n    // Calculate quote denominated market premium\n    const markPremiumMinute = (0, utils_1.clampBN)(markTwapFast.sub(oracleTwapFast), maxOffsetInPrice.mul(new anchor_1.BN(-1)), maxOffsetInPrice);\n    const markPremiumHour = (0, utils_1.clampBN)(markTwapSlow.sub(oracleTwapSlow), maxOffsetInPrice.mul(new anchor_1.BN(-1)), maxOffsetInPrice);\n    // Convert last24hAvgFundingRate to quote denominated premium\n    const markPremiumDay = (0, utils_1.clampBN)(last24hAvgFundingRate.div(numericConstants_1.FUNDING_RATE_BUFFER_PRECISION).mul(new anchor_1.BN(24)), maxOffsetInPrice.mul(new anchor_1.BN(-1)), maxOffsetInPrice);\n    // Take average clamped premium as the price-based offset\n    const markPremiumAvg = markPremiumMinute\n        .add(markPremiumHour)\n        .add(markPremiumDay)\n        .div(new anchor_1.BN(3));\n    const markPremiumAvgPct = markPremiumAvg\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .div(reservePrice);\n    const inventoryPct = (0, utils_1.clampBN)(liquidityFraction.mul(new anchor_1.BN(maxOffsetPct)).div(numericConstants_1.PERCENTAGE_PRECISION), new anchor_1.BN(maxOffsetPct).mul(new anchor_1.BN(-1)), new anchor_1.BN(maxOffsetPct));\n    // Only apply when inventory is consistent with recent and 24h market premium\n    let offsetPct = markPremiumAvgPct.add(inventoryPct);\n    if (!(0, utils_1.sigNum)(inventoryPct).eq((0, utils_1.sigNum)(markPremiumAvgPct))) {\n        offsetPct = numericConstants_1.ZERO;\n    }\n    const clampedOffsetPct = (0, utils_1.clampBN)(offsetPct, new anchor_1.BN(-maxOffsetPct), new anchor_1.BN(maxOffsetPct));\n    return clampedOffsetPct;\n}\nexports.calculateReferencePriceOffset = calculateReferencePriceOffset;\nfunction calculateEffectiveLeverage(baseSpread, quoteAssetReserve, terminalQuoteAssetReserve, pegMultiplier, netBaseAssetAmount, reservePrice, totalFeeMinusDistributions) {\n    // vAMM skew\n    const netBaseAssetValue = quoteAssetReserve\n        .sub(terminalQuoteAssetReserve)\n        .mul(pegMultiplier)\n        .div(numericConstants_1.AMM_TIMES_PEG_TO_QUOTE_PRECISION_RATIO);\n    const localBaseAssetValue = netBaseAssetAmount\n        .mul(reservePrice)\n        .div(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO.mul(numericConstants_1.PRICE_PRECISION));\n    const effectiveGap = Math.max(0, localBaseAssetValue.sub(netBaseAssetValue).toNumber());\n    const effectiveLeverage = effectiveGap / (Math.max(0, totalFeeMinusDistributions.toNumber()) + 1) +\n        1 / numericConstants_1.QUOTE_PRECISION.toNumber();\n    return effectiveLeverage;\n}\nexports.calculateEffectiveLeverage = calculateEffectiveLeverage;\nfunction calculateMaxSpread(marginRatioInitial) {\n    const maxTargetSpread = new anchor_1.BN(marginRatioInitial)\n        .mul(numericConstants_1.BID_ASK_SPREAD_PRECISION.div(numericConstants_1.MARGIN_PRECISION))\n        .toNumber();\n    return maxTargetSpread;\n}\nexports.calculateMaxSpread = calculateMaxSpread;\nfunction calculateVolSpreadBN(lastOracleConfPct, reservePrice, markStd, oracleStd, longIntensity, shortIntensity, volume24H) {\n    const marketAvgStdPct = markStd\n        .add(oracleStd)\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(reservePrice)\n        .div(new anchor_1.BN(4));\n    const volSpread = anchor_1.BN.max(lastOracleConfPct, marketAvgStdPct.div(new anchor_1.BN(2)));\n    const clampMin = numericConstants_1.PERCENTAGE_PRECISION.div(new anchor_1.BN(100));\n    const clampMax = numericConstants_1.PERCENTAGE_PRECISION;\n    const longVolSpreadFactor = (0, utils_1.clampBN)(longIntensity.mul(numericConstants_1.PERCENTAGE_PRECISION).div(anchor_1.BN.max(numericConstants_1.ONE, volume24H)), clampMin, clampMax);\n    const shortVolSpreadFactor = (0, utils_1.clampBN)(shortIntensity.mul(numericConstants_1.PERCENTAGE_PRECISION).div(anchor_1.BN.max(numericConstants_1.ONE, volume24H)), clampMin, clampMax);\n    // only consider confidence interval at full value when above 25 bps\n    let confComponent = lastOracleConfPct;\n    if (lastOracleConfPct.lte(numericConstants_1.PRICE_PRECISION.div(new anchor_1.BN(400)))) {\n        confComponent = lastOracleConfPct.div(new anchor_1.BN(20));\n    }\n    const longVolSpread = anchor_1.BN.max(confComponent, volSpread.mul(longVolSpreadFactor).div(numericConstants_1.PERCENTAGE_PRECISION));\n    const shortVolSpread = anchor_1.BN.max(confComponent, volSpread.mul(shortVolSpreadFactor).div(numericConstants_1.PERCENTAGE_PRECISION));\n    return [longVolSpread, shortVolSpread];\n}\nexports.calculateVolSpreadBN = calculateVolSpreadBN;\nfunction calculateSpreadBN(baseSpread, lastOracleReservePriceSpreadPct, lastOracleConfPct, maxSpread, quoteAssetReserve, terminalQuoteAssetReserve, pegMultiplier, baseAssetAmountWithAmm, reservePrice, totalFeeMinusDistributions, netRevenueSinceLastFunding, baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve, markStd, oracleStd, longIntensity, shortIntensity, volume24H, ammInventorySpreadAdjustment, returnTerms = false) {\n    (0, assert_1.assert)(Number.isInteger(baseSpread));\n    (0, assert_1.assert)(Number.isInteger(maxSpread));\n    const spreadTerms = {\n        longVolSpread: 0,\n        shortVolSpread: 0,\n        longSpreadwPS: 0,\n        shortSpreadwPS: 0,\n        maxTargetSpread: 0,\n        inventorySpreadScale: 0,\n        longSpreadwInvScale: 0,\n        shortSpreadwInvScale: 0,\n        effectiveLeverage: 0,\n        effectiveLeverageCapped: 0,\n        longSpreadwEL: 0,\n        shortSpreadwEL: 0,\n        revenueRetreatAmount: 0,\n        halfRevenueRetreatAmount: 0,\n        longSpreadwRevRetreat: 0,\n        shortSpreadwRevRetreat: 0,\n        longSpreadwOffsetShrink: 0,\n        shortSpreadwOffsetShrink: 0,\n        totalSpread: 0,\n        longSpread: 0,\n        shortSpread: 0,\n    };\n    const [longVolSpread, shortVolSpread] = calculateVolSpreadBN(lastOracleConfPct, reservePrice, markStd, oracleStd, longIntensity, shortIntensity, volume24H);\n    spreadTerms.longVolSpread = longVolSpread.toNumber();\n    spreadTerms.shortVolSpread = shortVolSpread.toNumber();\n    let longSpread = Math.max(baseSpread / 2, longVolSpread.toNumber());\n    let shortSpread = Math.max(baseSpread / 2, shortVolSpread.toNumber());\n    if (lastOracleReservePriceSpreadPct.gt(numericConstants_1.ZERO)) {\n        shortSpread = Math.max(shortSpread, lastOracleReservePriceSpreadPct.abs().toNumber() +\n            shortVolSpread.toNumber());\n    }\n    else if (lastOracleReservePriceSpreadPct.lt(numericConstants_1.ZERO)) {\n        longSpread = Math.max(longSpread, lastOracleReservePriceSpreadPct.abs().toNumber() +\n            longVolSpread.toNumber());\n    }\n    spreadTerms.longSpreadwPS = longSpread;\n    spreadTerms.shortSpreadwPS = shortSpread;\n    const maxSpreadBaseline = Math.min(Math.max(lastOracleReservePriceSpreadPct.abs().toNumber(), lastOracleConfPct.muln(2).toNumber(), anchor_1.BN.max(markStd, oracleStd)\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(reservePrice)\n        .toNumber()), numericConstants_1.BID_ASK_SPREAD_PRECISION.toNumber());\n    const maxTargetSpread = Math.floor(Math.max(maxSpread, maxSpreadBaseline));\n    const inventorySpreadScale = calculateInventoryScale(baseAssetAmountWithAmm, baseAssetReserve, minBaseAssetReserve, maxBaseAssetReserve, baseAssetAmountWithAmm.gt(numericConstants_1.ZERO) ? longSpread : shortSpread, maxTargetSpread);\n    if (baseAssetAmountWithAmm.gt(numericConstants_1.ZERO)) {\n        longSpread *= inventorySpreadScale;\n    }\n    else if (baseAssetAmountWithAmm.lt(numericConstants_1.ZERO)) {\n        shortSpread *= inventorySpreadScale;\n    }\n    spreadTerms.maxTargetSpread = maxTargetSpread;\n    spreadTerms.inventorySpreadScale = inventorySpreadScale;\n    spreadTerms.longSpreadwInvScale = longSpread;\n    spreadTerms.shortSpreadwInvScale = shortSpread;\n    const MAX_SPREAD_SCALE = 10;\n    if (totalFeeMinusDistributions.gt(numericConstants_1.ZERO)) {\n        const effectiveLeverage = calculateEffectiveLeverage(baseSpread, quoteAssetReserve, terminalQuoteAssetReserve, pegMultiplier, baseAssetAmountWithAmm, reservePrice, totalFeeMinusDistributions);\n        spreadTerms.effectiveLeverage = effectiveLeverage;\n        const spreadScale = Math.min(MAX_SPREAD_SCALE, 1 + effectiveLeverage);\n        spreadTerms.effectiveLeverageCapped = spreadScale;\n        if (baseAssetAmountWithAmm.gt(numericConstants_1.ZERO)) {\n            longSpread *= spreadScale;\n            longSpread = Math.floor(longSpread);\n        }\n        else {\n            shortSpread *= spreadScale;\n            shortSpread = Math.floor(shortSpread);\n        }\n    }\n    else {\n        longSpread *= MAX_SPREAD_SCALE;\n        shortSpread *= MAX_SPREAD_SCALE;\n    }\n    spreadTerms.longSpreadwEL = longSpread;\n    spreadTerms.shortSpreadwEL = shortSpread;\n    if (netRevenueSinceLastFunding.lt(numericConstants_1.DEFAULT_REVENUE_SINCE_LAST_FUNDING_SPREAD_RETREAT)) {\n        const maxRetreat = maxTargetSpread / 10;\n        let revenueRetreatAmount = maxRetreat;\n        if (netRevenueSinceLastFunding.gte(numericConstants_1.DEFAULT_REVENUE_SINCE_LAST_FUNDING_SPREAD_RETREAT.mul(new anchor_1.BN(1000)))) {\n            revenueRetreatAmount = Math.min(maxRetreat, Math.floor((baseSpread * netRevenueSinceLastFunding.abs().toNumber()) /\n                numericConstants_1.DEFAULT_REVENUE_SINCE_LAST_FUNDING_SPREAD_RETREAT.abs().toNumber()));\n        }\n        const halfRevenueRetreatAmount = Math.floor(revenueRetreatAmount / 2);\n        spreadTerms.revenueRetreatAmount = revenueRetreatAmount;\n        spreadTerms.halfRevenueRetreatAmount = halfRevenueRetreatAmount;\n        if (baseAssetAmountWithAmm.gt(numericConstants_1.ZERO)) {\n            longSpread += revenueRetreatAmount;\n            shortSpread += halfRevenueRetreatAmount;\n        }\n        else if (baseAssetAmountWithAmm.lt(numericConstants_1.ZERO)) {\n            longSpread += halfRevenueRetreatAmount;\n            shortSpread += revenueRetreatAmount;\n        }\n        else {\n            longSpread += halfRevenueRetreatAmount;\n            shortSpread += halfRevenueRetreatAmount;\n        }\n    }\n    spreadTerms.longSpreadwRevRetreat = longSpread;\n    spreadTerms.shortSpreadwRevRetreat = shortSpread;\n    if (ammInventorySpreadAdjustment < 0) {\n        const adjustment = Math.abs(ammInventorySpreadAdjustment);\n        const shrunkLong = Math.max(1, longSpread - Math.floor((longSpread * adjustment) / 100));\n        const shrunkShort = Math.max(1, shortSpread - Math.floor((shortSpread * adjustment) / 100));\n        longSpread = Math.max(longVolSpread.toNumber(), shrunkLong);\n        shortSpread = Math.max(shortVolSpread.toNumber(), shrunkShort);\n    }\n    else if (ammInventorySpreadAdjustment > 0) {\n        const adjustment = ammInventorySpreadAdjustment;\n        const grownLong = Math.max(1, longSpread + Math.ceil((longSpread * adjustment) / 100));\n        const grownShort = Math.max(1, shortSpread + Math.ceil((shortSpread * adjustment) / 100));\n        longSpread = Math.max(longVolSpread.toNumber(), grownLong);\n        shortSpread = Math.max(shortVolSpread.toNumber(), grownShort);\n    }\n    const totalSpread = longSpread + shortSpread;\n    if (totalSpread > maxTargetSpread) {\n        if (longSpread > shortSpread) {\n            longSpread = Math.ceil((longSpread * maxTargetSpread) / totalSpread);\n            shortSpread = Math.floor(maxTargetSpread - longSpread);\n        }\n        else {\n            shortSpread = Math.ceil((shortSpread * maxTargetSpread) / totalSpread);\n            longSpread = Math.floor(maxTargetSpread - shortSpread);\n        }\n    }\n    spreadTerms.totalSpread = totalSpread;\n    spreadTerms.longSpread = longSpread;\n    spreadTerms.shortSpread = shortSpread;\n    if (returnTerms) {\n        return spreadTerms;\n    }\n    return [longSpread, shortSpread];\n}\nexports.calculateSpreadBN = calculateSpreadBN;\nfunction calculateSpread(amm, oraclePriceData, now, reservePrice) {\n    if (amm.baseSpread == 0 || amm.curveUpdateIntensity == 0) {\n        return [amm.baseSpread / 2, amm.baseSpread / 2];\n    }\n    if (!reservePrice) {\n        reservePrice = calculatePrice(amm.baseAssetReserve, amm.quoteAssetReserve, amm.pegMultiplier);\n    }\n    const targetPrice = (oraclePriceData === null || oraclePriceData === void 0 ? void 0 : oraclePriceData.price) || reservePrice;\n    const targetMarkSpreadPct = reservePrice\n        .sub(targetPrice)\n        .mul(numericConstants_1.BID_ASK_SPREAD_PRECISION)\n        .div(reservePrice);\n    now = now || new anchor_1.BN(new Date().getTime() / 1000); //todo\n    const liveOracleStd = (0, oracles_1.calculateLiveOracleStd)(amm, oraclePriceData, now);\n    const confIntervalPct = (0, oracles_1.getNewOracleConfPct)(amm, oraclePriceData, reservePrice, now);\n    const spreads = calculateSpreadBN(amm.baseSpread, targetMarkSpreadPct, confIntervalPct, amm.maxSpread, amm.quoteAssetReserve, amm.terminalQuoteAssetReserve, amm.pegMultiplier, amm.baseAssetAmountWithAmm, reservePrice, amm.totalFeeMinusDistributions, amm.netRevenueSinceLastFunding, amm.baseAssetReserve, amm.minBaseAssetReserve, amm.maxBaseAssetReserve, amm.markStd, liveOracleStd, amm.longIntensityVolume, amm.shortIntensityVolume, amm.volume24H, amm.ammInventorySpreadAdjustment);\n    let longSpread = spreads[0];\n    let shortSpread = spreads[1];\n    if (amm.ammSpreadAdjustment > 0) {\n        longSpread = Math.max(longSpread + (longSpread * amm.ammSpreadAdjustment) / 100, 1);\n        shortSpread = Math.max(shortSpread + (shortSpread * amm.ammSpreadAdjustment) / 100, 1);\n    }\n    else if (amm.ammSpreadAdjustment < 0) {\n        longSpread = Math.max(longSpread - (longSpread * -amm.ammSpreadAdjustment) / 100, 1);\n        shortSpread = Math.max(shortSpread - (shortSpread * -amm.ammSpreadAdjustment) / 100, 1);\n    }\n    return [longSpread, shortSpread];\n}\nexports.calculateSpread = calculateSpread;\nfunction getQuoteAssetReservePredictionMarketBounds(amm, direction) {\n    let quoteAssetReserveLowerBound = numericConstants_1.ZERO;\n    const pegSqrt = (0, utils_1.squareRootBN)(amm.pegMultiplier.mul(numericConstants_1.PEG_PRECISION).addn(1)).addn(1);\n    let quoteAssetReserveUpperBound = amm.sqrtK\n        .mul(pegSqrt)\n        .div(amm.pegMultiplier);\n    if (direction === types_1.PositionDirection.LONG) {\n        quoteAssetReserveLowerBound = amm.sqrtK\n            .muln(22361)\n            .mul(pegSqrt)\n            .divn(100000)\n            .div(amm.pegMultiplier);\n    }\n    else {\n        quoteAssetReserveUpperBound = amm.sqrtK\n            .muln(97467)\n            .mul(pegSqrt)\n            .divn(100000)\n            .div(amm.pegMultiplier);\n    }\n    return [quoteAssetReserveLowerBound, quoteAssetReserveUpperBound];\n}\nexports.getQuoteAssetReservePredictionMarketBounds = getQuoteAssetReservePredictionMarketBounds;\nfunction calculateSpreadReserves(amm, mmOraclePriceData, now, isPrediction = false, latestSlot) {\n    function calculateSpreadReserve(spread, direction, amm) {\n        if (spread === 0) {\n            return {\n                baseAssetReserve: amm.baseAssetReserve,\n                quoteAssetReserve: amm.quoteAssetReserve,\n            };\n        }\n        let spreadFraction = new anchor_1.BN(spread).div(new anchor_1.BN(2));\n        // make non-zero\n        if (spreadFraction.eq(numericConstants_1.ZERO)) {\n            spreadFraction = spread >= 0 ? new anchor_1.BN(1) : new anchor_1.BN(-1);\n        }\n        const quoteAssetReserveDelta = amm.quoteAssetReserve.div(numericConstants_1.BID_ASK_SPREAD_PRECISION.div(spreadFraction));\n        let quoteAssetReserve;\n        if (quoteAssetReserveDelta.gte(numericConstants_1.ZERO)) {\n            quoteAssetReserve = amm.quoteAssetReserve.add(quoteAssetReserveDelta.abs());\n        }\n        else {\n            quoteAssetReserve = amm.quoteAssetReserve.sub(quoteAssetReserveDelta.abs());\n        }\n        if (isPrediction) {\n            const [qarLower, qarUpper] = getQuoteAssetReservePredictionMarketBounds(amm, direction);\n            quoteAssetReserve = (0, utils_1.clampBN)(quoteAssetReserve, qarLower, qarUpper);\n        }\n        const baseAssetReserve = amm.sqrtK.mul(amm.sqrtK).div(quoteAssetReserve);\n        return {\n            baseAssetReserve,\n            quoteAssetReserve,\n        };\n    }\n    const reservePrice = calculatePrice(amm.baseAssetReserve, amm.quoteAssetReserve, amm.pegMultiplier);\n    // always allow 10 bps of price offset, up to a half of the market's max_spread\n    let maxOffset = 0;\n    let referencePriceOffset = 0;\n    if (amm.curveUpdateIntensity > 100) {\n        maxOffset = Math.max(amm.maxSpread / 2, (numericConstants_1.PERCENTAGE_PRECISION.toNumber() / 10000) *\n            (amm.curveUpdateIntensity - 100));\n        const liquidityFraction = calculateInventoryLiquidityRatioForReferencePriceOffset(amm.baseAssetAmountWithAmm, amm.baseAssetReserve, amm.minBaseAssetReserve, amm.maxBaseAssetReserve);\n        const liquidityFractionSigned = liquidityFraction.mul((0, utils_1.sigNum)(amm.baseAssetAmountWithAmm.add(amm.baseAssetAmountWithUnsettledLp)));\n        let liquidityFractionAfterDeadband = liquidityFractionSigned;\n        const deadbandPct = amm.referencePriceOffsetDeadbandPct\n            ? numericConstants_1.PERCENTAGE_PRECISION.mul(new anchor_1.BN(amm.referencePriceOffsetDeadbandPct)).divn(100)\n            : numericConstants_1.ZERO;\n        if (!liquidityFractionAfterDeadband.eq(numericConstants_1.ZERO) && deadbandPct.gt(numericConstants_1.ZERO)) {\n            const abs = liquidityFractionAfterDeadband.abs();\n            if (abs.lte(deadbandPct)) {\n                liquidityFractionAfterDeadband = numericConstants_1.ZERO;\n            }\n            else {\n                liquidityFractionAfterDeadband = liquidityFractionAfterDeadband.sub(deadbandPct.mul((0, utils_1.sigNum)(liquidityFractionAfterDeadband)));\n            }\n        }\n        referencePriceOffset = calculateReferencePriceOffset(reservePrice, amm.last24HAvgFundingRate, liquidityFractionAfterDeadband, amm.historicalOracleData.lastOraclePriceTwap5Min, amm.lastMarkPriceTwap5Min, amm.historicalOracleData.lastOraclePriceTwap, amm.lastMarkPriceTwap, maxOffset).toNumber();\n    }\n    let [longSpread, shortSpread] = calculateSpread(amm, mmOraclePriceData, now, reservePrice);\n    const doReferencePricOffsetSmooth = Math.sign(referencePriceOffset) !== Math.sign(amm.referencePriceOffset) &&\n        amm.curveUpdateIntensity > 100;\n    if (doReferencePricOffsetSmooth) {\n        const slotsPassed = latestSlot != null\n            ? anchor_1.BN.max(latestSlot.sub(amm.lastUpdateSlot), numericConstants_1.ZERO).toNumber()\n            : 0;\n        const fullOffsetDelta = referencePriceOffset - amm.referencePriceOffset;\n        const raw = Math.trunc(Math.min(Math.abs(fullOffsetDelta), slotsPassed * 1000) / 10);\n        const maxAllowed = Math.abs(amm.referencePriceOffset) || Math.abs(referencePriceOffset);\n        const magnitude = Math.min(Math.max(raw, 10), maxAllowed);\n        const referencePriceDelta = Math.sign(fullOffsetDelta) * magnitude;\n        referencePriceOffset = amm.referencePriceOffset + referencePriceDelta;\n        if (referencePriceDelta < 0) {\n            longSpread += Math.abs(referencePriceDelta);\n            shortSpread += Math.abs(referencePriceOffset);\n        }\n        else {\n            shortSpread += Math.abs(referencePriceDelta);\n            longSpread += Math.abs(referencePriceOffset);\n        }\n    }\n    const askReserves = calculateSpreadReserve(longSpread + referencePriceOffset, types_1.PositionDirection.LONG, amm);\n    const bidReserves = calculateSpreadReserve(-shortSpread + referencePriceOffset, types_1.PositionDirection.SHORT, amm);\n    return [bidReserves, askReserves];\n}\nexports.calculateSpreadReserves = calculateSpreadReserves;\n/**\n * Helper function calculating constant product curve output. Agnostic to whether input asset is quote or base\n *\n * @param inputAssetReserve\n * @param swapAmount\n * @param swapDirection\n * @param invariant\n * @returns newInputAssetReserve and newOutputAssetReserve after swap. : Precision AMM_RESERVE_PRECISION\n */\nfunction calculateSwapOutput(inputAssetReserve, swapAmount, swapDirection, invariant) {\n    let newInputAssetReserve;\n    if (swapDirection === types_1.SwapDirection.ADD) {\n        newInputAssetReserve = inputAssetReserve.add(swapAmount);\n    }\n    else {\n        newInputAssetReserve = inputAssetReserve.sub(swapAmount);\n    }\n    const newOutputAssetReserve = invariant.div(newInputAssetReserve);\n    return [newInputAssetReserve, newOutputAssetReserve];\n}\nexports.calculateSwapOutput = calculateSwapOutput;\n/**\n * Translate long/shorting quote/base asset into amm operation\n *\n * @param inputAssetType\n * @param positionDirection\n */\nfunction getSwapDirection(inputAssetType, positionDirection) {\n    if ((0, types_1.isVariant)(positionDirection, 'long') && inputAssetType === 'base') {\n        return types_1.SwapDirection.REMOVE;\n    }\n    if ((0, types_1.isVariant)(positionDirection, 'short') && inputAssetType === 'quote') {\n        return types_1.SwapDirection.REMOVE;\n    }\n    return types_1.SwapDirection.ADD;\n}\nexports.getSwapDirection = getSwapDirection;\n/**\n * Helper function calculating terminal price of amm\n *\n * @param market\n * @returns cost : Precision PRICE_PRECISION\n */\nfunction calculateTerminalPrice(market) {\n    const directionToClose = market.amm.baseAssetAmountWithAmm.gt(numericConstants_1.ZERO)\n        ? types_1.PositionDirection.SHORT\n        : types_1.PositionDirection.LONG;\n    const [newQuoteAssetReserve, newBaseAssetReserve] = calculateAmmReservesAfterSwap(market.amm, 'base', market.amm.baseAssetAmountWithAmm.abs(), getSwapDirection('base', directionToClose));\n    const terminalPrice = newQuoteAssetReserve\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .mul(market.amm.pegMultiplier)\n        .div(numericConstants_1.PEG_PRECISION)\n        .div(newBaseAssetReserve);\n    return terminalPrice;\n}\nexports.calculateTerminalPrice = calculateTerminalPrice;\nfunction calculateMaxBaseAssetAmountToTrade(amm, limit_price, direction, mmOraclePriceData, now, isPrediction = false) {\n    const invariant = amm.sqrtK.mul(amm.sqrtK);\n    const newBaseAssetReserveSquared = invariant\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .mul(amm.pegMultiplier)\n        .div(limit_price)\n        .div(numericConstants_1.PEG_PRECISION);\n    const newBaseAssetReserve = (0, utils_1.squareRootBN)(newBaseAssetReserveSquared);\n    const [shortSpreadReserves, longSpreadReserves] = calculateSpreadReserves(amm, mmOraclePriceData, now, isPrediction);\n    const baseAssetReserveBefore = (0, types_1.isVariant)(direction, 'long')\n        ? longSpreadReserves.baseAssetReserve\n        : shortSpreadReserves.baseAssetReserve;\n    if (newBaseAssetReserve.gt(baseAssetReserveBefore)) {\n        return [\n            newBaseAssetReserve.sub(baseAssetReserveBefore),\n            types_1.PositionDirection.SHORT,\n        ];\n    }\n    else if (newBaseAssetReserve.lt(baseAssetReserveBefore)) {\n        return [\n            baseAssetReserveBefore.sub(newBaseAssetReserve),\n            types_1.PositionDirection.LONG,\n        ];\n    }\n    else {\n        console.log('tradeSize Too Small');\n        return [new anchor_1.BN(0), types_1.PositionDirection.LONG];\n    }\n}\nexports.calculateMaxBaseAssetAmountToTrade = calculateMaxBaseAssetAmountToTrade;\nfunction calculateQuoteAssetAmountSwapped(quoteAssetReserves, pegMultiplier, swapDirection) {\n    if ((0, types_1.isVariant)(swapDirection, 'remove')) {\n        quoteAssetReserves = quoteAssetReserves.add(numericConstants_1.ONE);\n    }\n    let quoteAssetAmount = quoteAssetReserves\n        .mul(pegMultiplier)\n        .div(numericConstants_1.AMM_TIMES_PEG_TO_QUOTE_PRECISION_RATIO);\n    if ((0, types_1.isVariant)(swapDirection, 'remove')) {\n        quoteAssetAmount = quoteAssetAmount.add(numericConstants_1.ONE);\n    }\n    return quoteAssetAmount;\n}\nexports.calculateQuoteAssetAmountSwapped = calculateQuoteAssetAmountSwapped;\nfunction calculateMaxBaseAssetAmountFillable(amm, orderDirection) {\n    const maxFillSize = amm.baseAssetReserve.div(new anchor_1.BN(amm.maxFillReserveFraction));\n    let maxBaseAssetAmountOnSide;\n    if ((0, types_1.isVariant)(orderDirection, 'long')) {\n        maxBaseAssetAmountOnSide = anchor_1.BN.max(numericConstants_1.ZERO, amm.baseAssetReserve.sub(amm.minBaseAssetReserve));\n    }\n    else {\n        maxBaseAssetAmountOnSide = anchor_1.BN.max(numericConstants_1.ZERO, amm.maxBaseAssetReserve.sub(amm.baseAssetReserve));\n    }\n    return (0, orders_1.standardizeBaseAssetAmount)(anchor_1.BN.min(maxFillSize, maxBaseAssetAmountOnSide), amm.orderStepSize);\n}\nexports.calculateMaxBaseAssetAmountFillable = calculateMaxBaseAssetAmountFillable;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 3262, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/position.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.hasOpenOrders = exports.isEmptyPosition = exports.positionCurrentDirection = exports.findDirectionToClose = exports.calculateCostBasis = exports.calculateEntryPrice = exports.calculateBreakEvenPrice = exports.positionIsAvailable = exports.calculatePositionFundingPNL = exports.calculateUnsettledFundingPnl = exports.calculateFeesAndFundingPnl = exports.calculateClaimablePnl = exports.calculatePositionPNL = exports.calculateBaseAssetValue = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst types_1 = require(\"../types\");\nconst amm_1 = require(\"./amm\");\nconst margin_1 = require(\"./margin\");\nconst market_1 = require(\"./market\");\n/**\n * calculateBaseAssetValue\n * = market value of closing entire position\n * @param market\n * @param userPosition\n * @param oraclePriceData\n * @returns Base Asset Value. : Precision QUOTE_PRECISION\n */\nfunction calculateBaseAssetValue(market, userPosition, mmOraclePriceData, useSpread = true, skipUpdate = false, latestSlot) {\n    if (userPosition.baseAssetAmount.eq(numericConstants_1.ZERO)) {\n        return numericConstants_1.ZERO;\n    }\n    const directionToClose = findDirectionToClose(userPosition);\n    let prepegAmm;\n    if (!skipUpdate) {\n        if (market.amm.baseSpread > 0 && useSpread) {\n            const { baseAssetReserve, quoteAssetReserve, sqrtK, newPeg } = (0, amm_1.calculateUpdatedAMMSpreadReserves)(market.amm, directionToClose, mmOraclePriceData, undefined, latestSlot);\n            prepegAmm = {\n                baseAssetReserve,\n                quoteAssetReserve,\n                sqrtK: sqrtK,\n                pegMultiplier: newPeg,\n            };\n        }\n        else {\n            prepegAmm = (0, amm_1.calculateUpdatedAMM)(market.amm, mmOraclePriceData);\n        }\n    }\n    else {\n        prepegAmm = market.amm;\n    }\n    const [newQuoteAssetReserve, _] = (0, amm_1.calculateAmmReservesAfterSwap)(prepegAmm, 'base', userPosition.baseAssetAmount.abs(), (0, amm_1.getSwapDirection)('base', directionToClose));\n    switch (directionToClose) {\n        case types_1.PositionDirection.SHORT:\n            return prepegAmm.quoteAssetReserve\n                .sub(newQuoteAssetReserve)\n                .mul(prepegAmm.pegMultiplier)\n                .div(numericConstants_1.AMM_TIMES_PEG_TO_QUOTE_PRECISION_RATIO);\n        case types_1.PositionDirection.LONG:\n            return newQuoteAssetReserve\n                .sub(prepegAmm.quoteAssetReserve)\n                .mul(prepegAmm.pegMultiplier)\n                .div(numericConstants_1.AMM_TIMES_PEG_TO_QUOTE_PRECISION_RATIO)\n                .add(numericConstants_1.ONE);\n    }\n}\nexports.calculateBaseAssetValue = calculateBaseAssetValue;\n/**\n * calculatePositionPNL\n * = BaseAssetAmount * (Avg Exit Price - Avg Entry Price)\n * @param market\n * @param PerpPosition\n * @param withFunding (adds unrealized funding payment pnl to result)\n * @param oraclePriceData\n * @returns BaseAssetAmount : Precision QUOTE_PRECISION\n */\nfunction calculatePositionPNL(market, perpPosition, withFunding = false, oraclePriceData) {\n    if (perpPosition.baseAssetAmount.eq(numericConstants_1.ZERO)) {\n        return perpPosition.quoteAssetAmount;\n    }\n    const baseAssetValue = (0, margin_1.calculateBaseAssetValueWithOracle)(market, perpPosition, oraclePriceData);\n    const baseAssetValueSign = perpPosition.baseAssetAmount.isNeg()\n        ? new anchor_1.BN(-1)\n        : new anchor_1.BN(1);\n    let pnl = baseAssetValue\n        .mul(baseAssetValueSign)\n        .add(perpPosition.quoteAssetAmount);\n    if (withFunding) {\n        const fundingRatePnL = calculateUnsettledFundingPnl(market, perpPosition);\n        pnl = pnl.add(fundingRatePnL);\n    }\n    return pnl;\n}\nexports.calculatePositionPNL = calculatePositionPNL;\nfunction calculateClaimablePnl(market, spotMarket, perpPosition, oraclePriceData) {\n    const unrealizedPnl = calculatePositionPNL(market, perpPosition, true, oraclePriceData);\n    let unsettledPnl = unrealizedPnl;\n    if (unrealizedPnl.gt(numericConstants_1.ZERO)) {\n        const excessPnlPool = anchor_1.BN.max(numericConstants_1.ZERO, (0, market_1.calculateNetUserPnlImbalance)(market, spotMarket, oraclePriceData).mul(new anchor_1.BN(-1)));\n        const maxPositivePnl = anchor_1.BN.max(perpPosition.quoteAssetAmount.sub(perpPosition.quoteEntryAmount), numericConstants_1.ZERO).add(excessPnlPool);\n        unsettledPnl = anchor_1.BN.min(maxPositivePnl, unrealizedPnl);\n    }\n    return unsettledPnl;\n}\nexports.calculateClaimablePnl = calculateClaimablePnl;\n/**\n * Returns total fees and funding pnl for a position\n *\n * @param market\n * @param PerpPosition\n * @param includeUnsettled include unsettled funding in return value (default: true)\n * @returns  // QUOTE_PRECISION\n */\nfunction calculateFeesAndFundingPnl(market, perpPosition, includeUnsettled = true) {\n    const settledFundingAndFeesPnl = perpPosition.quoteBreakEvenAmount.sub(perpPosition.quoteEntryAmount);\n    if (!includeUnsettled) {\n        return settledFundingAndFeesPnl;\n    }\n    const unsettledFundingPnl = calculateUnsettledFundingPnl(market, perpPosition);\n    return settledFundingAndFeesPnl.add(unsettledFundingPnl);\n}\nexports.calculateFeesAndFundingPnl = calculateFeesAndFundingPnl;\n/**\n * Returns unsettled funding pnl for the position\n *\n * To calculate all fees and funding pnl including settled, use calculateFeesAndFundingPnl\n *\n * @param market\n * @param PerpPosition\n * @returns // QUOTE_PRECISION\n */\nfunction calculateUnsettledFundingPnl(market, perpPosition) {\n    if (perpPosition.baseAssetAmount.eq(numericConstants_1.ZERO)) {\n        return numericConstants_1.ZERO;\n    }\n    let ammCumulativeFundingRate;\n    if (perpPosition.baseAssetAmount.gt(numericConstants_1.ZERO)) {\n        ammCumulativeFundingRate = market.amm.cumulativeFundingRateLong;\n    }\n    else {\n        ammCumulativeFundingRate = market.amm.cumulativeFundingRateShort;\n    }\n    const perPositionFundingRate = ammCumulativeFundingRate\n        .sub(perpPosition.lastCumulativeFundingRate)\n        .mul(perpPosition.baseAssetAmount)\n        .div(numericConstants_1.AMM_RESERVE_PRECISION)\n        .div(numericConstants_1.FUNDING_RATE_BUFFER_PRECISION)\n        .mul(new anchor_1.BN(-1));\n    return perPositionFundingRate;\n}\nexports.calculateUnsettledFundingPnl = calculateUnsettledFundingPnl;\n/**\n * @deprecated use calculateUnsettledFundingPnl or calculateFeesAndFundingPnl instead\n */\nfunction calculatePositionFundingPNL(market, perpPosition) {\n    return calculateUnsettledFundingPnl(market, perpPosition);\n}\nexports.calculatePositionFundingPNL = calculatePositionFundingPNL;\nfunction positionIsAvailable(position) {\n    return (position.baseAssetAmount.eq(numericConstants_1.ZERO) &&\n        position.openOrders === 0 &&\n        position.quoteAssetAmount.eq(numericConstants_1.ZERO) &&\n        position.lpShares.eq(numericConstants_1.ZERO));\n}\nexports.positionIsAvailable = positionIsAvailable;\n/**\n *\n * @param userPosition\n * @returns Precision: PRICE_PRECISION (10^6)\n */\nfunction calculateBreakEvenPrice(userPosition) {\n    if (userPosition.baseAssetAmount.eq(numericConstants_1.ZERO)) {\n        return numericConstants_1.ZERO;\n    }\n    return userPosition.quoteBreakEvenAmount\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .mul(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO)\n        .div(userPosition.baseAssetAmount)\n        .abs();\n}\nexports.calculateBreakEvenPrice = calculateBreakEvenPrice;\n/**\n *\n * @param userPosition\n * @returns Precision: PRICE_PRECISION (10^6)\n */\nfunction calculateEntryPrice(userPosition) {\n    if (userPosition.baseAssetAmount.eq(numericConstants_1.ZERO)) {\n        return numericConstants_1.ZERO;\n    }\n    return userPosition.quoteEntryAmount\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .mul(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO)\n        .div(userPosition.baseAssetAmount)\n        .abs();\n}\nexports.calculateEntryPrice = calculateEntryPrice;\n/**\n *\n * @param userPosition\n * @returns Precision: PRICE_PRECISION (10^10)\n */\nfunction calculateCostBasis(userPosition, includeSettledPnl = false) {\n    if (userPosition.baseAssetAmount.eq(numericConstants_1.ZERO)) {\n        return numericConstants_1.ZERO;\n    }\n    return userPosition.quoteAssetAmount\n        .add(includeSettledPnl ? userPosition.settledPnl : numericConstants_1.ZERO)\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .mul(numericConstants_1.AMM_TO_QUOTE_PRECISION_RATIO)\n        .div(userPosition.baseAssetAmount)\n        .abs();\n}\nexports.calculateCostBasis = calculateCostBasis;\nfunction findDirectionToClose(userPosition) {\n    return userPosition.baseAssetAmount.gt(numericConstants_1.ZERO)\n        ? types_1.PositionDirection.SHORT\n        : types_1.PositionDirection.LONG;\n}\nexports.findDirectionToClose = findDirectionToClose;\nfunction positionCurrentDirection(userPosition) {\n    return userPosition.baseAssetAmount.gte(numericConstants_1.ZERO)\n        ? types_1.PositionDirection.LONG\n        : types_1.PositionDirection.SHORT;\n}\nexports.positionCurrentDirection = positionCurrentDirection;\nfunction isEmptyPosition(userPosition) {\n    return userPosition.baseAssetAmount.eq(numericConstants_1.ZERO) && userPosition.openOrders === 0;\n}\nexports.isEmptyPosition = isEmptyPosition;\nfunction hasOpenOrders(position) {\n    return (position.openOrders != 0 ||\n        !position.openBids.eq(numericConstants_1.ZERO) ||\n        !position.openAsks.eq(numericConstants_1.ZERO));\n}\nexports.hasOpenOrders = hasOpenOrders;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 3443, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/builder.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.isBuilderOrderAvailable = exports.isBuilderOrderReferral = exports.isBuilderOrderCompleted = exports.isBuilderOrderOpen = void 0;\nconst FLAG_IS_OPEN = 0x01;\nfunction isBuilderOrderOpen(order) {\n    return (order.bitFlags & FLAG_IS_OPEN) !== 0;\n}\nexports.isBuilderOrderOpen = isBuilderOrderOpen;\nconst FLAG_IS_COMPLETED = 0x02;\nfunction isBuilderOrderCompleted(order) {\n    return (order.bitFlags & FLAG_IS_COMPLETED) !== 0;\n}\nexports.isBuilderOrderCompleted = isBuilderOrderCompleted;\nconst FLAG_IS_REFERRAL = 0x04;\nfunction isBuilderOrderReferral(order) {\n    return (order.bitFlags & FLAG_IS_REFERRAL) !== 0;\n}\nexports.isBuilderOrderReferral = isBuilderOrderReferral;\nfunction isBuilderOrderAvailable(order) {\n    return !isBuilderOrderOpen(order) && !isBuilderOrderCompleted(order);\n}\nexports.isBuilderOrderAvailable = isBuilderOrderAvailable;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,uBAAuB,GAAG,QAAQ,sBAAsB,GAAG,QAAQ,uBAAuB,GAAG,QAAQ,kBAAkB,GAAG,KAAK;AACvI,MAAM,eAAe;AACrB,SAAS,mBAAmB,KAAK;IAC7B,OAAO,CAAC,MAAM,QAAQ,GAAG,YAAY,MAAM;AAC/C;AACA,QAAQ,kBAAkB,GAAG;AAC7B,MAAM,oBAAoB;AAC1B,SAAS,wBAAwB,KAAK;IAClC,OAAO,CAAC,MAAM,QAAQ,GAAG,iBAAiB,MAAM;AACpD;AACA,QAAQ,uBAAuB,GAAG;AAClC,MAAM,mBAAmB;AACzB,SAAS,uBAAuB,KAAK;IACjC,OAAO,CAAC,MAAM,QAAQ,GAAG,gBAAgB,MAAM;AACnD;AACA,QAAQ,sBAAsB,GAAG;AACjC,SAAS,wBAAwB,KAAK;IAClC,OAAO,CAAC,mBAAmB,UAAU,CAAC,wBAAwB;AAClE;AACA,QAAQ,uBAAuB,GAAG","ignoreList":[0]}},
    {"offset": {"line": 3470, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/conversion.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.convertToBN = exports.convertToNumber = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst convertToNumber = (bigNumber, precision = numericConstants_1.PRICE_PRECISION) => {\n    if (!bigNumber)\n        return 0;\n    return (bigNumber.div(precision).toNumber() +\n        bigNumber.mod(precision).toNumber() / precision.toNumber());\n};\nexports.convertToNumber = convertToNumber;\nfunction convertToBN(value, precision) {\n    // Get the whole part using Math.floor\n    const wholePart = Math.floor(value);\n    // Get decimal part by subtracting whole part and multiplying by precision\n    const decimalPart = Math.round((value - wholePart) * precision.toNumber());\n    // Combine: wholePart * PRECISION + decimalPart\n    return new anchor_1.BN(wholePart).mul(precision).add(new anchor_1.BN(decimalPart));\n}\nexports.convertToBN = convertToBN;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,WAAW,GAAG,QAAQ,eAAe,GAAG,KAAK;AACrD,MAAM;AACN,MAAM;AACN,MAAM,kBAAkB,CAAC,WAAW,YAAY,mBAAmB,eAAe;IAC9E,IAAI,CAAC,WACD,OAAO;IACX,OAAQ,UAAU,GAAG,CAAC,WAAW,QAAQ,KACrC,UAAU,GAAG,CAAC,WAAW,QAAQ,KAAK,UAAU,QAAQ;AAChE;AACA,QAAQ,eAAe,GAAG;AAC1B,SAAS,YAAY,KAAK,EAAE,SAAS;IACjC,sCAAsC;IACtC,MAAM,YAAY,KAAK,KAAK,CAAC;IAC7B,0EAA0E;IAC1E,MAAM,cAAc,KAAK,KAAK,CAAC,CAAC,QAAQ,SAAS,IAAI,UAAU,QAAQ;IACvE,+CAA+C;IAC/C,OAAO,IAAI,SAAS,EAAE,CAAC,WAAW,GAAG,CAAC,WAAW,GAAG,CAAC,IAAI,SAAS,EAAE,CAAC;AACzE;AACA,QAAQ,WAAW,GAAG","ignoreList":[0]}},
    {"offset": {"line": 3494, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/funding.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.calculateFundingPool = exports.calculateLongShortFundingRateAndLiveTwaps = exports.calculateLongShortFundingRate = exports.calculateFormattedLiveFundingRate = exports.calculateAllEstimatedFundingRate = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst bigNum_1 = require(\"../factory/bigNum\");\nconst types_1 = require(\"../types\");\nconst amm_1 = require(\"./amm\");\nconst oracles_1 = require(\"./oracles\");\nconst utils_1 = require(\"./utils\");\nconst numericConstants_2 = require(\"../constants/numericConstants\");\nfunction calculateLiveMarkTwap(market, mmOraclePriceData, markPrice, now, period = new anchor_1.BN(3600)) {\n    now = now || new anchor_1.BN((Date.now() / 1000).toFixed(0));\n    const lastMarkTwapWithMantissa = market.amm.lastMarkPriceTwap;\n    const lastMarkPriceTwapTs = market.amm.lastMarkPriceTwapTs;\n    const timeSinceLastMarkChange = now.sub(lastMarkPriceTwapTs);\n    const markTwapTimeSinceLastUpdate = anchor_1.BN.max(period, anchor_1.BN.max(numericConstants_1.ZERO, period.sub(timeSinceLastMarkChange)));\n    if (!markPrice) {\n        const [bid, ask] = (0, amm_1.calculateBidAskPrice)(market.amm, mmOraclePriceData);\n        markPrice = bid.add(ask).div(new anchor_1.BN(2));\n    }\n    const markTwapWithMantissa = markTwapTimeSinceLastUpdate\n        .mul(lastMarkTwapWithMantissa)\n        .add(timeSinceLastMarkChange.mul(markPrice))\n        .div(timeSinceLastMarkChange.add(markTwapTimeSinceLastUpdate));\n    return markTwapWithMantissa;\n}\nfunction shrinkStaleTwaps(market, markTwapWithMantissa, oracleTwapWithMantissa, now) {\n    now = now || new anchor_1.BN((Date.now() / 1000).toFixed(0));\n    let newMarkTwap = markTwapWithMantissa;\n    let newOracleTwap = oracleTwapWithMantissa;\n    if (market.amm.lastMarkPriceTwapTs.gt(market.amm.historicalOracleData.lastOraclePriceTwapTs)) {\n        // shrink oracle based on invalid intervals\n        const oracleInvalidDuration = anchor_1.BN.max(numericConstants_1.ZERO, market.amm.lastMarkPriceTwapTs.sub(market.amm.historicalOracleData.lastOraclePriceTwapTs));\n        const timeSinceLastOracleTwapUpdate = now.sub(market.amm.historicalOracleData.lastOraclePriceTwapTs);\n        const oracleTwapTimeSinceLastUpdate = anchor_1.BN.max(numericConstants_1.ONE, anchor_1.BN.min(market.amm.fundingPeriod, anchor_1.BN.max(numericConstants_1.ONE, market.amm.fundingPeriod.sub(timeSinceLastOracleTwapUpdate))));\n        newOracleTwap = oracleTwapTimeSinceLastUpdate\n            .mul(oracleTwapWithMantissa)\n            .add(oracleInvalidDuration.mul(markTwapWithMantissa))\n            .div(oracleTwapTimeSinceLastUpdate.add(oracleInvalidDuration));\n    }\n    else if (market.amm.lastMarkPriceTwapTs.lt(market.amm.historicalOracleData.lastOraclePriceTwapTs)) {\n        // shrink mark to oracle twap over tradless intervals\n        const tradelessDuration = anchor_1.BN.max(numericConstants_1.ZERO, market.amm.historicalOracleData.lastOraclePriceTwapTs.sub(market.amm.lastMarkPriceTwapTs));\n        const timeSinceLastMarkTwapUpdate = now.sub(market.amm.lastMarkPriceTwapTs);\n        const markTwapTimeSinceLastUpdate = anchor_1.BN.max(numericConstants_1.ONE, anchor_1.BN.min(market.amm.fundingPeriod, anchor_1.BN.max(numericConstants_1.ONE, market.amm.fundingPeriod.sub(timeSinceLastMarkTwapUpdate))));\n        newMarkTwap = markTwapTimeSinceLastUpdate\n            .mul(markTwapWithMantissa)\n            .add(tradelessDuration.mul(oracleTwapWithMantissa))\n            .div(markTwapTimeSinceLastUpdate.add(tradelessDuration));\n    }\n    return [newMarkTwap, newOracleTwap];\n}\n/**\n *\n * @param market\n * @param oraclePriceData\n * @param periodAdjustment\n * @returns Estimated funding rate. : Precision //TODO-PRECISION\n */\nfunction calculateAllEstimatedFundingRate(market, mmOraclePriceData, oraclePriceData, markPrice, now) {\n    if ((0, types_1.isVariant)(market.status, 'uninitialized')) {\n        return [numericConstants_1.ZERO, numericConstants_1.ZERO, numericConstants_1.ZERO, numericConstants_1.ZERO, numericConstants_1.ZERO];\n    }\n    // todo: sufficiently differs from blockchain timestamp?\n    now = now || new anchor_1.BN((Date.now() / 1000).toFixed(0));\n    // calculate real-time mark and oracle twap\n    const liveMarkTwap = calculateLiveMarkTwap(market, mmOraclePriceData, markPrice, now, market.amm.fundingPeriod);\n    const liveOracleTwap = (0, oracles_1.calculateLiveOracleTwap)(market.amm.historicalOracleData, oraclePriceData, now, market.amm.fundingPeriod);\n    const [markTwap, oracleTwap] = shrinkStaleTwaps(market, liveMarkTwap, liveOracleTwap, now);\n    // if(!markTwap.eq(liveMarkTwap)){\n    // \tconsole.log('shrink mark:', liveMarkTwap.toString(), '->', markTwap.toString());\n    // }\n    // if(!oracleTwap.eq(liveOracleTwap)){\n    // \tconsole.log('shrink orac:', liveOracleTwap.toString(), '->', oracleTwap.toString());\n    // }\n    const twapSpread = markTwap.sub(oracleTwap);\n    const twapSpreadWithOffset = twapSpread.add(oracleTwap.abs().div(numericConstants_1.FUNDING_RATE_OFFSET_DENOMINATOR));\n    const maxSpread = getMaxPriceDivergenceForFundingRate(market, oracleTwap);\n    const clampedSpreadWithOffset = (0, utils_1.clampBN)(twapSpreadWithOffset, maxSpread.mul(new anchor_1.BN(-1)), maxSpread);\n    const twapSpreadPct = clampedSpreadWithOffset\n        .mul(numericConstants_1.PRICE_PRECISION)\n        .mul(new anchor_1.BN(100))\n        .div(oracleTwap);\n    const secondsInHour = new anchor_1.BN(3600);\n    const hoursInDay = new anchor_1.BN(24);\n    const timeSinceLastUpdate = now.sub(market.amm.lastFundingRateTs);\n    const lowerboundEst = twapSpreadPct\n        .mul(market.amm.fundingPeriod)\n        .mul(anchor_1.BN.min(secondsInHour, timeSinceLastUpdate))\n        .div(secondsInHour)\n        .div(secondsInHour)\n        .div(hoursInDay);\n    const interpEst = twapSpreadPct.div(hoursInDay);\n    const interpRateQuote = twapSpreadPct\n        .div(hoursInDay)\n        .div(numericConstants_1.PRICE_PRECISION.div(numericConstants_1.QUOTE_PRECISION));\n    let feePoolSize = calculateFundingPool(market);\n    if (interpRateQuote.lt(new anchor_1.BN(0))) {\n        feePoolSize = feePoolSize.mul(new anchor_1.BN(-1));\n    }\n    let cappedAltEst;\n    let largerSide;\n    let smallerSide;\n    if (market.amm.baseAssetAmountLong.gt(market.amm.baseAssetAmountShort.abs())) {\n        largerSide = market.amm.baseAssetAmountLong.abs();\n        smallerSide = market.amm.baseAssetAmountShort.abs();\n        if (twapSpread.gt(new anchor_1.BN(0))) {\n            return [markTwap, oracleTwap, lowerboundEst, interpEst, interpEst];\n        }\n    }\n    else if (market.amm.baseAssetAmountLong.lt(market.amm.baseAssetAmountShort.abs())) {\n        largerSide = market.amm.baseAssetAmountShort.abs();\n        smallerSide = market.amm.baseAssetAmountLong.abs();\n        if (twapSpread.lt(new anchor_1.BN(0))) {\n            return [markTwap, oracleTwap, lowerboundEst, interpEst, interpEst];\n        }\n    }\n    else {\n        return [markTwap, oracleTwap, lowerboundEst, interpEst, interpEst];\n    }\n    if (largerSide.gt(numericConstants_1.ZERO)) {\n        // funding smaller flow\n        cappedAltEst = smallerSide.mul(twapSpread).div(hoursInDay);\n        const feePoolTopOff = feePoolSize\n            .mul(numericConstants_1.PRICE_PRECISION.div(numericConstants_1.QUOTE_PRECISION))\n            .mul(numericConstants_1.AMM_RESERVE_PRECISION);\n        cappedAltEst = cappedAltEst.add(feePoolTopOff).div(largerSide);\n        cappedAltEst = cappedAltEst\n            .mul(numericConstants_1.PRICE_PRECISION)\n            .mul(new anchor_1.BN(100))\n            .div(oracleTwap);\n        if (cappedAltEst.abs().gte(interpEst.abs())) {\n            cappedAltEst = interpEst;\n        }\n    }\n    else {\n        cappedAltEst = interpEst;\n    }\n    return [markTwap, oracleTwap, lowerboundEst, cappedAltEst, interpEst];\n}\nexports.calculateAllEstimatedFundingRate = calculateAllEstimatedFundingRate;\n/**\n * To get funding rate as a percentage, you need to multiply by the funding rate buffer precision\n * @param rawFundingRate\n * @returns\n */\nconst getFundingRatePct = (rawFundingRate) => {\n    return bigNum_1.BigNum.from(rawFundingRate.mul(numericConstants_2.FUNDING_RATE_BUFFER_PRECISION), numericConstants_2.FUNDING_RATE_PRECISION_EXP).toNum();\n};\n/**\n * Calculate funding rates in human-readable form. Values will have some lost precision and shouldn't be used in strict accounting.\n * @param period : 'hour' | 'year' :: Use 'hour' for the hourly payment as a percentage, 'year' for the payment as an estimated APR.\n */\nfunction calculateFormattedLiveFundingRate(market, mmOraclePriceData, oraclePriceData, period) {\n    const nowBN = new anchor_1.BN(Date.now() / 1000);\n    const [_markTwapLive, _oracleTwapLive, longFundingRate, shortFundingRate] = calculateLongShortFundingRateAndLiveTwaps(market, mmOraclePriceData, oraclePriceData, undefined, nowBN);\n    let longFundingRateNum = getFundingRatePct(longFundingRate);\n    let shortFundingRateNum = getFundingRatePct(shortFundingRate);\n    if (period == 'year') {\n        const paymentsPerYear = 24 * 365.25;\n        longFundingRateNum *= paymentsPerYear;\n        shortFundingRateNum *= paymentsPerYear;\n    }\n    const longsArePaying = longFundingRateNum > 0;\n    const shortsArePaying = !(shortFundingRateNum > 0);\n    const longsAreString = longsArePaying ? 'pay' : 'receive';\n    const shortsAreString = !shortsArePaying ? 'receive' : 'pay';\n    const absoluteLongFundingRateNum = Math.abs(longFundingRateNum);\n    const absoluteShortFundingRateNum = Math.abs(shortFundingRateNum);\n    const formattedLongRatePct = absoluteLongFundingRateNum.toFixed(period == 'hour' ? 5 : 2);\n    const formattedShortRatePct = absoluteShortFundingRateNum.toFixed(period == 'hour' ? 5 : 2);\n    const fundingRateUnit = period == 'year' ? '% APR' : '%';\n    const formattedFundingRateSummary = `At this rate, longs would ${longsAreString} ${formattedLongRatePct} ${fundingRateUnit} and shorts would ${shortsAreString} ${formattedShortRatePct} ${fundingRateUnit} at the end of the hour.`;\n    return {\n        longRate: longsArePaying\n            ? -absoluteLongFundingRateNum\n            : absoluteLongFundingRateNum,\n        shortRate: shortsArePaying\n            ? -absoluteShortFundingRateNum\n            : absoluteShortFundingRateNum,\n        fundingRateUnit: fundingRateUnit,\n        formattedFundingRateSummary,\n    };\n}\nexports.calculateFormattedLiveFundingRate = calculateFormattedLiveFundingRate;\nfunction getMaxPriceDivergenceForFundingRate(market, oracleTwap) {\n    if ((0, types_1.isVariant)(market.contractTier, 'a')) {\n        return oracleTwap.divn(33);\n    }\n    else if ((0, types_1.isVariant)(market.contractTier, 'b')) {\n        return oracleTwap.divn(33);\n    }\n    else if ((0, types_1.isVariant)(market.contractTier, 'c')) {\n        return oracleTwap.divn(20);\n    }\n    else {\n        return oracleTwap.divn(10);\n    }\n}\n/**\n *\n * @param market\n * @param oraclePriceData\n * @param periodAdjustment\n * @returns Estimated funding rate. : Precision //TODO-PRECISION\n */\nfunction calculateLongShortFundingRate(market, mmOraclePriceData, oraclePriceData, markPrice, now) {\n    const [_1, _2, _, cappedAltEst, interpEst] = calculateAllEstimatedFundingRate(market, mmOraclePriceData, oraclePriceData, markPrice, now);\n    if (market.amm.baseAssetAmountLong.gt(market.amm.baseAssetAmountShort)) {\n        return [cappedAltEst, interpEst];\n    }\n    else if (market.amm.baseAssetAmountLong.lt(market.amm.baseAssetAmountShort)) {\n        return [interpEst, cappedAltEst];\n    }\n    else {\n        return [interpEst, interpEst];\n    }\n}\nexports.calculateLongShortFundingRate = calculateLongShortFundingRate;\n/**\n *\n * @param market\n * @param oraclePriceData\n * @param periodAdjustment\n * @returns Estimated funding rate. : Precision //TODO-PRECISION\n */\nfunction calculateLongShortFundingRateAndLiveTwaps(market, mmOraclePriceData, oraclePriceData, markPrice, now) {\n    const [markTwapLive, oracleTwapLive, _2, cappedAltEst, interpEst] = calculateAllEstimatedFundingRate(market, mmOraclePriceData, oraclePriceData, markPrice, now);\n    if (market.amm.baseAssetAmountLong.gt(market.amm.baseAssetAmountShort.abs())) {\n        return [markTwapLive, oracleTwapLive, cappedAltEst, interpEst];\n    }\n    else if (market.amm.baseAssetAmountLong.lt(market.amm.baseAssetAmountShort.abs())) {\n        return [markTwapLive, oracleTwapLive, interpEst, cappedAltEst];\n    }\n    else {\n        return [markTwapLive, oracleTwapLive, interpEst, interpEst];\n    }\n}\nexports.calculateLongShortFundingRateAndLiveTwaps = calculateLongShortFundingRateAndLiveTwaps;\n/**\n *\n * @param market\n * @returns Estimated fee pool size\n */\nfunction calculateFundingPool(market) {\n    // todo\n    const totalFeeLB = market.amm.totalExchangeFee.div(new anchor_1.BN(2));\n    const feePool = anchor_1.BN.max(numericConstants_1.ZERO, market.amm.totalFeeMinusDistributions\n        .sub(totalFeeLB)\n        .mul(new anchor_1.BN(1))\n        .div(new anchor_1.BN(3)));\n    return feePool;\n}\nexports.calculateFundingPool = calculateFundingPool;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 3763, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/liquidation.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getMarginShortage = exports.calculateMaxPctToLiquidate = exports.calculateAssetTransferForLiabilityTransfer = exports.calculateLiabilityTransferToCoverMarginShortage = exports.calculateBaseAssetAmountToCoverMarginShortage = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nfunction calculateBaseAssetAmountToCoverMarginShortage(marginShortage, marginRatio, liquidationFee, ifLiquidationFee, oraclePrice, quoteOraclePrice) {\n    const marginRatioBN = new anchor_1.BN(marginRatio)\n        .mul(numericConstants_1.LIQUIDATION_FEE_PRECISION)\n        .div(numericConstants_1.MARGIN_PRECISION);\n    const liquidationFeeBN = new anchor_1.BN(liquidationFee);\n    if (oraclePrice.eq(new anchor_1.BN(0)) || marginRatioBN.lte(liquidationFeeBN)) {\n        // undefined is max\n        return undefined;\n    }\n    return marginShortage.mul(numericConstants_1.PRICE_TIMES_AMM_TO_QUOTE_PRECISION_RATIO).div(oraclePrice\n        .mul(quoteOraclePrice)\n        .div(numericConstants_1.PRICE_PRECISION)\n        .mul(marginRatioBN.sub(liquidationFeeBN))\n        .div(numericConstants_1.LIQUIDATION_FEE_PRECISION)\n        .sub(oraclePrice.mul(new anchor_1.BN(ifLiquidationFee)).div(numericConstants_1.LIQUIDATION_FEE_PRECISION)));\n}\nexports.calculateBaseAssetAmountToCoverMarginShortage = calculateBaseAssetAmountToCoverMarginShortage;\nfunction calculateLiabilityTransferToCoverMarginShortage(marginShortage, assetWeight, assetLiquidationMultiplier, liabilityWeight, liabilityLiquidationMultiplier, liabilityDecimals, liabilityPrice, ifLiquidationFee) {\n    if (assetWeight >= liabilityWeight) {\n        // undefined is max\n        return undefined;\n    }\n    let numeratorScale;\n    let denominatorScale;\n    if (liabilityDecimals > 6) {\n        numeratorScale = new anchor_1.BN(10).pow(new anchor_1.BN(liabilityDecimals - 6));\n        denominatorScale = new anchor_1.BN(1);\n    }\n    else {\n        numeratorScale = new anchor_1.BN(1);\n        denominatorScale = new anchor_1.BN(10).pow(new anchor_1.BN(6 - liabilityDecimals));\n    }\n    // multiply market weights by extra 10 to increase precision\n    const liabilityWeightComponent = liabilityWeight * 10;\n    const assetWeightComponent = (assetWeight * 10 * assetLiquidationMultiplier) /\n        liabilityLiquidationMultiplier;\n    if (assetWeightComponent >= liabilityWeightComponent) {\n        return undefined;\n    }\n    return anchor_1.BN.max(marginShortage\n        .mul(numeratorScale)\n        .mul(numericConstants_1.PRICE_PRECISION.mul(numericConstants_1.SPOT_MARKET_WEIGHT_PRECISION).mul(numericConstants_1.TEN))\n        .div(liabilityPrice\n        .mul(new anchor_1.BN(liabilityWeightComponent).sub(new anchor_1.BN(assetWeightComponent)))\n        .sub(liabilityPrice\n        .mul(new anchor_1.BN(ifLiquidationFee))\n        .div(numericConstants_1.LIQUIDATION_FEE_PRECISION)\n        .mul(new anchor_1.BN(liabilityWeight))\n        .mul(new anchor_1.BN(10))))\n        .div(denominatorScale), numericConstants_1.ONE);\n}\nexports.calculateLiabilityTransferToCoverMarginShortage = calculateLiabilityTransferToCoverMarginShortage;\nfunction calculateAssetTransferForLiabilityTransfer(assetAmount, assetLiquidationMultiplier, assetDecimals, assetPrice, liabilityAmount, liabilityLiquidationMultiplier, liabilityDecimals, liabilityPrice) {\n    let numeratorScale;\n    let denominatorScale;\n    if (assetDecimals > liabilityDecimals) {\n        numeratorScale = new anchor_1.BN(10).pow(new anchor_1.BN(assetDecimals - liabilityDecimals));\n        denominatorScale = new anchor_1.BN(1);\n    }\n    else {\n        numeratorScale = new anchor_1.BN(1);\n        denominatorScale = new anchor_1.BN(10).pow(new anchor_1.BN(liabilityDecimals - assetDecimals));\n    }\n    let assetTransfer = liabilityAmount\n        .mul(numeratorScale)\n        .mul(liabilityPrice)\n        .mul(new anchor_1.BN(assetLiquidationMultiplier))\n        .div(assetPrice.mul(new anchor_1.BN(liabilityLiquidationMultiplier)))\n        .div(denominatorScale);\n    assetTransfer = anchor_1.BN.max(assetTransfer, numericConstants_1.ONE);\n    // Need to check if asset_transfer should be rounded to asset amount\n    let assetValueNumeratorScale;\n    let assetValueDenominatorScale;\n    if (assetDecimals > 6) {\n        assetValueNumeratorScale = new anchor_1.BN(10).pow(new anchor_1.BN(assetDecimals - 6));\n        assetValueDenominatorScale = new anchor_1.BN(1);\n    }\n    else {\n        assetValueNumeratorScale = new anchor_1.BN(1);\n        assetValueDenominatorScale = new anchor_1.BN(10).pow(new anchor_1.BN(6 - assetDecimals));\n    }\n    let assetDelta;\n    if (assetTransfer > assetAmount) {\n        assetDelta = assetTransfer.sub(assetAmount);\n    }\n    else {\n        assetDelta = assetAmount.sub(assetTransfer);\n    }\n    const assetValueDelta = assetDelta\n        .mul(assetPrice)\n        .div(numericConstants_1.PRICE_PRECISION)\n        .mul(assetValueNumeratorScale)\n        .div(assetValueDenominatorScale);\n    if (assetValueDelta.lt(numericConstants_1.QUOTE_PRECISION)) {\n        assetTransfer = assetAmount;\n    }\n    return assetTransfer;\n}\nexports.calculateAssetTransferForLiabilityTransfer = calculateAssetTransferForLiabilityTransfer;\nfunction calculateMaxPctToLiquidate(userLastActiveSlot, userLiquidationMarginFreed, marginShortage, slot, initialPctToLiquidate, liquidationDuration) {\n    // if margin shortage is tiny, accelerate liquidation\n    if (marginShortage.lt(new anchor_1.BN(50).mul(numericConstants_1.QUOTE_PRECISION))) {\n        return numericConstants_1.LIQUIDATION_PCT_PRECISION;\n    }\n    let slotsElapsed;\n    if (userLiquidationMarginFreed.gt(new anchor_1.BN(0))) {\n        slotsElapsed = anchor_1.BN.max(slot.sub(userLastActiveSlot), new anchor_1.BN(0));\n    }\n    else {\n        slotsElapsed = new anchor_1.BN(0);\n    }\n    const pctFreeable = anchor_1.BN.min(slotsElapsed\n        .mul(numericConstants_1.LIQUIDATION_PCT_PRECISION)\n        .div(liquidationDuration) // ~ 1 minute if per slot is 400ms\n        .add(initialPctToLiquidate), numericConstants_1.LIQUIDATION_PCT_PRECISION);\n    const totalMarginShortage = marginShortage.add(userLiquidationMarginFreed);\n    const maxMarginFreed = totalMarginShortage\n        .mul(pctFreeable)\n        .div(numericConstants_1.LIQUIDATION_PCT_PRECISION);\n    const marginFreeable = anchor_1.BN.max(maxMarginFreed.sub(userLiquidationMarginFreed), new anchor_1.BN(0));\n    return marginFreeable.mul(numericConstants_1.LIQUIDATION_PCT_PRECISION).div(marginShortage);\n}\nexports.calculateMaxPctToLiquidate = calculateMaxPctToLiquidate;\nfunction getMarginShortage(maintenanceMarginRequirementPlusBuffer, maintenanceTotalCollateral) {\n    return maintenanceMarginRequirementPlusBuffer\n        .sub(maintenanceTotalCollateral)\n        .abs();\n}\nexports.getMarginShortage = getMarginShortage;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 3864, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/insurance.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.unstakeSharesToAmountWithOpenRequest = exports.unstakeSharesToAmount = exports.stakeAmountToShares = exports.nextRevenuePoolSettleApr = void 0;\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst spotBalance_1 = require(\"../math/spotBalance\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst types_1 = require(\"../types\");\nfunction nextRevenuePoolSettleApr(spotMarket, vaultBalance, // vault token amount\namount // delta token amount\n) {\n    const MAX_APR = new anchor_1.BN(10).mul(numericConstants_1.PERCENTAGE_PRECISION); // 1000% APR\n    // Conmputing the APR:\n    const revenuePoolBN = (0, spotBalance_1.getTokenAmount)(spotMarket.revenuePool.scaledBalance, spotMarket, types_1.SpotBalanceType.DEPOSIT);\n    const payoutRatio = 0.1;\n    const ratioForStakers = spotMarket.insuranceFund.totalFactor > 0 &&\n        spotMarket.insuranceFund.userFactor > 0 &&\n        spotMarket.insuranceFund.revenueSettlePeriod.gt(numericConstants_1.ZERO)\n        ? spotMarket.insuranceFund.userFactor /\n            spotMarket.insuranceFund.totalFactor\n        : 0;\n    // Settle periods from on-chain data:\n    const revSettlePeriod = spotMarket.insuranceFund.revenueSettlePeriod.toNumber() * 1000;\n    const settlesPerYear = 31536000000 / revSettlePeriod;\n    const projectedAnnualRev = revenuePoolBN\n        .muln(settlesPerYear)\n        .muln(payoutRatio);\n    const uncappedApr = vaultBalance.add(amount).eq(numericConstants_1.ZERO)\n        ? 0\n        : projectedAnnualRev.muln(1000).div(vaultBalance.add(amount)).toNumber() *\n            100 *\n            1000;\n    const cappedApr = Math.min(uncappedApr, MAX_APR.toNumber());\n    const nextApr = cappedApr * ratioForStakers;\n    return nextApr;\n}\nexports.nextRevenuePoolSettleApr = nextRevenuePoolSettleApr;\nfunction stakeAmountToShares(amount, totalIfShares, insuranceFundVaultBalance) {\n    let nShares;\n    if (insuranceFundVaultBalance.gt(numericConstants_1.ZERO)) {\n        nShares = amount.mul(totalIfShares).div(insuranceFundVaultBalance);\n    }\n    else {\n        nShares = amount;\n    }\n    return nShares;\n}\nexports.stakeAmountToShares = stakeAmountToShares;\nfunction unstakeSharesToAmount(nShares, totalIfShares, insuranceFundVaultBalance) {\n    let amount;\n    if (totalIfShares.gt(numericConstants_1.ZERO)) {\n        amount = anchor_1.BN.max(numericConstants_1.ZERO, nShares.mul(insuranceFundVaultBalance).div(totalIfShares));\n    }\n    else {\n        amount = numericConstants_1.ZERO;\n    }\n    return amount;\n}\nexports.unstakeSharesToAmount = unstakeSharesToAmount;\nfunction unstakeSharesToAmountWithOpenRequest(nShares, withdrawRequestShares, withdrawRequestAmount, totalIfShares, insuranceFundVaultBalance) {\n    let stakedAmount;\n    if (totalIfShares.gt(numericConstants_1.ZERO)) {\n        stakedAmount = anchor_1.BN.max(numericConstants_1.ZERO, nShares\n            .sub(withdrawRequestShares)\n            .mul(insuranceFundVaultBalance)\n            .div(totalIfShares));\n    }\n    else {\n        stakedAmount = numericConstants_1.ZERO;\n    }\n    const withdrawAmount = anchor_1.BN.min(withdrawRequestAmount, withdrawRequestShares.mul(insuranceFundVaultBalance).div(totalIfShares));\n    const amount = withdrawAmount.add(stakedAmount);\n    return amount;\n}\nexports.unstakeSharesToAmountWithOpenRequest = unstakeSharesToAmountWithOpenRequest;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,oCAAoC,GAAG,QAAQ,qBAAqB,GAAG,QAAQ,mBAAmB,GAAG,QAAQ,wBAAwB,GAAG,KAAK;AACrJ,MAAM;AACN,MAAM;AACN,MAAM;AACN,MAAM;AACN,SAAS,yBAAyB,UAAU,EAAE,YAAY,EAC1D,OAAO,qBAAqB;AAAtB;IAEF,MAAM,UAAU,IAAI,SAAS,EAAE,CAAC,IAAI,GAAG,CAAC,mBAAmB,oBAAoB,GAAG,YAAY;IAC9F,sBAAsB;IACtB,MAAM,gBAAgB,CAAC,GAAG,cAAc,cAAc,EAAE,WAAW,WAAW,CAAC,aAAa,EAAE,YAAY,QAAQ,eAAe,CAAC,OAAO;IACzI,MAAM,cAAc;IACpB,MAAM,kBAAkB,WAAW,aAAa,CAAC,WAAW,GAAG,KAC3D,WAAW,aAAa,CAAC,UAAU,GAAG,KACtC,WAAW,aAAa,CAAC,mBAAmB,CAAC,EAAE,CAAC,mBAAmB,IAAI,IACrE,WAAW,aAAa,CAAC,UAAU,GACjC,WAAW,aAAa,CAAC,WAAW,GACtC;IACN,qCAAqC;IACrC,MAAM,kBAAkB,WAAW,aAAa,CAAC,mBAAmB,CAAC,QAAQ,KAAK;IAClF,MAAM,iBAAiB,cAAc;IACrC,MAAM,qBAAqB,cACtB,IAAI,CAAC,gBACL,IAAI,CAAC;IACV,MAAM,cAAc,aAAa,GAAG,CAAC,QAAQ,EAAE,CAAC,mBAAmB,IAAI,IACjE,IACA,mBAAmB,IAAI,CAAC,MAAM,GAAG,CAAC,aAAa,GAAG,CAAC,SAAS,QAAQ,KAClE,MACA;IACR,MAAM,YAAY,KAAK,GAAG,CAAC,aAAa,QAAQ,QAAQ;IACxD,MAAM,UAAU,YAAY;IAC5B,OAAO;AACX;AACA,QAAQ,wBAAwB,GAAG;AACnC,SAAS,oBAAoB,MAAM,EAAE,aAAa,EAAE,yBAAyB;IACzE,IAAI;IACJ,IAAI,0BAA0B,EAAE,CAAC,mBAAmB,IAAI,GAAG;QACvD,UAAU,OAAO,GAAG,CAAC,eAAe,GAAG,CAAC;IAC5C,OACK;QACD,UAAU;IACd;IACA,OAAO;AACX;AACA,QAAQ,mBAAmB,GAAG;AAC9B,SAAS,sBAAsB,OAAO,EAAE,aAAa,EAAE,yBAAyB;IAC5E,IAAI;IACJ,IAAI,cAAc,EAAE,CAAC,mBAAmB,IAAI,GAAG;QAC3C,SAAS,SAAS,EAAE,CAAC,GAAG,CAAC,mBAAmB,IAAI,EAAE,QAAQ,GAAG,CAAC,2BAA2B,GAAG,CAAC;IACjG,OACK;QACD,SAAS,mBAAmB,IAAI;IACpC;IACA,OAAO;AACX;AACA,QAAQ,qBAAqB,GAAG;AAChC,SAAS,qCAAqC,OAAO,EAAE,qBAAqB,EAAE,qBAAqB,EAAE,aAAa,EAAE,yBAAyB;IACzI,IAAI;IACJ,IAAI,cAAc,EAAE,CAAC,mBAAmB,IAAI,GAAG;QAC3C,eAAe,SAAS,EAAE,CAAC,GAAG,CAAC,mBAAmB,IAAI,EAAE,QACnD,GAAG,CAAC,uBACJ,GAAG,CAAC,2BACJ,GAAG,CAAC;IACb,OACK;QACD,eAAe,mBAAmB,IAAI;IAC1C;IACA,MAAM,iBAAiB,SAAS,EAAE,CAAC,GAAG,CAAC,uBAAuB,sBAAsB,GAAG,CAAC,2BAA2B,GAAG,CAAC;IACvH,MAAM,SAAS,eAAe,GAAG,CAAC;IAClC,OAAO;AACX;AACA,QAAQ,oCAAoC,GAAG","ignoreList":[0]}},
    {"offset": {"line": 3925, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/superStake.js"],"sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.calculateEstimatedSuperStakeLiquidationPrice = exports.calculateSolEarned = exports.fetchMSolMetrics = exports.fetchJitoSolMetrics = exports.findBestLstSuperStakeIxs = exports.findBestJitoSolSuperStakeIxs = exports.findBestMSolSuperStakeIxs = exports.findBestSuperStakeIxs = exports.fetchBSolDriftEmissions = exports.fetchBSolMetrics = void 0;\nconst web3_js_1 = require(\"@solana/web3.js\");\nconst marinade_1 = require(\"../marinade\");\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst types_1 = require(\"../types\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst node_fetch_1 = __importDefault(require(\"node-fetch\"));\nconst utils_1 = require(\"./utils\");\nasync function fetchBSolMetrics() {\n    return await (0, node_fetch_1.default)('https://stake.solblaze.org/api/v1/stats');\n}\nexports.fetchBSolMetrics = fetchBSolMetrics;\nasync function fetchBSolDriftEmissions() {\n    return await (0, node_fetch_1.default)('https://stake.solblaze.org/api/v1/drift_emissions');\n}\nexports.fetchBSolDriftEmissions = fetchBSolDriftEmissions;\nasync function findBestSuperStakeIxs({ marketIndex, amount, jupiterClient, driftClient, userAccountPublicKey, price, forceMarinade, onlyDirectRoutes, jupiterQuote, }) {\n    if (marketIndex === 2) {\n        return findBestMSolSuperStakeIxs({\n            amount,\n            jupiterClient,\n            driftClient,\n            userAccountPublicKey,\n            price,\n            forceMarinade,\n            onlyDirectRoutes,\n            jupiterQuote,\n        });\n    }\n    else if (marketIndex === 6) {\n        return findBestJitoSolSuperStakeIxs({\n            amount,\n            jupiterClient,\n            driftClient,\n            userAccountPublicKey,\n            onlyDirectRoutes,\n            jupiterQuote,\n        });\n    }\n    else if (marketIndex === 8) {\n        return findBestLstSuperStakeIxs({\n            amount,\n            lstMint: driftClient.getSpotMarketAccount(8).mint,\n            lstMarketIndex: 8,\n            jupiterClient,\n            driftClient,\n            userAccountPublicKey,\n            onlyDirectRoutes,\n            jupiterQuote,\n        });\n    }\n    else {\n        throw new Error(`Unsupported superstake market index: ${marketIndex}`);\n    }\n}\nexports.findBestSuperStakeIxs = findBestSuperStakeIxs;\nasync function findBestMSolSuperStakeIxs({ amount, jupiterClient, driftClient, userAccountPublicKey, price, forceMarinade, onlyDirectRoutes, jupiterQuote, }) {\n    if (!price) {\n        const marinadeProgram = (0, marinade_1.getMarinadeFinanceProgram)(driftClient.provider);\n        price = await (0, marinade_1.getMarinadeMSolPrice)(marinadeProgram);\n    }\n    const solSpotMarketAccount = driftClient.getSpotMarketAccount(1);\n    const mSolSpotMarketAccount = driftClient.getSpotMarketAccount(2);\n    let jupiterPrice;\n    let quote = jupiterQuote;\n    if (!jupiterQuote) {\n        try {\n            const fetchedQuote = await jupiterClient.getQuote({\n                inputMint: solSpotMarketAccount.mint,\n                outputMint: mSolSpotMarketAccount.mint,\n                amount,\n                slippageBps: 1000,\n                onlyDirectRoutes,\n            });\n            jupiterPrice = +quote.outAmount / +quote.inAmount;\n            quote = fetchedQuote;\n        }\n        catch (e) {\n            console.error('Error getting jupiter price', e);\n        }\n    }\n    if (!jupiterPrice || price <= jupiterPrice || forceMarinade) {\n        const ixs = await driftClient.getStakeForMSOLIx({\n            amount,\n            userAccountPublicKey,\n        });\n        return {\n            method: 'marinade',\n            ixs,\n            lookupTables: [],\n            price: price,\n        };\n    }\n    else {\n        const { ixs, lookupTables } = await driftClient.getJupiterSwapIxV6({\n            inMarketIndex: 1,\n            outMarketIndex: 2,\n            jupiterClient,\n            amount,\n            userAccountPublicKey,\n            onlyDirectRoutes,\n            quote,\n        });\n        return {\n            method: 'jupiter',\n            ixs,\n            lookupTables,\n            price: jupiterPrice,\n        };\n    }\n}\nexports.findBestMSolSuperStakeIxs = findBestMSolSuperStakeIxs;\nasync function findBestJitoSolSuperStakeIxs({ amount, jupiterClient, driftClient, userAccountPublicKey, onlyDirectRoutes, jupiterQuote, }) {\n    return await findBestLstSuperStakeIxs({\n        amount,\n        jupiterClient,\n        driftClient,\n        userAccountPublicKey,\n        onlyDirectRoutes,\n        lstMint: driftClient.getSpotMarketAccount(6).mint,\n        lstMarketIndex: 6,\n        jupiterQuote,\n    });\n}\nexports.findBestJitoSolSuperStakeIxs = findBestJitoSolSuperStakeIxs;\n/**\n * Finds best swap instructions for a generic lstMint\n *\n * Without doing any extra steps like checking if you can get a better rate by staking directly with that LST platform\n */\nasync function findBestLstSuperStakeIxs({ amount, jupiterClient, driftClient, userAccountPublicKey, onlyDirectRoutes, lstMarketIndex, jupiterQuote, }) {\n    const { ixs, lookupTables } = await driftClient.getJupiterSwapIxV6({\n        inMarketIndex: 1,\n        outMarketIndex: lstMarketIndex,\n        jupiterClient,\n        amount,\n        userAccountPublicKey,\n        onlyDirectRoutes,\n        quote: jupiterQuote,\n    });\n    return {\n        method: 'jupiter',\n        ixs,\n        lookupTables,\n        // price: jupiterPrice,\n    };\n}\nexports.findBestLstSuperStakeIxs = findBestLstSuperStakeIxs;\n/**\n * Removes hours, minutes, seconds from a date, and returns the ISO string value (with milliseconds trimmed from the output (required by Jito API))\n * @param inDate\n * @returns\n */\nconst getNormalizedDateString = (inDate) => {\n    const date = new Date(inDate.getTime());\n    date.setUTCHours(0, 0, 0, 0);\n    return date.toISOString().slice(0, 19) + 'Z';\n};\nconst get30DAgo = () => {\n    const date = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    return date;\n};\nasync function fetchJitoSolMetrics() {\n    const res = await (0, node_fetch_1.default)('https://kobe.mainnet.jito.network/api/v1/stake_pool_stats', {\n        headers: {\n            'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n            bucket_type: 'Daily',\n            range_filter: {\n                start: getNormalizedDateString(get30DAgo()),\n                end: getNormalizedDateString(new Date()),\n            },\n            sort_by: {\n                order: 'Asc',\n                field: 'BlockTime',\n            },\n        }),\n        method: 'POST',\n    });\n    const data = await res.json();\n    return data;\n}\nexports.fetchJitoSolMetrics = fetchJitoSolMetrics;\nconst fetchMSolMetrics = async () => {\n    const res = await (0, node_fetch_1.default)('https://api2.marinade.finance/metrics_json');\n    const data = await res.json();\n    return data;\n};\nexports.fetchMSolMetrics = fetchMSolMetrics;\nconst getJitoSolHistoricalPriceMap = async (timestamps) => {\n    try {\n        const data = await fetchJitoSolMetrics();\n        const jitoSolHistoricalPriceMap = new Map();\n        const jitoSolHistoricalPriceInSol = [];\n        for (let i = 0; i < data.supply.length; i++) {\n            const priceInSol = data.tvl[i].data / 10 ** 9 / data.supply[i].data;\n            jitoSolHistoricalPriceInSol.push({\n                price: priceInSol,\n                ts: data.tvl[i].date,\n            });\n        }\n        for (const timestamp of timestamps) {\n            const date = new Date(timestamp * 1000);\n            const dateString = date.toISOString();\n            const price = jitoSolHistoricalPriceInSol.find((p) => (0, utils_1.checkSameDate)(p.ts, dateString));\n            if (price) {\n                jitoSolHistoricalPriceMap.set(timestamp, price.price);\n            }\n        }\n        return jitoSolHistoricalPriceMap;\n    }\n    catch (err) {\n        console.error(err);\n        return undefined;\n    }\n};\nasync function calculateSolEarned({ marketIndex, user, depositRecords, }) {\n    const now = Date.now() / 1000;\n    const timestamps = [\n        now,\n        ...depositRecords\n            .filter((r) => r.marketIndex === marketIndex)\n            .map((r) => r.ts.toNumber()),\n    ];\n    let lstRatios = new Map();\n    const getMsolPrice = async (timestamp) => {\n        const date = new Date(timestamp * 1000); // Convert Unix timestamp to milliseconds\n        const swaggerApiDateTime = date.toISOString(); // Format date as swagger API date-time\n        const url = `https://api.marinade.finance/msol/price_sol?time=${swaggerApiDateTime}`;\n        const response = await (0, node_fetch_1.default)(url);\n        if (response.status === 200) {\n            const data = await response.json();\n            lstRatios.set(timestamp, data);\n        }\n    };\n    const getBSolPrice = async (timestamps) => {\n        var _a, _b;\n        // Currently there's only one bSOL price, no timestamped data\n        // So just use the same price for every timestamp for now\n        const response = await fetchBSolMetrics();\n        if (response.status === 200) {\n            const data = (await response.json());\n            const bSolRatio = (_b = (_a = data === null || data === void 0 ? void 0 : data.stats) === null || _a === void 0 ? void 0 : _a.conversion) === null || _b === void 0 ? void 0 : _b.bsol_to_sol;\n            if (bSolRatio) {\n                timestamps.forEach((timestamp) => lstRatios.set(timestamp, bSolRatio));\n            }\n        }\n    };\n    // This block kind of assumes the record are all from the same market\n    // Otherwise the following code that checks the record.marketIndex would break\n    if (marketIndex === 2) {\n        await Promise.all(timestamps.map(getMsolPrice));\n    }\n    else if (marketIndex === 6) {\n        lstRatios = await getJitoSolHistoricalPriceMap(timestamps);\n    }\n    else if (marketIndex === 8) {\n        await getBSolPrice(timestamps);\n    }\n    let solEarned = numericConstants_1.ZERO;\n    for (const record of depositRecords) {\n        if (record.marketIndex === 1) {\n            if ((0, types_1.isVariant)(record.direction, 'deposit')) {\n                solEarned = solEarned.sub(record.amount);\n            }\n            else {\n                solEarned = solEarned.add(record.amount);\n            }\n        }\n        else if (record.marketIndex === 2 ||\n            record.marketIndex === 6 ||\n            record.marketIndex === 8) {\n            const lstRatio = lstRatios.get(record.ts.toNumber());\n            const lstRatioBN = new anchor_1.BN(lstRatio * web3_js_1.LAMPORTS_PER_SOL);\n            const solAmount = record.amount.mul(lstRatioBN).div(numericConstants_1.LAMPORTS_PRECISION);\n            if ((0, types_1.isVariant)(record.direction, 'deposit')) {\n                solEarned = solEarned.sub(solAmount);\n            }\n            else {\n                solEarned = solEarned.add(solAmount);\n            }\n        }\n    }\n    const currentLstTokenAmount = await user.getTokenAmount(marketIndex);\n    const currentLstRatio = lstRatios.get(now);\n    const currentLstRatioBN = new anchor_1.BN(currentLstRatio * web3_js_1.LAMPORTS_PER_SOL);\n    solEarned = solEarned.add(currentLstTokenAmount.mul(currentLstRatioBN).div(numericConstants_1.LAMPORTS_PRECISION));\n    const currentSOLTokenAmount = await user.getTokenAmount(1);\n    solEarned = solEarned.add(currentSOLTokenAmount);\n    return solEarned;\n}\nexports.calculateSolEarned = calculateSolEarned;\n// calculate estimated liquidation price (in LST/SOL) based on target amounts\nfunction calculateEstimatedSuperStakeLiquidationPrice(lstDepositAmount, lstMaintenanceAssetWeight, solBorrowAmount, solMaintenanceLiabilityWeight, lstPriceRatio) {\n    const liquidationDivergence = (solMaintenanceLiabilityWeight * solBorrowAmount) /\n        (lstMaintenanceAssetWeight * lstDepositAmount * lstPriceRatio);\n    const liquidationPrice = lstPriceRatio * liquidationDivergence;\n    return liquidationPrice;\n}\nexports.calculateEstimatedSuperStakeLiquidationPrice = calculateEstimatedSuperStakeLiquidationPrice;\n"],"names":[],"mappings":"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","ignoreList":[0]}},
    {"offset": {"line": 4219, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/state.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.builderReferralEnabled = exports.builderCodesEnabled = exports.useMedianTriggerPrice = exports.getMaxNumberOfSubAccounts = exports.calculateInitUserFee = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst types_1 = require(\"../types\");\nfunction calculateInitUserFee(stateAccount) {\n    const maxInitFee = new anchor_1.BN(stateAccount.maxInitializeUserFee)\n        .mul(numericConstants_1.LAMPORTS_PRECISION)\n        .divn(100);\n    const targetUtilization = numericConstants_1.PERCENTAGE_PRECISION.muln(8).divn(10);\n    const accountSpaceUtilization = stateAccount.numberOfSubAccounts\n        .addn(1)\n        .mul(numericConstants_1.PERCENTAGE_PRECISION)\n        .div(getMaxNumberOfSubAccounts(stateAccount));\n    if (accountSpaceUtilization.gt(targetUtilization)) {\n        return maxInitFee\n            .mul(accountSpaceUtilization.sub(targetUtilization))\n            .div(numericConstants_1.PERCENTAGE_PRECISION.sub(targetUtilization));\n    }\n    else {\n        return numericConstants_1.ZERO;\n    }\n}\nexports.calculateInitUserFee = calculateInitUserFee;\nfunction getMaxNumberOfSubAccounts(stateAccount) {\n    if (stateAccount.maxNumberOfSubAccounts <= 5) {\n        return new anchor_1.BN(stateAccount.maxNumberOfSubAccounts);\n    }\n    return new anchor_1.BN(stateAccount.maxNumberOfSubAccounts).muln(100);\n}\nexports.getMaxNumberOfSubAccounts = getMaxNumberOfSubAccounts;\nfunction useMedianTriggerPrice(stateAccount) {\n    return ((stateAccount.featureBitFlags & types_1.FeatureBitFlags.MEDIAN_TRIGGER_PRICE) > 0);\n}\nexports.useMedianTriggerPrice = useMedianTriggerPrice;\nfunction builderCodesEnabled(stateAccount) {\n    return (stateAccount.featureBitFlags & types_1.FeatureBitFlags.BUILDER_CODES) > 0;\n}\nexports.builderCodesEnabled = builderCodesEnabled;\nfunction builderReferralEnabled(stateAccount) {\n    return (stateAccount.featureBitFlags & types_1.FeatureBitFlags.BUILDER_REFERRAL) > 0;\n}\nexports.builderReferralEnabled = builderReferralEnabled;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,sBAAsB,GAAG,QAAQ,mBAAmB,GAAG,QAAQ,qBAAqB,GAAG,QAAQ,yBAAyB,GAAG,QAAQ,oBAAoB,GAAG,KAAK;AACvK,MAAM;AACN,MAAM;AACN,MAAM;AACN,SAAS,qBAAqB,YAAY;IACtC,MAAM,aAAa,IAAI,SAAS,EAAE,CAAC,aAAa,oBAAoB,EAC/D,GAAG,CAAC,mBAAmB,kBAAkB,EACzC,IAAI,CAAC;IACV,MAAM,oBAAoB,mBAAmB,oBAAoB,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC;IAC/E,MAAM,0BAA0B,aAAa,mBAAmB,CAC3D,IAAI,CAAC,GACL,GAAG,CAAC,mBAAmB,oBAAoB,EAC3C,GAAG,CAAC,0BAA0B;IACnC,IAAI,wBAAwB,EAAE,CAAC,oBAAoB;QAC/C,OAAO,WACF,GAAG,CAAC,wBAAwB,GAAG,CAAC,oBAChC,GAAG,CAAC,mBAAmB,oBAAoB,CAAC,GAAG,CAAC;IACzD,OACK;QACD,OAAO,mBAAmB,IAAI;IAClC;AACJ;AACA,QAAQ,oBAAoB,GAAG;AAC/B,SAAS,0BAA0B,YAAY;IAC3C,IAAI,aAAa,sBAAsB,IAAI,GAAG;QAC1C,OAAO,IAAI,SAAS,EAAE,CAAC,aAAa,sBAAsB;IAC9D;IACA,OAAO,IAAI,SAAS,EAAE,CAAC,aAAa,sBAAsB,EAAE,IAAI,CAAC;AACrE;AACA,QAAQ,yBAAyB,GAAG;AACpC,SAAS,sBAAsB,YAAY;IACvC,OAAQ,CAAC,aAAa,eAAe,GAAG,QAAQ,eAAe,CAAC,oBAAoB,IAAI;AAC5F;AACA,QAAQ,qBAAqB,GAAG;AAChC,SAAS,oBAAoB,YAAY;IACrC,OAAO,CAAC,aAAa,eAAe,GAAG,QAAQ,eAAe,CAAC,aAAa,IAAI;AACpF;AACA,QAAQ,mBAAmB,GAAG;AAC9B,SAAS,uBAAuB,YAAY;IACxC,OAAO,CAAC,aAAa,eAAe,GAAG,QAAQ,eAAe,CAAC,gBAAgB,IAAI;AACvF;AACA,QAAQ,sBAAsB,GAAG","ignoreList":[0]}},
    {"offset": {"line": 4260, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/userStatus.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.isUserProtectedMaker = void 0;\nconst types_1 = require(\"../types\");\nfunction isUserProtectedMaker(userAccount) {\n    return (userAccount.status & types_1.UserStatus.PROTECTED_MAKER) > 0;\n}\nexports.isUserProtectedMaker = isUserProtectedMaker;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,oBAAoB,GAAG,KAAK;AACpC,MAAM;AACN,SAAS,qBAAqB,WAAW;IACrC,OAAO,CAAC,YAAY,MAAM,GAAG,QAAQ,UAAU,CAAC,eAAe,IAAI;AACvE;AACA,QAAQ,oBAAoB,GAAG","ignoreList":[0]}},
    {"offset": {"line": 4273, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/protectedMakerParams.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.getProtectedMakerParamsMap = exports.getProtectedMakerParams = void 0;\nconst anchor_1 = require(\"@coral-xyz/anchor\");\nfunction getProtectedMakerParams(perpMarket) {\n    let dynamicOffset;\n    if (perpMarket.protectedMakerDynamicDivisor > 0) {\n        dynamicOffset = anchor_1.BN.max(perpMarket.amm.oracleStd, perpMarket.amm.markStd).divn(perpMarket.protectedMakerDynamicDivisor);\n    }\n    else {\n        dynamicOffset = 0;\n    }\n    return {\n        tickSize: perpMarket.amm.orderTickSize,\n        limitPriceDivisor: perpMarket.protectedMakerLimitPriceDivisor,\n        dynamicOffset: dynamicOffset,\n    };\n}\nexports.getProtectedMakerParams = getProtectedMakerParams;\nfunction getProtectedMakerParamsMap(perpMarkets) {\n    const map = {\n        perp: new Map(),\n        spot: new Map(),\n    };\n    for (const perpMarket of perpMarkets) {\n        const marketIndex = perpMarket.marketIndex;\n        const protectedMakerParams = getProtectedMakerParams(perpMarket);\n        map.perp.set(marketIndex, protectedMakerParams);\n    }\n    return map;\n}\nexports.getProtectedMakerParamsMap = getProtectedMakerParamsMap;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,0BAA0B,GAAG,QAAQ,uBAAuB,GAAG,KAAK;AAC5E,MAAM;AACN,SAAS,wBAAwB,UAAU;IACvC,IAAI;IACJ,IAAI,WAAW,4BAA4B,GAAG,GAAG;QAC7C,gBAAgB,SAAS,EAAE,CAAC,GAAG,CAAC,WAAW,GAAG,CAAC,SAAS,EAAE,WAAW,GAAG,CAAC,OAAO,EAAE,IAAI,CAAC,WAAW,4BAA4B;IAClI,OACK;QACD,gBAAgB;IACpB;IACA,OAAO;QACH,UAAU,WAAW,GAAG,CAAC,aAAa;QACtC,mBAAmB,WAAW,+BAA+B;QAC7D,eAAe;IACnB;AACJ;AACA,QAAQ,uBAAuB,GAAG;AAClC,SAAS,2BAA2B,WAAW;IAC3C,MAAM,MAAM;QACR,MAAM,IAAI;QACV,MAAM,IAAI;IACd;IACA,KAAK,MAAM,cAAc,YAAa;QAClC,MAAM,cAAc,WAAW,WAAW;QAC1C,MAAM,uBAAuB,wBAAwB;QACrD,IAAI,IAAI,CAAC,GAAG,CAAC,aAAa;IAC9B;IACA,OAAO;AACX;AACA,QAAQ,0BAA0B,GAAG","ignoreList":[0]}},
    {"offset": {"line": 4309, "column": 0}, "map": {"version":3,"sources":["file:///Users/madhavbansal/Documents/lomen/poc/drift-perps/dashboard/node_modules/.pnpm/%40drift-labs%2Bsdk%402.149.0-beta.0_%40solana%2Bsysvars%402.3.0_fastestsmallesttextencoderdecoder%401.0.22_typescript%405.9.3_ws%408.18.3/node_modules/%40drift-labs/sdk/lib/browser/math/bankruptcy.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.isUserBankrupt = void 0;\nconst numericConstants_1 = require(\"../constants/numericConstants\");\nconst position_1 = require(\"./position\");\nconst types_1 = require(\"../types\");\nfunction isUserBankrupt(user) {\n    const userAccount = user.getUserAccount();\n    let hasLiability = false;\n    for (const position of userAccount.spotPositions) {\n        if (position.scaledBalance.gt(numericConstants_1.ZERO)) {\n            if ((0, types_1.isVariant)(position.balanceType, 'deposit')) {\n                return false;\n            }\n            if ((0, types_1.isVariant)(position.balanceType, 'borrow')) {\n                hasLiability = true;\n            }\n        }\n    }\n    for (const position of userAccount.perpPositions) {\n        if (!position.baseAssetAmount.eq(numericConstants_1.ZERO) ||\n            position.quoteAssetAmount.gt(numericConstants_1.ZERO) ||\n            (0, position_1.hasOpenOrders)(position)) {\n            return false;\n        }\n        if (position.quoteAssetAmount.lt(numericConstants_1.ZERO)) {\n            hasLiability = true;\n        }\n    }\n    return hasLiability;\n}\nexports.isUserBankrupt = isUserBankrupt;\n"],"names":[],"mappings":"AACA,OAAO,cAAc,CAAC,SAAS,cAAc;IAAE,OAAO;AAAK;AAC3D,QAAQ,cAAc,GAAG,KAAK;AAC9B,MAAM;AACN,MAAM;AACN,MAAM;AACN,SAAS,eAAe,IAAI;IACxB,MAAM,cAAc,KAAK,cAAc;IACvC,IAAI,eAAe;IACnB,KAAK,MAAM,YAAY,YAAY,aAAa,CAAE;QAC9C,IAAI,SAAS,aAAa,CAAC,EAAE,CAAC,mBAAmB,IAAI,GAAG;YACpD,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,SAAS,WAAW,EAAE,YAAY;gBACzD,OAAO;YACX;YACA,IAAI,CAAC,GAAG,QAAQ,SAAS,EAAE,SAAS,WAAW,EAAE,WAAW;gBACxD,eAAe;YACnB;QACJ;IACJ;IACA,KAAK,MAAM,YAAY,YAAY,aAAa,CAAE;QAC9C,IAAI,CAAC,SAAS,eAAe,CAAC,EAAE,CAAC,mBAAmB,IAAI,KACpD,SAAS,gBAAgB,CAAC,EAAE,CAAC,mBAAmB,IAAI,KACpD,CAAC,GAAG,WAAW,aAAa,EAAE,WAAW;YACzC,OAAO;QACX;QACA,IAAI,SAAS,gBAAgB,CAAC,EAAE,CAAC,mBAAmB,IAAI,GAAG;YACvD,eAAe;QACnB;IACJ;IACA,OAAO;AACX;AACA,QAAQ,cAAc,GAAG","ignoreList":[0]}}]
}